class w{constructor(){this.tables={usuarios:["id","nombre","email","edad","activo","created_at"],productos:["id","nombre","precio","stock","categoria_id"],pedidos:["id","usuario_id","fecha","total","estado"],categorias:["id","nombre","descripcion"]},this.operators=["=","!=",">","<",">=","<=","LIKE","IN","IS NULL","IS NOT NULL"],this.queryType="SELECT",this.selectedTable="",this.selectedColumns=["*"],this.conditions=[],this.orderBy={column:"",direction:"ASC"},this.limit=null}setQueryType(e){this.queryType=e,this.reset()}setTable(e){this.selectedTable=e,this.selectedColumns=["*"],this.conditions=[]}setColumns(e){this.selectedColumns=e.length?e:["*"]}addCondition(e,s,n,l="AND"){this.conditions.push({column:e,operator:s,value:n,connector:l})}removeCondition(e){this.conditions.splice(e,1)}setOrderBy(e,s){this.orderBy={column:e,direction:s}}setLimit(e){this.limit=e?parseInt(e):null}reset(){this.selectedTable="",this.selectedColumns=["*"],this.conditions=[],this.orderBy={column:"",direction:"ASC"},this.limit=null}generateQuery(e=!1){if(!this.selectedTable)return"-- Selecciona una tabla para comenzar";const s=e?`
`:" ",n=e?"    ":"";switch(this.queryType){case"SELECT":return this.generateSelect(s,n);case"INSERT":return this.generateInsert(s,n);case"UPDATE":return this.generateUpdate(s,n);case"DELETE":return this.generateDelete(s,n);default:return""}}generateSelect(e,s){let n=`SELECT ${this.selectedColumns.join(", ")}${e}`;return n+=`FROM ${this.selectedTable}`,this.conditions.length>0&&(n+=`${e}WHERE `,n+=this.conditions.map((l,d)=>{const r=d>0?`${l.connector} `:"";if(l.operator==="IS NULL"||l.operator==="IS NOT NULL")return`${r}${l.column} ${l.operator}`;const c=this.formatValue(l.value,l.operator);return`${r}${l.column} ${l.operator} ${c}`}).join(`${e}${s}`)),this.orderBy.column&&(n+=`${e}ORDER BY ${this.orderBy.column} ${this.orderBy.direction}`),this.limit&&(n+=`${e}LIMIT ${this.limit}`),n+";"}generateInsert(e,s){const n=this.tables[this.selectedTable]||[],l=n.map(d=>{const r=document.getElementById(`insert-${d}`);return r?this.formatValue(r.value):"NULL"});return`INSERT INTO ${this.selectedTable}${e}(${n.join(", ")})${e}VALUES${e}(${l.join(", ")});`}generateUpdate(e,s){const l=(this.tables[this.selectedTable]||[]).filter(c=>{const p=document.getElementById(`update-${c}`);return p&&p.value}).map(c=>{const p=document.getElementById(`update-${c}`);return`${c} = ${this.formatValue(p.value)}`});if(l.length===0)return"-- Ingresa valores para actualizar";let d=`UPDATE ${this.selectedTable}${e}SET ${l.join(`,${e}${s}`)}`;const r=document.getElementById("update-conditions-list");if(r&&r.children.length>0){const c=this.parseConditionsFromDOM("update-conditions-list");c.length>0&&(d+=`${e}WHERE `,d+=c.map((p,g)=>`${g>0?`${p.connector} `:""}${p.column} ${p.operator} ${this.formatValue(p.value)}`).join(`${e}${s}`))}return d+";"}generateDelete(e,s){let n=`DELETE FROM ${this.selectedTable}`;const l=document.getElementById("delete-conditions-list");if(l&&l.children.length>0){const d=this.parseConditionsFromDOM("delete-conditions-list");d.length>0&&(n+=`${e}WHERE `,n+=d.map((r,c)=>`${c>0?`${r.connector} `:""}${r.column} ${r.operator} ${this.formatValue(r.value)}`).join(`${e}${s}`))}else return"-- ADVERTENCIA: DELETE sin WHERE eliminarÃ¡ todos los registros";return n+";"}parseConditionsFromDOM(e){const s=document.getElementById(e);return s?Array.from(s.children).map(n=>{const l=n.querySelector(".condition-column")?.value||"",d=n.querySelector(".condition-operator")?.value||"=",r=n.querySelector(".condition-value")?.value||"",c=n.querySelector(".condition-connector")?.value||"AND";return{column:l,operator:d,value:r,connector:c}}).filter(n=>n.column&&n.value):[]}formatValue(e,s="="){return!e||e===""?"NULL":s==="IN"?`(${e.split(",").map(n=>`'${n.trim()}'`).join(", ")})`:!isNaN(e)&&e!==""?e:e.toLowerCase()==="true"||e.toLowerCase()==="false"?e.toUpperCase():`'${e}'`}}function S(){const a=new w,e=document.querySelectorAll(".type-btn"),s=document.getElementById("select-table"),n=document.getElementById("insert-table"),l=document.getElementById("update-table"),d=document.getElementById("delete-table"),r=document.getElementById("available-columns"),c=document.getElementById("column-chips"),p=document.getElementById("conditions-list"),g=document.getElementById("add-condition"),h=document.getElementById("order-column"),$=document.getElementById("order-direction"),E=document.getElementById("limit-value"),B=document.getElementById("generated-query"),q=document.getElementById("copy-query"),T=document.getElementById("format-query"),A=document.getElementById("clear-query"),v=document.getElementById("toggle-schema"),N=document.getElementById("schema-content"),I=document.getElementById("sql-copy-feedback");if(!B)return;let L=!0;e.forEach(o=>{o.onclick=()=>{e.forEach(t=>t.classList.remove("active")),o.classList.add("active");const i=o.dataset.type;a.setQueryType(i),document.querySelectorAll(".builder-panel").forEach(t=>t.classList.add("hidden")),document.getElementById(`${i.toLowerCase()}-builder`)?.classList.remove("hidden"),m()}});function b(o,i){o&&(o.onchange=()=>{const t=o.value;a.setTable(t),i==="select"?(D(t),H(t)):i==="insert"?k(t):i==="update"&&j(t),m()})}b(s,"select"),b(n,"insert"),b(l,"update"),b(d,"delete");function D(o){if(!r||!c)return;const i=a.tables[o]||[];c.innerHTML='<span class="column-chip all-columns active" data-column="*">* (todas)</span>',r.innerHTML=i.map(t=>`<button class="column-btn" data-column="${t}">${t}</button>`).join(""),r.querySelectorAll(".column-btn").forEach(t=>{t.onclick=()=>{const u=t.dataset.column;O(u),t.classList.add("selected")}}),c.querySelector(".all-columns").onclick=()=>{a.setColumns(["*"]),c.innerHTML='<span class="column-chip all-columns active" data-column="*">* (todas)</span>',r.querySelectorAll(".column-btn").forEach(t=>t.classList.remove("selected")),m()}}function O(o){const i=c.querySelector(".all-columns");if(i&&i.remove(),c.querySelector(`[data-column="${o}"]`))return;const t=document.createElement("span");t.className="column-chip",t.dataset.column=o,t.innerHTML=`${o} <button class="remove-chip"><i class="fas fa-times"></i></button>`,t.querySelector(".remove-chip").onclick=u=>{u.stopPropagation(),t.remove(),r.querySelector(`[data-column="${o}"]`)?.classList.remove("selected"),M()},c.appendChild(t),M()}function M(){const o=c.querySelectorAll(".column-chip:not(.all-columns)"),i=Array.from(o).map(t=>t.dataset.column);a.setColumns(i),m()}function H(o){if(!h)return;const i=a.tables[o]||[];h.innerHTML='<option value="">Sin ordenar</option>'+i.map(t=>`<option value="${t}">${t}</option>`).join("")}function k(o){const i=document.getElementById("insert-values-container");if(!i)return;const t=a.tables[o]||[];i.innerHTML=t.map(u=>`
                <div class="value-field">
                    <label>${u}</label>
                    <input type="text" id="insert-${u}" class="builder-input" placeholder="Valor...">
                </div>
            `).join(""),i.querySelectorAll("input").forEach(u=>{u.oninput=m})}function j(o){const i=document.getElementById("update-set-container");if(!i)return;const t=a.tables[o]||[];i.innerHTML=t.map(u=>`
                <div class="value-field">
                    <label>${u}</label>
                    <input type="text" id="update-${u}" class="builder-input" placeholder="Nuevo valor...">
                </div>
            `).join(""),i.querySelectorAll("input").forEach(u=>{u.oninput=m})}function C(o){const i=document.getElementById(o);if(!i)return;const t=a.selectedTable,u=a.tables[t]||[],R=i.children.length===0,f=document.createElement("div");f.className="condition-row",f.innerHTML=`
                ${R?"":`
                    <select class="condition-connector builder-select tiny">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                `}
                <select class="condition-column builder-select small">
                    <option value="">Columna...</option>
                    ${u.map(y=>`<option value="${y}">${y}</option>`).join("")}
                </select>
                <select class="condition-operator builder-select tiny">
                    ${a.operators.map(y=>`<option value="${y}">${y}</option>`).join("")}
                </select>
                <input type="text" class="condition-value builder-input" placeholder="Valor...">
                <button class="remove-condition-btn"><i class="fas fa-times"></i></button>
            `,f.querySelector(".remove-condition-btn").onclick=()=>{f.remove(),m()},f.querySelectorAll("select, input").forEach(y=>{y.onchange=m,y.oninput=m}),i.appendChild(f)}g&&(g.onclick=()=>C("conditions-list")),document.getElementById("add-update-condition")?.addEventListener("click",()=>{C("update-conditions-list")}),document.getElementById("add-delete-condition")?.addEventListener("click",()=>{C("delete-conditions-list")}),h&&(h.onchange=()=>{a.setOrderBy(h.value,$?.value||"ASC"),m()}),$&&($.onchange=()=>{a.setOrderBy(h?.value||"",$.value),m()}),E&&(E.oninput=()=>{a.setLimit(E.value),m()});function m(){a.queryType==="SELECT"&&(a.conditions=a.parseConditionsFromDOM("conditions-list"));const o=a.generateQuery(L);B.textContent=o}T&&(T.onclick=()=>{L=!L,T.classList.toggle("active",L),m()}),q&&(q.onclick=async()=>{try{await navigator.clipboard.writeText(B.textContent),I&&(I.classList.add("show"),setTimeout(()=>I.classList.remove("show"),2e3))}catch(o){console.error("Failed to copy:",o)}}),A&&(A.onclick=()=>{a.reset(),s&&(s.value=""),n&&(n.value=""),l&&(l.value=""),d&&(d.value=""),p&&(p.innerHTML=""),c&&(c.innerHTML='<span class="column-chip all-columns" data-column="*">* (todas)</span>'),r&&(r.innerHTML=""),h&&(h.innerHTML='<option value="">Sin ordenar</option>'),E&&(E.value=""),document.getElementById("insert-values-container")?.replaceChildren(),document.getElementById("update-set-container")?.replaceChildren(),document.getElementById("update-conditions-list")?.replaceChildren(),document.getElementById("delete-conditions-list")?.replaceChildren(),m()}),v&&N&&(v.onclick=()=>{N.classList.toggle("collapsed"),v.querySelector("i").classList.toggle("fa-chevron-up"),v.querySelector("i").classList.toggle("fa-chevron-down")})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S();document.addEventListener("astro:page-load",S);

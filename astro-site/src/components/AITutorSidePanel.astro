---
/**
 * AITutorSidePanel.astro
 * Side panel persistente estilo Coursera Coach
 * Aparece a la derecha cuando se selecciona una asignatura
 *
 * Basado en:
 * - Coursera Coach AI (sidebar design)
 * - Every Layout Sidebar Pattern
 * - MDN CSS Grid Layout
 */

const base = import.meta.env.BASE_URL;
---

<!-- AI Tutor Side Panel - Coursera Coach Style -->
<aside id="ai-tutor-panel" class="ai-tutor-panel" aria-label="Tutor IA" role="complementary">
    <!-- Header with minimize/close -->
    <header class="tutor-header">
        <div class="tutor-branding">
            <div class="tutor-icon">
                <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="Gemini" />
            </div>
            <div class="tutor-title">
                <h3>Tutor IA</h3>
                <span class="tutor-badge">
                    <span class="badge-dot"></span>
                    Powered by Gemini
                </span>
            </div>
        </div>
        <div class="tutor-controls">
            <button class="tutor-size-btn" id="tutor-width-toggle" aria-label="Expandir ancho" title="Expandir/Contraer ancho">
                <i class="fas fa-arrows-alt-h"></i>
            </button>
            <button class="tutor-size-btn" id="tutor-expand" aria-label="Expandir altura" title="Expandir altura">
                <i class="fas fa-chevron-up"></i>
            </button>
            <button class="tutor-size-btn" id="tutor-collapse" aria-label="Colapsar" title="Colapsar">
                <i class="fas fa-chevron-down"></i>
            </button>
            <button class="tutor-minimize" id="tutor-minimize" aria-label="Minimizar">
                <i class="fas fa-minus"></i>
            </button>
            <button class="tutor-close" id="tutor-close" aria-label="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </header>

    <!-- Subject Context Banner -->
    <div class="tutor-context" id="tutor-context">
        <div class="context-icon">
            <i class="fas fa-book-open"></i>
        </div>
        <div class="context-info">
            <span class="context-label">Asignatura activa</span>
            <span class="context-subject" id="tutor-subject-name">Selecciona una asignatura</span>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="tutor-body">
        <!-- Welcome Message -->
        <div class="tutor-welcome" id="tutor-welcome">
            <div class="welcome-icon">
                <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="Gemini" />
            </div>
            <h4>¡Hola! Soy tu Tutor IA</h4>
            <p>Estoy aquí para ayudarte a aprender. Puedo:</p>
            <ul>
                <li><i class="fas fa-check"></i> Explicar conceptos difíciles</li>
                <li><i class="fas fa-check"></i> Generar ejemplos de código</li>
                <li><i class="fas fa-check"></i> Crear ejercicios de práctica</li>
                <li><i class="fas fa-check"></i> Prepararte para evaluaciones</li>
            </ul>
            <p class="welcome-cta">Selecciona una asignatura para comenzar</p>
        </div>

        <!-- Chat Messages Container -->
        <div class="tutor-messages" id="tutor-messages">
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Loading Indicator -->
        <div class="tutor-loading" id="tutor-loading" style="display: none;">
            <div class="loading-animation">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span>Pensando...</span>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="tutor-quick-actions" id="tutor-quick-actions">
        <button class="quick-action" data-action="resume" disabled>
            <i class="fas fa-compress-alt"></i>
            <span>Resumen</span>
        </button>
        <button class="quick-action" data-action="examples" disabled>
            <i class="fas fa-code"></i>
            <span>Ejemplos</span>
        </button>
        <button class="quick-action" data-action="practice" disabled>
            <i class="fas fa-dumbbell"></i>
            <span>Ejercicios</span>
        </button>
        <button class="quick-action" data-action="explain" disabled>
            <i class="fas fa-lightbulb"></i>
            <span>Explicar</span>
        </button>
    </div>

    <!-- Input Area -->
    <div class="tutor-input-area">
        <!-- API Key Setup (shown first) -->
        <div class="api-key-container" id="api-key-container">
            <div class="api-key-header">
                <i class="fas fa-key"></i>
                <span>Configura tu API Key de Gemini</span>
            </div>
            <div class="api-key-form">
                <input
                    type="password"
                    id="gemini-api-key-input"
                    placeholder="AIzaSy..."
                    class="api-key-input"
                />
                <button class="api-key-save-btn" id="save-api-key-btn">
                    <i class="fas fa-save"></i>
                </button>
            </div>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-key-link">
                <i class="fas fa-external-link-alt"></i> Obtener API Key gratis
            </a>
        </div>

        <!-- Chat Input (shown after API key is set) -->
        <div class="chat-input-container" id="chat-input-container" style="display: none;">
            <div class="chat-input-wrapper">
                <textarea
                    id="tutor-chat-input"
                    placeholder="Pregúntame algo sobre la asignatura..."
                    rows="2"
                ></textarea>
                <button class="send-btn" id="send-message-btn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="input-footer">
                <span class="model-info">
                    <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="" class="model-icon" />
                    Gemini 2.0 Flash
                </span>
                <button class="clear-chat-btn" id="clear-chat-btn">
                    <i class="fas fa-trash-alt"></i> Limpiar
                </button>
            </div>
        </div>
    </div>

    <!-- Minimized State -->
    <div class="tutor-minimized" id="tutor-minimized" style="display: none;">
        <button class="expand-btn" id="tutor-expand-btn">
            <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="Gemini" />
            <span>Tutor IA</span>
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>
</aside>

<style>
    /* ============================================
       AI TUTOR SIDE PANEL - Coursera Coach Style
       Enterprise-grade design with Gemini branding
    ============================================ */

    .ai-tutor-panel {
        position: fixed;
        top: 70px; /* Below header */
        right: 0;
        width: 280px;
        height: calc(100vh - 70px);
        background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        border-left: 1px solid rgba(139, 92, 246, 0.3);
        display: flex;
        flex-direction: column;
        z-index: 1002;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), width 0.3s ease;
        box-shadow: -5px 0 30px rgba(0, 0, 0, 0.3);
        font-size: 0.8rem;
    }

    .ai-tutor-panel.visible {
        transform: translateX(0);
    }

    /* Expanded width mode */
    .ai-tutor-panel.expanded-width {
        width: 420px;
    }

    .ai-tutor-panel.collapsed {
        height: 54px !important;
        top: auto !important;
        bottom: 0 !important;
        border-top: 1px solid rgba(139, 92, 246, 0.4);
        border-radius: 12px 12px 0 0;
    }

    .ai-tutor-panel.collapsed .tutor-header {
        border-radius: 12px 12px 0 0;
    }

    .ai-tutor-panel.collapsed .tutor-context,
    .ai-tutor-panel.collapsed .tutor-body,
    .ai-tutor-panel.collapsed .tutor-quick-actions,
    .ai-tutor-panel.collapsed .tutor-input-area {
        display: none !important;
    }

    /* Half height mode */
    .ai-tutor-panel.half-height {
        height: 50vh !important;
        top: auto !important;
        bottom: 0 !important;
    }

    /* Old horizontal minimized - keeping for compatibility */
    .ai-tutor-panel.minimized {
        transform: translateX(calc(100% - 60px));
    }

    .ai-tutor-panel.minimized .tutor-header,
    .ai-tutor-panel.minimized .tutor-context,
    .ai-tutor-panel.minimized .tutor-body,
    .ai-tutor-panel.minimized .tutor-quick-actions,
    .ai-tutor-panel.minimized .tutor-input-area {
        display: none;
    }

    .ai-tutor-panel.minimized .tutor-minimized {
        display: flex !important;
    }

    /* ============================================
       HEADER - Compact Premium
    ============================================ */
    .tutor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(59, 130, 246, 0.12));
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        flex-shrink: 0;
    }

    .tutor-branding {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tutor-icon {
        width: 26px;
        height: 26px;
        background: linear-gradient(135deg, #4285f4, #8b5cf6);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 10px rgba(139, 92, 246, 0.25);
    }

    .tutor-icon img {
        width: 14px;
        height: 14px;
    }

    .tutor-title h3 {
        margin: 0;
        font-size: 0.82rem;
        font-weight: 700;
        font-family: 'Sora', sans-serif;
        color: #f8fafc;
        letter-spacing: -0.01em;
    }

    .tutor-badge {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.55rem;
        color: #a78bfa;
        font-weight: 500;
    }

    .badge-dot {
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .tutor-controls {
        display: flex;
        gap: 0.35rem;
    }

    .tutor-size-btn,
    .tutor-minimize,
    .tutor-close {
        width: 22px;
        height: 22px;
        border-radius: 5px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(30, 41, 59, 0.5);
        color: #94a3b8;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.6rem;
    }

    .tutor-size-btn:hover,
    .tutor-minimize:hover {
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.4);
        color: #a78bfa;
    }

    .tutor-size-btn.active {
        background: rgba(139, 92, 246, 0.3);
        border-color: rgba(139, 92, 246, 0.5);
        color: #c4b5fd;
    }

    .tutor-close:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.4);
        color: #f87171;
    }

    /* ============================================
       CONTEXT BANNER - Compact
    ============================================ */
    .tutor-context {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        background: rgba(6, 182, 212, 0.08);
        border-bottom: 1px solid rgba(6, 182, 212, 0.15);
        flex-shrink: 0;
    }

    .context-icon {
        width: 20px;
        height: 20px;
        background: rgba(6, 182, 212, 0.2);
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #22d3ee;
        font-size: 0.6rem;
    }

    .context-info {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
    }

    .context-label {
        font-size: 0.5rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .context-subject {
        font-size: 0.68rem;
        font-weight: 600;
        color: #f1f5f9;
        font-family: 'Space Grotesk', sans-serif;
    }

    /* ============================================
       BODY / CHAT AREA - Compact
    ============================================ */
    .tutor-body {
        flex: 1;
        overflow-y: auto;
        padding: 0.75rem 0.85rem;
        scrollbar-width: thin;
        scrollbar-color: rgba(139, 92, 246, 0.3) transparent;
    }

    .tutor-body::-webkit-scrollbar {
        width: 5px;
    }

    .tutor-body::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.3);
        border-radius: 3px;
    }

    /* Welcome Message - Compact */
    .tutor-welcome {
        text-align: center;
        padding: 0.6rem;
    }

    .welcome-icon {
        width: 38px;
        height: 38px;
        margin: 0 auto 0.5rem;
        background: linear-gradient(135deg, #4285f4, #8b5cf6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.25);
    }

    .welcome-icon img {
        width: 20px;
        height: 20px;
    }

    .tutor-welcome h4 {
        font-family: 'Sora', sans-serif;
        font-size: 0.85rem;
        color: #f8fafc;
        margin: 0 0 0.35rem 0;
    }

    .tutor-welcome > p {
        color: #94a3b8;
        font-size: 0.68rem;
        margin-bottom: 0.5rem;
    }

    .tutor-welcome ul {
        list-style: none;
        padding: 0;
        margin: 0 0 0.6rem 0;
        text-align: left;
    }

    .tutor-welcome li {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem 0;
        color: #cbd5e1;
        font-size: 0.65rem;
    }

    .tutor-welcome li i {
        color: #22c55e;
        font-size: 0.55rem;
    }

    .welcome-cta {
        color: #a78bfa !important;
        font-weight: 500;
        font-size: 0.65rem !important;
    }

    /* Chat Messages - Side by Side Layout */
    .tutor-messages {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .message {
        display: flex;
        gap: 0.4rem;
        animation: fadeIn 0.3s ease;
        max-width: 92%;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* User messages aligned to the right */
    .message.user {
        flex-direction: row-reverse;
        align-self: flex-end;
        margin-left: auto;
    }

    /* Assistant messages aligned to the left */
    .message.assistant {
        align-self: flex-start;
        margin-right: auto;
    }

    .message-avatar {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .message.assistant .message-avatar {
        background: linear-gradient(135deg, #4285f4, #8b5cf6);
    }

    .message.assistant .message-avatar img {
        width: 12px;
        height: 12px;
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, #06b6d4, #22d3ee);
    }

    .message.user .message-avatar i {
        color: white;
        font-size: 0.6rem;
    }

    .message-bubble {
        max-width: 88%;
        padding: 0.5rem 0.7rem;
        border-radius: 10px;
        font-size: 0.72rem;
        line-height: 1.45;
        font-family: 'Inter', system-ui, sans-serif;
    }

    .message.assistant .message-bubble {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(139, 92, 246, 0.2);
        color: #e2e8f0;
        border-radius: 10px 10px 10px 3px;
    }

    .message.user .message-bubble {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.25), rgba(6, 182, 212, 0.08));
        border: 1px solid rgba(6, 182, 212, 0.25);
        color: #f1f5f9;
        border-radius: 10px 10px 3px 10px;
    }

    .message-bubble pre {
        background: rgba(0, 0, 0, 0.4);
        padding: 0.875rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 0.75rem 0;
    }

    .message-bubble code {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 0.8rem;
    }

    .message-bubble h3, .message-bubble h4 {
        color: #a78bfa;
        margin: 0.75rem 0 0.5rem;
        font-size: 0.95rem;
    }

    .message-bubble ul, .message-bubble ol {
        margin: 0.5rem 0;
        padding-left: 1.25rem;
    }

    .message-bubble li {
        margin-bottom: 0.25rem;
    }

    /* Loading */
    .tutor-loading {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
    }

    .loading-animation {
        display: flex;
        gap: 4px;
    }

    .loading-animation span {
        width: 8px;
        height: 8px;
        background: #a78bfa;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
    }

    .loading-animation span:nth-child(1) { animation-delay: -0.32s; }
    .loading-animation span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    .tutor-loading > span {
        color: #94a3b8;
        font-size: 0.85rem;
    }

    /* ============================================
       QUICK ACTIONS - Compact
    ============================================ */
    .tutor-quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.35rem;
        padding: 0.5rem 0.75rem;
        border-top: 1px solid rgba(148, 163, 184, 0.1);
        flex-shrink: 0;
    }

    .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
        padding: 0.4rem 0.3rem;
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 8px;
        color: #c4b5fd;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .quick-action:hover:not(:disabled) {
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.4);
        transform: translateY(-1px);
    }

    .quick-action:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .quick-action i {
        font-size: 0.8rem;
    }

    .quick-action span {
        font-size: 0.55rem;
        font-weight: 500;
    }

    /* ============================================
       INPUT AREA - Compact
    ============================================ */
    .tutor-input-area {
        padding: 0.6rem 0.75rem;
        background: rgba(30, 41, 59, 0.5);
        border-top: 1px solid rgba(139, 92, 246, 0.2);
        flex-shrink: 0;
    }

    /* API Key Setup */
    .api-key-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .api-key-header {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        color: #a78bfa;
        font-size: 0.68rem;
        font-weight: 500;
    }

    .api-key-form {
        display: flex;
        gap: 0.4rem;
    }

    .api-key-input {
        flex: 1;
        padding: 0.45rem 0.65rem;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 6px;
        color: #e2e8f0;
        font-size: 0.72rem;
        font-family: 'JetBrains Mono', monospace;
    }

    .api-key-input:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.6);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }

    .api-key-save-btn {
        padding: 0.45rem 0.65rem;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.7rem;
    }

    .api-key-save-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(139, 92, 246, 0.4);
    }

    .api-key-link {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.62rem;
        color: #a78bfa;
        text-decoration: none;
    }

    .api-key-link:hover {
        text-decoration: underline;
    }

    /* Chat Input */
    .chat-input-container {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .chat-input-wrapper {
        display: flex;
        gap: 0.4rem;
        align-items: flex-end;
    }

    .chat-input-wrapper textarea {
        flex: 1;
        padding: 0.5rem 0.7rem;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 8px;
        color: #e2e8f0;
        font-size: 0.72rem;
        font-family: 'Inter', system-ui, sans-serif;
        resize: none;
        line-height: 1.45;
    }

    .chat-input-wrapper textarea:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.6);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }

    .send-btn {
        padding: 0.5rem 0.7rem;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.7rem;
    }

    .send-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(139, 92, 246, 0.4);
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .input-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .model-info {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.58rem;
        color: #64748b;
    }

    .model-icon {
        width: 10px;
        height: 10px;
    }

    .clear-chat-btn {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.45rem;
        background: transparent;
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 5px;
        color: #f87171;
        font-size: 0.58rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .clear-chat-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.5);
    }

    /* ============================================
       MINIMIZED STATE
    ============================================ */
    .tutor-minimized {
        position: absolute;
        bottom: 1rem;
        right: 0.75rem;
        display: none;
    }

    .expand-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #4285f4, #8b5cf6);
        border: none;
        border-radius: 30px;
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        transition: all 0.2s ease;
    }

    .expand-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
    }

    .expand-btn img {
        width: 20px;
        height: 20px;
    }

    /* ============================================
       LIGHT MODE
    ============================================ */
    :global([data-theme="light"]) .ai-tutor-panel {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-left-color: rgba(139, 92, 246, 0.2);
    }

    :global([data-theme="light"]) .tutor-header {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
    }

    :global([data-theme="light"]) .tutor-title h3 {
        color: #0f172a;
    }

    :global([data-theme="light"]) .tutor-badge {
        color: #7c3aed;
    }

    :global([data-theme="light"]) .tutor-size-btn,
    .tutor-minimize,
    :global([data-theme="light"]) .tutor-close {
        background: rgba(241, 245, 249, 0.8);
        color: #64748b;
    }

    :global([data-theme="light"]) .tutor-context {
        background: rgba(6, 182, 212, 0.08);
        border-bottom-color: rgba(6, 182, 212, 0.15);
    }

    :global([data-theme="light"]) .context-subject {
        color: #0f172a;
    }

    :global([data-theme="light"]) .tutor-welcome h4 {
        color: #0f172a;
    }

    :global([data-theme="light"]) .tutor-welcome > p {
        color: #475569;
    }

    :global([data-theme="light"]) .tutor-welcome li {
        color: #334155;
    }

    :global([data-theme="light"]) .welcome-cta {
        color: #7c3aed !important;
    }

    :global([data-theme="light"]) .message.assistant .message-bubble {
        background: rgba(248, 250, 252, 0.9);
        border-color: rgba(139, 92, 246, 0.15);
        color: #1e293b;
    }

    :global([data-theme="light"]) .message.user .message-bubble {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(6, 182, 212, 0.05));
        color: #0f172a;
    }

    :global([data-theme="light"]) .quick-action {
        background: rgba(248, 250, 252, 0.9);
        color: #6d28d9;
    }

    :global([data-theme="light"]) .tutor-input-area {
        background: rgba(248, 250, 252, 0.9);
    }

    :global([data-theme="light"]) .api-key-input,
    :global([data-theme="light"]) .chat-input-wrapper textarea {
        background: white;
        color: #0f172a;
    }

    /* ============================================
       RESPONSIVE
    ============================================ */
    @media (max-width: 1200px) {
        .ai-tutor-panel {
            width: 340px;
        }
    }

    @media (max-width: 900px) {
        .ai-tutor-panel {
            width: 100%;
            max-width: 400px;
        }
    }

    @media (max-width: 600px) {
        .ai-tutor-panel {
            width: 100%;
            max-width: 100%;
        }

        .tutor-quick-actions {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<script is:inline>
    // ============================================
    // AI TUTOR SIDE PANEL - JAVASCRIPT
    // Coursera Coach Style Implementation
    // ============================================

    let currentSubject = null;
    let chatHistory = [];
    let tutorInitialized = false;

    function initAITutorPanel() {
        if (tutorInitialized) return;
        tutorInitialized = true;

        const panel = document.getElementById('ai-tutor-panel');
        const minimizeBtn = document.getElementById('tutor-minimize');
        const closeBtn = document.getElementById('tutor-close');
        const expandBtn = document.getElementById('tutor-expand-btn');
        const verticalExpandBtn = document.getElementById('tutor-expand');
        const verticalCollapseBtn = document.getElementById('tutor-collapse');
        const saveKeyBtn = document.getElementById('save-api-key-btn');
        const sendBtn = document.getElementById('send-message-btn');
        const chatInput = document.getElementById('tutor-chat-input');
        const clearBtn = document.getElementById('clear-chat-btn');
        const quickActions = document.querySelectorAll('.quick-action');

        // Check for saved API key
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) {
            showChatInput();
        }

        // Minimize panel
        minimizeBtn?.addEventListener('click', () => {
            panel?.classList.add('minimized');
        });

        // Close panel
        closeBtn?.addEventListener('click', () => {
            panel?.classList.remove('visible', 'minimized');
            currentSubject = null;
            updateQuickActionsState(false);
        });

        // Horizontal width toggle
        const widthToggleBtn = document.getElementById('tutor-width-toggle');
        widthToggleBtn?.addEventListener('click', () => {
            panel?.classList.toggle('expanded-width');
            widthToggleBtn?.classList.toggle('active');
        });

        // Vertical expand (full height)
        verticalExpandBtn?.addEventListener('click', () => {
            panel?.classList.remove('collapsed', 'half-height');
            panel?.classList.add('full-height');
        });

        // Vertical collapse (header only)
        verticalCollapseBtn?.addEventListener('click', () => {
            panel?.classList.remove('full-height', 'half-height');
            panel?.classList.add('collapsed');
        });

        // Expand from minimized
        expandBtn?.addEventListener('click', () => {
            panel?.classList.remove('minimized');
        });

        // Save API key
        saveKeyBtn?.addEventListener('click', saveApiKey);

        // Send message
        sendBtn?.addEventListener('click', sendMessage);

        // Enter to send
        chatInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Clear chat
        clearBtn?.addEventListener('click', clearChat);

        // Quick actions
        quickActions.forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.disabled) {
                    handleQuickAction(btn.dataset.action);
                }
            });
        });

        // Input state
        chatInput?.addEventListener('input', () => {
            sendBtn.disabled = !chatInput.value.trim();
        });
    }

    // Show panel for a subject
    window.showAITutor = function(subjectName, subjectCode) {
        const panel = document.getElementById('ai-tutor-panel');
        const subjectLabel = document.getElementById('tutor-subject-name');
        const welcome = document.getElementById('tutor-welcome');
        const messages = document.getElementById('tutor-messages');

        currentSubject = { name: subjectName, code: subjectCode };
        chatHistory = [];

        // Update subject context
        if (subjectLabel) {
            subjectLabel.textContent = subjectName;
        }

        // Clear messages and show welcome
        if (messages) messages.innerHTML = '';
        if (welcome) welcome.style.display = 'block';

        // Show panel
        panel?.classList.add('visible');
        panel?.classList.remove('minimized');

        // Enable quick actions
        updateQuickActionsState(true);

        // Add initial assistant message
        setTimeout(() => {
            addMessage('assistant', `¡Hola! Soy tu tutor para **${subjectName}**. ¿En qué puedo ayudarte hoy?`);
        }, 500);
    };

    // Hide panel
    window.hideAITutor = function() {
        const panel = document.getElementById('ai-tutor-panel');
        panel?.classList.remove('visible', 'minimized');
        currentSubject = null;
    };

    function showChatInput() {
        const apiKeyContainer = document.getElementById('api-key-container');
        const chatContainer = document.getElementById('chat-input-container');

        if (apiKeyContainer) apiKeyContainer.style.display = 'none';
        if (chatContainer) chatContainer.style.display = 'flex';
    }

    function saveApiKey() {
        const input = document.getElementById('gemini-api-key-input');
        const key = input?.value?.trim();

        if (key && key.startsWith('AIza')) {
            localStorage.setItem('gemini_api_key', key);
            showChatInput();
            addMessage('assistant', '¡API Key guardada correctamente! Ya puedes empezar a preguntarme.');
        } else {
            addMessage('assistant', 'Por favor, ingresa una API Key válida de Gemini. Debe comenzar con "AIza..."');
        }
    }

    function updateQuickActionsState(enabled) {
        const quickActions = document.querySelectorAll('.quick-action');
        quickActions.forEach(btn => {
            btn.disabled = !enabled;
        });
    }

    function handleQuickAction(action) {
        if (!currentSubject) return;

        const prompts = {
            'resume': `Dame un resumen conciso de los conceptos clave de ${currentSubject.name}. Incluye los puntos más importantes que un estudiante debe dominar.`,
            'examples': `Proporciona ejemplos prácticos de código para ${currentSubject.name}. Usa ejemplos del mundo real relevantes para un programador.`,
            'practice': `Genera 3 ejercicios prácticos de ${currentSubject.name} con diferentes niveles de dificultad (básico, intermedio, avanzado). Incluye las respuestas esperadas.`,
            'explain': `Explica de forma simple y clara los fundamentos de ${currentSubject.name}. Usa analogías y ejemplos cotidianos para facilitar la comprensión.`
        };

        const prompt = prompts[action];
        if (prompt) {
            const chatInput = document.getElementById('tutor-chat-input');
            if (chatInput) {
                chatInput.value = prompt;
                sendMessage();
            }
        }
    }

    async function sendMessage() {
        const input = document.getElementById('tutor-chat-input');
        const message = input?.value?.trim();
        const apiKey = localStorage.getItem('gemini_api_key');

        if (!message) return;
        if (!apiKey) {
            addMessage('assistant', 'Por favor, configura tu API Key de Gemini primero.');
            return;
        }

        // Add user message
        addMessage('user', message);
        input.value = '';
        document.getElementById('send-message-btn').disabled = true;

        // Show loading
        showLoading(true);

        try {
            const response = await callGeminiAPI(message, apiKey);
            addMessage('assistant', response);
        } catch (error) {
            console.error('Gemini API Error:', error);
            addMessage('assistant', `Error: ${error.message || 'No se pudo conectar con Gemini. Verifica tu API Key.'}`);
        } finally {
            showLoading(false);
        }
    }

    async function callGeminiAPI(message, apiKey) {
        const subjectContext = currentSubject
            ? `la asignatura "${currentSubject.name}" (código: ${currentSubject.code})`
            : 'programación';

        const systemPrompt = `Eres un tutor IA especializado en ${subjectContext} del programa Analista Programador Computacional de DuocUC, Chile.
Tu objetivo es ayudar a estudiantes a comprender conceptos, resolver ejercicios y prepararse para evaluaciones.
Responde en español de Chile, de forma clara, profesional y pedagógica.
Usa formato Markdown: headers (##), listas (-), código (\`\`\`), negritas (**), etc.
Si el estudiante pregunta algo fuera del tema, gentilmente redirige la conversación.
Mantén respuestas concisas pero completas.`;

        const payload = {
            contents: [
                {
                    parts: [
                        { text: systemPrompt },
                        ...chatHistory.map(msg => ({ text: `${msg.role === 'user' ? 'Usuario' : 'Tutor'}: ${msg.content}` })),
                        { text: `Usuario: ${message}` }
                    ]
                }
            ],
            generationConfig: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 2048,
            }
        };

        // Try multiple models in order of preference (updated Dec 2025)
        // See: https://ai.google.dev/gemini-api/docs/models
        const models = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-2.0-flash-lite'];
        let response = null;
        let lastError = null;

        for (const model of models) {
            try {
                response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (response.ok) {
                    console.log(`Using Gemini model: ${model}`);
                    break;
                }

                lastError = await response.json();
                console.warn(`Model ${model} failed:`, lastError.error?.message);
            } catch (e) {
                lastError = e;
                console.warn(`Model ${model} error:`, e);
            }
        }

        if (!response || !response.ok) {
            throw new Error(lastError?.error?.message || 'No se pudo conectar con Gemini. Verifica tu API Key.');
        }

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No se recibió respuesta.';

        // Update history
        chatHistory.push({ role: 'user', content: message });
        chatHistory.push({ role: 'assistant', content: text });

        // Keep last 10 exchanges
        if (chatHistory.length > 20) {
            chatHistory = chatHistory.slice(-20);
        }

        return text;
    }

    function addMessage(role, content) {
        const messagesContainer = document.getElementById('tutor-messages');
        const welcome = document.getElementById('tutor-welcome');

        if (!messagesContainer) return;

        // Hide welcome
        if (welcome) welcome.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        // Simple markdown to HTML
        let formattedContent = content
            .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\*([^*]+)\*/g, '<em>$1</em>')
            .replace(/^### (.+)$/gm, '<h4>$1</h4>')
            .replace(/^## (.+)$/gm, '<h3>$1</h3>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
            .replace(/\n/g, '<br>');

        const avatarContent = role === 'assistant'
            ? '<img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="AI" />'
            : '<i class="fas fa-user"></i>';

        messageDiv.innerHTML = `
            <div class="message-avatar">${avatarContent}</div>
            <div class="message-bubble">${formattedContent}</div>
        `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showLoading(show) {
        const loading = document.getElementById('tutor-loading');
        if (loading) {
            loading.style.display = show ? 'flex' : 'none';
        }
    }

    function clearChat() {
        const messagesContainer = document.getElementById('tutor-messages');
        const welcome = document.getElementById('tutor-welcome');

        if (messagesContainer) messagesContainer.innerHTML = '';
        if (welcome) welcome.style.display = 'block';

        chatHistory = [];
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initAITutorPanel);
    document.addEventListener('astro:page-load', () => {
        tutorInitialized = false;
        initAITutorPanel();
    });
</script>

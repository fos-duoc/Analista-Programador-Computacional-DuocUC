---
/**
 * AITutorSidePanel.astro
 * Premium AI Tutor Panel - Enterprise-grade design
 * Aparece a la derecha cuando se selecciona una asignatura
 *
 * Rediseño sofisticado con:
 * - Controles simplificados (solo close)
 * - API Key setup elegante como primer paso de onboarding
 * - Welcome message premium con animaciones
 * - Quick actions contextuales
 * - Chat UI moderno estilo ChatGPT/Claude
 */

const base = import.meta.env.BASE_URL;
---

<!-- AI Tutor Side Panel - Premium Design -->
<aside id="ai-tutor-panel" class="ai-tutor-panel" aria-label="Tutor IA" role="complementary">
    <!-- Premium Header -->
    <header class="tutor-header">
        <div class="tutor-branding">
            <div class="tutor-logo">
                <div class="logo-glow"></div>
                <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="Gemini" />
            </div>
            <div class="tutor-title">
                <h3>Tutor IA</h3>
                <div class="tutor-status">
                    <span class="status-dot"></span>
                    <span>Online</span>
                </div>
            </div>
        </div>
        <button class="tutor-close" id="tutor-close" aria-label="Cerrar panel" title="Cerrar">
            <i class="fas fa-times"></i>
        </button>
    </header>

    <!-- Subject Context Banner (más elegante) -->
    <div class="tutor-context" id="tutor-context">
        <div class="context-badge">
            <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="context-info">
            <span class="context-label">Estudiando</span>
            <span class="context-subject" id="tutor-subject-name">Selecciona una asignatura</span>
        </div>
        <div class="context-indicator">
            <i class="fas fa-circle"></i>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="tutor-body">
        <!-- Premium Welcome Message -->
        <div class="tutor-welcome" id="tutor-welcome">
            <div class="welcome-hero">
                <div class="welcome-avatar">
                    <div class="avatar-ring"></div>
                    <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="AI" />
                </div>
                <h4>Tu Asistente de Estudio Personal</h4>
                <p class="welcome-subtitle">Powered by Google Gemini</p>
            </div>

            <div class="welcome-capabilities">
                <div class="capability-card">
                    <i class="fas fa-brain"></i>
                    <span>Explico conceptos</span>
                </div>
                <div class="capability-card">
                    <i class="fas fa-code"></i>
                    <span>Genero código</span>
                </div>
                <div class="capability-card">
                    <i class="fas fa-tasks"></i>
                    <span>Creo ejercicios</span>
                </div>
                <div class="capability-card">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Preparo evaluaciones</span>
                </div>
            </div>

            <p class="welcome-hint">
                <i class="fas fa-hand-pointer"></i>
                Haz clic en una asignatura para comenzar
            </p>
        </div>

        <!-- Chat Messages Container -->
        <div class="tutor-messages" id="tutor-messages">
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Loading Indicator -->
        <div class="tutor-loading" id="tutor-loading" style="display: none;">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="loading-text">Generando respuesta...</span>
        </div>
    </div>

    <!-- Quick Actions (solo visibles cuando hay asignatura) -->
    <div class="tutor-quick-actions" id="tutor-quick-actions">
        <div class="actions-label">Acciones rápidas</div>
        <div class="actions-grid">
            <button class="quick-action" data-action="resume" disabled>
                <i class="fas fa-file-alt"></i>
                <span>Resumen</span>
            </button>
            <button class="quick-action" data-action="examples" disabled>
                <i class="fas fa-laptop-code"></i>
                <span>Ejemplos</span>
            </button>
            <button class="quick-action" data-action="practice" disabled>
                <i class="fas fa-pencil-alt"></i>
                <span>Ejercicios</span>
            </button>
            <button class="quick-action" data-action="explain" disabled>
                <i class="fas fa-question-circle"></i>
                <span>Explicar</span>
            </button>
        </div>
    </div>

    <!-- Input Area - Diseño Premium -->
    <div class="tutor-input-area">
        <!-- API Key Setup (elegante onboarding) -->
        <div class="api-key-container" id="api-key-container">
            <div class="api-key-card">
                <div class="api-key-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="api-key-content">
                    <h5>Conecta con Gemini</h5>
                    <p>Ingresa tu API Key para activar el tutor</p>
                </div>
            </div>
            <div class="api-key-form">
                <div class="input-group">
                    <input
                        type="password"
                        id="gemini-api-key-input"
                        placeholder="Pega tu API Key aquí..."
                        class="api-key-input"
                    />
                    <button class="api-key-save-btn" id="save-api-key-btn">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-key-link">
                    <i class="fas fa-external-link-alt"></i>
                    Obtener API Key gratis en Google AI Studio
                </a>
            </div>
        </div>

        <!-- Chat Input (estilo premium) -->
        <div class="chat-input-container" id="chat-input-container" style="display: none;">
            <div class="chat-input-wrapper">
                <textarea
                    id="tutor-chat-input"
                    placeholder="Escribe tu pregunta..."
                    rows="1"
                ></textarea>
                <button class="send-btn" id="send-message-btn" disabled>
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
            <div class="input-footer">
                <div class="model-badge">
                    <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="" />
                    <span>Gemini 2.0</span>
                </div>
                <button class="settings-btn" id="settings-btn" title="Configuración">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </div>
</aside>

<style>
    /* ============================================
       AI TUTOR SIDE PANEL - Premium Enterprise Design
       Sophisticated, useful, and elegant
    ============================================ */

    .ai-tutor-panel {
        position: fixed;
        top: 70px;
        right: 0;
        width: 320px;
        height: calc(100vh - 70px);
        background: linear-gradient(180deg, #0a0f1a 0%, #111827 50%, #0f172a 100%);
        border-left: 1px solid rgba(139, 92, 246, 0.2);
        display: flex;
        flex-direction: column;
        z-index: 1002;
        transform: translateX(100%);
        transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: -8px 0 40px rgba(0, 0, 0, 0.4);
        font-size: 0.85rem;
    }

    .ai-tutor-panel.visible {
        transform: translateX(0);
    }

    /* ============================================
       PREMIUM HEADER
    ============================================ */
    .tutor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 1rem;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(59, 130, 246, 0.05));
        border-bottom: 1px solid rgba(139, 92, 246, 0.15);
        flex-shrink: 0;
    }

    .tutor-branding {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .tutor-logo {
        position: relative;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .logo-glow {
        position: absolute;
        inset: -4px;
        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
        border-radius: 12px;
        opacity: 0.3;
        filter: blur(8px);
        animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.1); }
    }

    .tutor-logo img {
        position: relative;
        width: 24px;
        height: 24px;
        z-index: 1;
        filter: drop-shadow(0 2px 4px rgba(139, 92, 246, 0.3));
    }

    .tutor-title h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        font-family: 'Sora', sans-serif;
        color: #f8fafc;
        letter-spacing: -0.02em;
    }

    .tutor-status {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.7rem;
        color: #94a3b8;
    }

    .status-dot {
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: statusPulse 2s infinite;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    @keyframes statusPulse {
        0%, 100% { opacity: 1; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
        50% { opacity: 0.7; box-shadow: 0 0 12px rgba(34, 197, 94, 0.8); }
    }

    .tutor-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        background: rgba(30, 41, 59, 0.4);
        color: #94a3b8;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s ease;
        font-size: 0.85rem;
    }

    .tutor-close:hover {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.3);
        color: #f87171;
        transform: rotate(90deg);
    }

    /* ============================================
       CONTEXT BANNER - Elegant
    ============================================ */
    .tutor-context {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 1rem;
        background: linear-gradient(90deg, rgba(6, 182, 212, 0.08), transparent);
        border-bottom: 1px solid rgba(6, 182, 212, 0.1);
        flex-shrink: 0;
    }

    .context-badge {
        width: 28px;
        height: 28px;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.05));
        border: 1px solid rgba(6, 182, 212, 0.25);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #22d3ee;
        font-size: 0.75rem;
    }

    .context-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .context-label {
        font-size: 0.6rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 500;
    }

    .context-subject {
        font-size: 0.8rem;
        font-weight: 600;
        color: #f1f5f9;
        font-family: 'Space Grotesk', sans-serif;
    }

    .context-indicator {
        color: #22c55e;
        font-size: 0.4rem;
        animation: contextPulse 2s infinite;
    }

    @keyframes contextPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    /* ============================================
       BODY / CHAT AREA
    ============================================ */
    .tutor-body {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        scrollbar-width: thin;
        scrollbar-color: rgba(139, 92, 246, 0.25) transparent;
    }

    .tutor-body::-webkit-scrollbar {
        width: 6px;
    }

    .tutor-body::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.25);
        border-radius: 3px;
    }

    /* Premium Welcome Message */
    .tutor-welcome {
        padding: 0.5rem;
    }

    .welcome-hero {
        text-align: center;
        margin-bottom: 1.25rem;
    }

    .welcome-avatar {
        position: relative;
        width: 56px;
        height: 56px;
        margin: 0 auto 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatar-ring {
        position: absolute;
        inset: -3px;
        border: 2px solid transparent;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6, #3b82f6) border-box;
        -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        animation: ringRotate 4s linear infinite;
    }

    @keyframes ringRotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .welcome-avatar img {
        width: 32px;
        height: 32px;
        filter: drop-shadow(0 4px 12px rgba(139, 92, 246, 0.3));
    }

    .welcome-hero h4 {
        font-family: 'Sora', sans-serif;
        font-size: 1.1rem;
        font-weight: 700;
        color: #f8fafc;
        margin: 0 0 0.25rem 0;
        letter-spacing: -0.02em;
    }

    .welcome-subtitle {
        font-size: 0.75rem;
        color: #a78bfa;
        font-weight: 500;
        margin: 0;
    }

    .welcome-capabilities {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-bottom: 1.25rem;
    }

    .capability-card {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 0.75rem;
        background: rgba(30, 41, 59, 0.4);
        border: 1px solid rgba(139, 92, 246, 0.12);
        border-radius: 10px;
        transition: all 0.25s ease;
    }

    .capability-card:hover {
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.25);
        transform: translateY(-1px);
    }

    .capability-card i {
        font-size: 0.9rem;
        color: #a78bfa;
    }

    .capability-card span {
        font-size: 0.72rem;
        color: #e2e8f0;
        font-weight: 500;
    }

    .welcome-hint {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: #64748b;
        padding: 0.75rem;
        background: rgba(100, 116, 139, 0.08);
        border-radius: 8px;
        margin: 0;
    }

    .welcome-hint i {
        color: #a78bfa;
        animation: pointBounce 1.5s ease-in-out infinite;
    }

    @keyframes pointBounce {
        0%, 100% { transform: translateX(0); }
        50% { transform: translateX(3px); }
    }

    /* Chat Messages */
    .tutor-messages {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .message {
        display: flex;
        gap: 0.5rem;
        animation: messageSlide 0.35s ease;
        max-width: 95%;
    }

    @keyframes messageSlide {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
        flex-direction: row-reverse;
        align-self: flex-end;
        margin-left: auto;
    }

    .message.assistant {
        align-self: flex-start;
        margin-right: auto;
    }

    .message-avatar {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .message.assistant .message-avatar {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }

    .message.assistant .message-avatar img {
        width: 16px;
        height: 16px;
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
    }

    .message.user .message-avatar i {
        color: white;
        font-size: 0.7rem;
    }

    .message-bubble {
        max-width: 85%;
        padding: 0.75rem 1rem;
        border-radius: 14px;
        font-size: 0.8rem;
        line-height: 1.55;
        font-family: 'Inter', system-ui, sans-serif;
    }

    .message.assistant .message-bubble {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(139, 92, 246, 0.15);
        color: #e2e8f0;
        border-radius: 14px 14px 14px 4px;
    }

    .message.user .message-bubble {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.08));
        border: 1px solid rgba(6, 182, 212, 0.2);
        color: #f1f5f9;
        border-radius: 14px 14px 4px 14px;
    }

    .message-bubble pre {
        background: rgba(0, 0, 0, 0.5);
        padding: 1rem;
        border-radius: 10px;
        overflow-x: auto;
        margin: 0.875rem 0;
        border: 1px solid rgba(139, 92, 246, 0.1);
    }

    .message-bubble code {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 0.78rem;
    }

    .message-bubble h3, .message-bubble h4 {
        color: #c4b5fd;
        margin: 1rem 0 0.5rem;
        font-size: 0.95rem;
        font-family: 'Space Grotesk', sans-serif;
    }

    .message-bubble ul, .message-bubble ol {
        margin: 0.5rem 0;
        padding-left: 1.25rem;
    }

    .message-bubble li {
        margin-bottom: 0.35rem;
    }

    /* Loading */
    .tutor-loading {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.4);
        border-radius: 12px;
        border: 1px solid rgba(139, 92, 246, 0.1);
    }

    .loading-dots {
        display: flex;
        gap: 5px;
    }

    .loading-dots span {
        width: 8px;
        height: 8px;
        background: linear-gradient(135deg, #a78bfa, #8b5cf6);
        border-radius: 50%;
        animation: loadingBounce 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes loadingBounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    .loading-text {
        color: #94a3b8;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* ============================================
       QUICK ACTIONS
    ============================================ */
    .tutor-quick-actions {
        padding: 0.75rem 1rem;
        border-top: 1px solid rgba(148, 163, 184, 0.08);
        flex-shrink: 0;
    }

    .actions-label {
        font-size: 0.65rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.35rem;
        padding: 0.625rem 0.5rem;
        background: rgba(30, 41, 59, 0.4);
        border: 1px solid rgba(139, 92, 246, 0.12);
        border-radius: 10px;
        color: #c4b5fd;
        cursor: pointer;
        transition: all 0.25s ease;
    }

    .quick-action:hover:not(:disabled) {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
    }

    .quick-action:disabled {
        opacity: 0.35;
        cursor: not-allowed;
    }

    .quick-action i {
        font-size: 0.95rem;
    }

    .quick-action span {
        font-size: 0.62rem;
        font-weight: 600;
    }

    /* ============================================
       INPUT AREA - Premium
    ============================================ */
    .tutor-input-area {
        padding: 0.875rem 1rem;
        background: linear-gradient(180deg, rgba(30, 41, 59, 0.3), rgba(30, 41, 59, 0.5));
        border-top: 1px solid rgba(139, 92, 246, 0.12);
        flex-shrink: 0;
    }

    /* API Key Setup - Elegant Card */
    .api-key-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .api-key-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: rgba(139, 92, 246, 0.08);
        border: 1px solid rgba(139, 92, 246, 0.15);
        border-radius: 10px;
    }

    .api-key-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .api-key-content h5 {
        margin: 0 0 0.15rem 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: #f1f5f9;
    }

    .api-key-content p {
        margin: 0;
        font-size: 0.7rem;
        color: #94a3b8;
    }

    .api-key-form {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .input-group {
        display: flex;
        gap: 0.5rem;
    }

    .api-key-input {
        flex: 1;
        padding: 0.625rem 0.875rem;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 8px;
        color: #e2e8f0;
        font-size: 0.8rem;
        font-family: 'JetBrains Mono', monospace;
        transition: all 0.25s ease;
    }

    .api-key-input:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.5);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .api-key-save-btn {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.25s ease;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .api-key-save-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .api-key-link {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.72rem;
        color: #a78bfa;
        text-decoration: none;
        padding: 0.5rem;
        background: rgba(139, 92, 246, 0.05);
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .api-key-link:hover {
        background: rgba(139, 92, 246, 0.1);
        color: #c4b5fd;
    }

    /* Chat Input - Premium */
    .chat-input-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .chat-input-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }

    .chat-input-wrapper textarea {
        flex: 1;
        padding: 0.75rem 1rem;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 12px;
        color: #e2e8f0;
        font-size: 0.85rem;
        font-family: 'Inter', system-ui, sans-serif;
        resize: none;
        line-height: 1.5;
        transition: all 0.25s ease;
        min-height: 44px;
        max-height: 120px;
    }

    .chat-input-wrapper textarea:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.5);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .send-btn {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        border: none;
        border-radius: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.25s ease;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
    }

    .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .input-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .model-badge {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.625rem;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 20px;
    }

    .model-badge img {
        width: 12px;
        height: 12px;
    }

    .model-badge span {
        font-size: 0.65rem;
        color: #a78bfa;
        font-weight: 500;
    }

    .settings-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        background: transparent;
        color: #64748b;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.75rem;
    }

    .settings-btn:hover {
        background: rgba(148, 163, 184, 0.1);
        color: #94a3b8;
    }

    /* ============================================
       LIGHT MODE
    ============================================ */
    :global([data-theme="light"]) .ai-tutor-panel {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
        border-left-color: rgba(139, 92, 246, 0.15);
        box-shadow: -8px 0 40px rgba(0, 0, 0, 0.08);
    }

    :global([data-theme="light"]) .tutor-header {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.06), rgba(59, 130, 246, 0.03));
    }

    :global([data-theme="light"]) .tutor-title h3 {
        color: #0f172a;
    }

    :global([data-theme="light"]) .tutor-status {
        color: #64748b;
    }

    :global([data-theme="light"]) .tutor-close {
        background: rgba(241, 245, 249, 0.8);
        border-color: rgba(0, 0, 0, 0.08);
        color: #64748b;
    }

    :global([data-theme="light"]) .tutor-context {
        background: linear-gradient(90deg, rgba(6, 182, 212, 0.06), transparent);
        border-color: rgba(6, 182, 212, 0.1);
    }

    :global([data-theme="light"]) .context-badge {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(6, 182, 212, 0.05));
        border-color: rgba(6, 182, 212, 0.2);
        color: #0891b2;
    }

    :global([data-theme="light"]) .context-subject {
        color: #0f172a;
    }

    :global([data-theme="light"]) .welcome-hero h4 {
        color: #0f172a;
    }

    :global([data-theme="light"]) .welcome-subtitle {
        color: #7c3aed;
    }

    :global([data-theme="light"]) .capability-card {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(139, 92, 246, 0.1);
    }

    :global([data-theme="light"]) .capability-card i {
        color: #7c3aed;
    }

    :global([data-theme="light"]) .capability-card span {
        color: #334155;
    }

    :global([data-theme="light"]) .welcome-hint {
        background: rgba(0, 0, 0, 0.03);
        color: #475569;
    }

    :global([data-theme="light"]) .message.assistant .message-bubble {
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(139, 92, 246, 0.12);
        color: #1e293b;
    }

    :global([data-theme="light"]) .message.user .message-bubble {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.12), rgba(6, 182, 212, 0.05));
        border-color: rgba(6, 182, 212, 0.15);
        color: #0f172a;
    }

    :global([data-theme="light"]) .tutor-loading {
        background: rgba(248, 250, 252, 0.9);
        border-color: rgba(139, 92, 246, 0.1);
    }

    :global([data-theme="light"]) .loading-text {
        color: #475569;
    }

    :global([data-theme="light"]) .quick-action {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(139, 92, 246, 0.1);
        color: #6d28d9;
    }

    :global([data-theme="light"]) .tutor-input-area {
        background: linear-gradient(180deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.9));
        border-color: rgba(0, 0, 0, 0.06);
    }

    :global([data-theme="light"]) .api-key-card {
        background: rgba(139, 92, 246, 0.05);
        border-color: rgba(139, 92, 246, 0.12);
    }

    :global([data-theme="light"]) .api-key-content h5 {
        color: #0f172a;
    }

    :global([data-theme="light"]) .api-key-input,
    :global([data-theme="light"]) .chat-input-wrapper textarea {
        background: white;
        border-color: rgba(0, 0, 0, 0.1);
        color: #0f172a;
    }

    :global([data-theme="light"]) .api-key-link {
        background: rgba(139, 92, 246, 0.03);
        color: #7c3aed;
    }

    :global([data-theme="light"]) .model-badge {
        background: rgba(139, 92, 246, 0.08);
    }

    :global([data-theme="light"]) .model-badge span {
        color: #7c3aed;
    }

    /* ============================================
       RESPONSIVE
    ============================================ */
    @media (max-width: 1200px) {
        .ai-tutor-panel {
            width: 350px;
        }
    }

    @media (max-width: 900px) {
        .ai-tutor-panel {
            width: 100%;
            max-width: 400px;
        }
    }

    @media (max-width: 600px) {
        .ai-tutor-panel {
            width: 100%;
            max-width: 100%;
        }

        .actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .welcome-capabilities {
            grid-template-columns: 1fr;
        }
    }
</style>

<script is:inline>
    // ============================================
    // AI TUTOR SIDE PANEL - JAVASCRIPT
    // Premium Enterprise Design
    // ============================================

    let currentSubject = null;
    let chatHistory = [];
    let tutorInitialized = false;

    function initAITutorPanel() {
        if (tutorInitialized) return;
        tutorInitialized = true;

        const panel = document.getElementById('ai-tutor-panel');
        const closeBtn = document.getElementById('tutor-close');
        const saveKeyBtn = document.getElementById('save-api-key-btn');
        const sendBtn = document.getElementById('send-message-btn');
        const chatInput = document.getElementById('tutor-chat-input');
        const settingsBtn = document.getElementById('settings-btn');
        const quickActions = document.querySelectorAll('.quick-action');

        // Check for saved API key
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) {
            showChatInput();
        }

        // Close panel
        closeBtn?.addEventListener('click', () => {
            panel?.classList.remove('visible');
            currentSubject = null;
            updateQuickActionsState(false);
        });

        // Save API key
        saveKeyBtn?.addEventListener('click', saveApiKey);

        // Send message
        sendBtn?.addEventListener('click', sendMessage);

        // Enter to send
        chatInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Settings button - show API key configuration
        settingsBtn?.addEventListener('click', showApiKeySetup);

        // Quick actions
        quickActions.forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.disabled) {
                    handleQuickAction(btn.dataset.action);
                }
            });
        });

        // Input state - enable/disable send button
        chatInput?.addEventListener('input', () => {
            if (sendBtn) {
                sendBtn.disabled = !chatInput.value.trim();
            }
        });

        // Auto-resize textarea
        chatInput?.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    // Show panel for a subject
    window.showAITutor = function(subjectName, subjectCode) {
        const panel = document.getElementById('ai-tutor-panel');
        const subjectLabel = document.getElementById('tutor-subject-name');
        const welcome = document.getElementById('tutor-welcome');
        const messages = document.getElementById('tutor-messages');

        currentSubject = { name: subjectName, code: subjectCode };
        chatHistory = [];

        // Update subject context
        if (subjectLabel) {
            subjectLabel.textContent = subjectName;
        }

        // Clear messages and show welcome
        if (messages) messages.innerHTML = '';
        if (welcome) welcome.style.display = 'block';

        // Show panel
        panel?.classList.add('visible');
        panel?.classList.remove('minimized');

        // Enable quick actions
        updateQuickActionsState(true);

        // Add initial assistant message
        setTimeout(() => {
            addMessage('assistant', `¡Hola! Soy tu tutor para **${subjectName}**. ¿En qué puedo ayudarte hoy?`);
        }, 500);
    };

    // Hide panel
    window.hideAITutor = function() {
        const panel = document.getElementById('ai-tutor-panel');
        panel?.classList.remove('visible', 'minimized');
        currentSubject = null;
    };

    function showChatInput() {
        const apiKeyContainer = document.getElementById('api-key-container');
        const chatContainer = document.getElementById('chat-input-container');

        if (apiKeyContainer) apiKeyContainer.style.display = 'none';
        if (chatContainer) chatContainer.style.display = 'flex';
    }

    function showApiKeySetup() {
        const apiKeyContainer = document.getElementById('api-key-container');
        const chatContainer = document.getElementById('chat-input-container');
        const apiKeyInput = document.getElementById('gemini-api-key-input');

        if (chatContainer) chatContainer.style.display = 'none';
        if (apiKeyContainer) apiKeyContainer.style.display = 'flex';

        // Pre-fill with masked current key if exists
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey && apiKeyInput) {
            apiKeyInput.value = '';
            apiKeyInput.placeholder = 'Cambia tu API Key o déjalo vacío para mantener la actual...';
        }
    }

    function saveApiKey() {
        const input = document.getElementById('gemini-api-key-input');
        const key = input?.value?.trim();
        const existingKey = localStorage.getItem('gemini_api_key');

        // If no new key but existing key, just go back to chat
        if (!key && existingKey) {
            showChatInput();
            return;
        }

        if (key && key.startsWith('AIza')) {
            localStorage.setItem('gemini_api_key', key);
            showChatInput();
            addMessage('assistant', '¡API Key guardada correctamente! Ya puedes empezar a preguntarme.');
        } else if (key) {
            addMessage('assistant', 'Por favor, ingresa una API Key válida de Gemini. Debe comenzar con "AIza..."');
        }
    }

    function updateQuickActionsState(enabled) {
        const quickActions = document.querySelectorAll('.quick-action');
        quickActions.forEach(btn => {
            btn.disabled = !enabled;
        });
    }

    function handleQuickAction(action) {
        if (!currentSubject) return;

        const prompts = {
            'resume': `Dame un resumen conciso de los conceptos clave de ${currentSubject.name}. Incluye los puntos más importantes que un estudiante debe dominar.`,
            'examples': `Proporciona ejemplos prácticos de código para ${currentSubject.name}. Usa ejemplos del mundo real relevantes para un programador.`,
            'practice': `Genera 3 ejercicios prácticos de ${currentSubject.name} con diferentes niveles de dificultad (básico, intermedio, avanzado). Incluye las respuestas esperadas.`,
            'explain': `Explica de forma simple y clara los fundamentos de ${currentSubject.name}. Usa analogías y ejemplos cotidianos para facilitar la comprensión.`
        };

        const prompt = prompts[action];
        if (prompt) {
            const chatInput = document.getElementById('tutor-chat-input');
            if (chatInput) {
                chatInput.value = prompt;
                sendMessage();
            }
        }
    }

    async function sendMessage() {
        const input = document.getElementById('tutor-chat-input');
        const message = input?.value?.trim();
        const apiKey = localStorage.getItem('gemini_api_key');

        if (!message) return;
        if (!apiKey) {
            addMessage('assistant', 'Por favor, configura tu API Key de Gemini primero.');
            return;
        }

        // Add user message
        addMessage('user', message);
        input.value = '';
        document.getElementById('send-message-btn').disabled = true;

        // Show loading
        showLoading(true);

        try {
            const response = await callGeminiAPI(message, apiKey);
            addMessage('assistant', response);
        } catch (error) {
            console.error('Gemini API Error:', error);
            addMessage('assistant', `Error: ${error.message || 'No se pudo conectar con Gemini. Verifica tu API Key.'}`);
        } finally {
            showLoading(false);
        }
    }

    async function callGeminiAPI(message, apiKey) {
        const subjectContext = currentSubject
            ? `la asignatura "${currentSubject.name}" (código: ${currentSubject.code})`
            : 'programación';

        const systemPrompt = `Eres un tutor IA especializado en ${subjectContext} del programa Analista Programador Computacional de DuocUC, Chile.
Tu objetivo es ayudar a estudiantes a comprender conceptos, resolver ejercicios y prepararse para evaluaciones.
Responde en español de Chile, de forma clara, profesional y pedagógica.
Usa formato Markdown: headers (##), listas (-), código (\`\`\`), negritas (**), etc.
Si el estudiante pregunta algo fuera del tema, gentilmente redirige la conversación.
Mantén respuestas concisas pero completas.`;

        const payload = {
            contents: [
                {
                    parts: [
                        { text: systemPrompt },
                        ...chatHistory.map(msg => ({ text: `${msg.role === 'user' ? 'Usuario' : 'Tutor'}: ${msg.content}` })),
                        { text: `Usuario: ${message}` }
                    ]
                }
            ],
            generationConfig: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 2048,
            }
        };

        // Try multiple models in order of preference (updated Dec 2025)
        // See: https://ai.google.dev/gemini-api/docs/models
        const models = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-2.0-flash-lite'];
        let response = null;
        let lastError = null;

        for (const model of models) {
            try {
                response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (response.ok) {
                    console.log(`Using Gemini model: ${model}`);
                    break;
                }

                lastError = await response.json();
                console.warn(`Model ${model} failed:`, lastError.error?.message);
            } catch (e) {
                lastError = e;
                console.warn(`Model ${model} error:`, e);
            }
        }

        if (!response || !response.ok) {
            throw new Error(lastError?.error?.message || 'No se pudo conectar con Gemini. Verifica tu API Key.');
        }

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No se recibió respuesta.';

        // Update history
        chatHistory.push({ role: 'user', content: message });
        chatHistory.push({ role: 'assistant', content: text });

        // Keep last 10 exchanges
        if (chatHistory.length > 20) {
            chatHistory = chatHistory.slice(-20);
        }

        return text;
    }

    function addMessage(role, content) {
        const messagesContainer = document.getElementById('tutor-messages');
        const welcome = document.getElementById('tutor-welcome');

        if (!messagesContainer) return;

        // Hide welcome
        if (welcome) welcome.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        // Simple markdown to HTML
        let formattedContent = content
            .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\*([^*]+)\*/g, '<em>$1</em>')
            .replace(/^### (.+)$/gm, '<h4>$1</h4>')
            .replace(/^## (.+)$/gm, '<h3>$1</h3>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
            .replace(/\n/g, '<br>');

        const avatarContent = role === 'assistant'
            ? '<img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="AI" />'
            : '<i class="fas fa-user"></i>';

        messageDiv.innerHTML = `
            <div class="message-avatar">${avatarContent}</div>
            <div class="message-bubble">${formattedContent}</div>
        `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showLoading(show) {
        const loading = document.getElementById('tutor-loading');
        if (loading) {
            loading.style.display = show ? 'flex' : 'none';
        }
    }

    function clearChat() {
        const messagesContainer = document.getElementById('tutor-messages');
        const welcome = document.getElementById('tutor-welcome');

        if (messagesContainer) messagesContainer.innerHTML = '';
        if (welcome) welcome.style.display = 'block';

        chatHistory = [];
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initAITutorPanel);
    document.addEventListener('astro:page-load', () => {
        tutorInitialized = false;
        initAITutorPanel();
    });
</script>

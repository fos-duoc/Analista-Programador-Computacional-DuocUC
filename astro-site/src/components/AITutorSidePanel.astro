---
/**
 * AITutorSidePanel.astro
 * Premium AI Tutor Panel - Enterprise-grade design
 * Aparece a la derecha cuando se selecciona una asignatura
 *
 * Redise√±o sofisticado con:
 * - Controles simplificados (solo close)
 * - API Key setup elegante como primer paso de onboarding
 * - Welcome message premium con animaciones
 * - Quick actions contextuales
 * - Chat UI moderno estilo ChatGPT/Claude
 */

const base = import.meta.env.BASE_URL;
---

<!-- AI Tutor Side Panel - Premium Design -->
<aside id="ai-tutor-panel" class="ai-tutor-panel" aria-label="Tutor IA" role="complementary">
    <!-- Premium Header -->
    <header class="tutor-header">
        <div class="tutor-branding">
            <div class="tutor-logo">
                <div class="logo-glow"></div>
                <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="Gemini" />
            </div>
            <div class="tutor-title">
                <h3>Tutor IA</h3>
                <div class="tutor-status">
                    <span class="status-dot"></span>
                    <span>Online</span>
                </div>
            </div>
        </div>
        <!-- TTS Controls -->
        <div class="tts-controls" id="tts-controls">
            <!-- Voice Selector Button -->
            <button class="tts-voice-btn" id="tts-voice-btn" title="Configurar voz">
                <i class="fas fa-microphone-alt"></i>
            </button>
            <!-- Speed Selector -->
            <button class="tts-speed-btn" id="tts-speed-btn" title="Velocidad de lectura">
                <i class="fas fa-tachometer-alt"></i>
                <span id="tts-speed-label">1x</span>
            </button>
            <div class="tts-speed-dropdown" id="tts-speed-dropdown">
                <button class="tts-speed-option" data-speed="0.75">0.75x</button>
                <button class="tts-speed-option active" data-speed="1">1x</button>
                <button class="tts-speed-option" data-speed="1.25">1.25x</button>
                <button class="tts-speed-option" data-speed="1.5">1.5x</button>
                <button class="tts-speed-option" data-speed="1.75">1.75x</button>
                <button class="tts-speed-option" data-speed="2">2x</button>
            </div>
            <button class="tts-stop-btn" id="tts-stop-btn" title="Detener lectura" style="display: none;">
                <i class="fas fa-stop"></i>
            </button>
        </div>
        <button class="tutor-close" id="tutor-close" aria-label="Cerrar panel" title="Cerrar">
            <i class="fas fa-times"></i>
        </button>
    </header>

    <!-- Subject Context Banner (m√°s elegante) -->
    <div class="tutor-context" id="tutor-context">
        <div class="context-badge">
            <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="context-info">
            <span class="context-label">Estudiando</span>
            <span class="context-subject" id="tutor-subject-name">Selecciona una asignatura</span>
        </div>
        <div class="context-indicator">
            <i class="fas fa-circle"></i>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="tutor-body">
        <!-- Premium Welcome Message -->
        <div class="tutor-welcome" id="tutor-welcome">
            <div class="welcome-hero">
                <div class="welcome-avatar">
                    <div class="avatar-ring"></div>
                    <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="AI" />
                </div>
                <h4>Tu Asistente de Estudio Personal</h4>
                <p class="welcome-subtitle">Powered by Google Gemini</p>
            </div>

            <div class="welcome-capabilities">
                <div class="capability-card">
                    <i class="fas fa-brain"></i>
                    <span>Explico conceptos</span>
                </div>
                <div class="capability-card">
                    <i class="fas fa-code"></i>
                    <span>Genero c√≥digo</span>
                </div>
                <div class="capability-card">
                    <i class="fas fa-tasks"></i>
                    <span>Creo ejercicios</span>
                </div>
                <div class="capability-card">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Preparo evaluaciones</span>
                </div>
            </div>

            <p class="welcome-hint">
                <i class="fas fa-hand-pointer"></i>
                Haz clic en una asignatura para comenzar
            </p>
        </div>

        <!-- Chat Messages Container -->
        <div class="tutor-messages" id="tutor-messages">
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Loading Indicator -->
        <div class="tutor-loading" id="tutor-loading" style="display: none;">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="loading-text">Generando respuesta...</span>
        </div>
    </div>

    <!-- Quick Actions (solo visibles cuando hay asignatura) -->
    <div class="tutor-quick-actions" id="tutor-quick-actions">
        <div class="actions-label">Acciones r√°pidas</div>
        <div class="actions-grid">
            <button class="quick-action" data-action="resume" disabled>
                <i class="fas fa-file-alt"></i>
                <span>Resumen</span>
            </button>
            <button class="quick-action" data-action="examples" disabled>
                <i class="fas fa-laptop-code"></i>
                <span>Ejemplos</span>
            </button>
            <button class="quick-action" data-action="practice" disabled>
                <i class="fas fa-pencil-alt"></i>
                <span>Ejercicios</span>
            </button>
            <button class="quick-action" data-action="explain" disabled>
                <i class="fas fa-question-circle"></i>
                <span>Explicar</span>
            </button>
        </div>
    </div>

    <!-- Input Area - Dise√±o Premium -->
    <div class="tutor-input-area">
        <!-- API Key Setup (elegante onboarding) -->
        <div class="api-key-container" id="api-key-container">
            <div class="api-key-card">
                <div class="api-key-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="api-key-content">
                    <h5>Conecta con Gemini</h5>
                    <p>Ingresa tu API Key para activar el tutor</p>
                </div>
            </div>
            <div class="api-key-form">
                <div class="input-group">
                    <input
                        type="password"
                        id="gemini-api-key-input"
                        placeholder="Pega tu API Key aqu√≠..."
                        class="api-key-input"
                    />
                    <button class="api-key-save-btn" id="save-api-key-btn">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-key-link">
                    <i class="fas fa-external-link-alt"></i>
                    Obtener API Key gratis en Google AI Studio
                </a>
            </div>
        </div>

        <!-- Chat Input (estilo premium) -->
        <div class="chat-input-container" id="chat-input-container" style="display: none;">
            <div class="chat-input-wrapper">
                <textarea
                    id="tutor-chat-input"
                    placeholder="Escribe tu pregunta..."
                    rows="2"
                ></textarea>
                <button class="send-btn" id="send-message-btn" disabled>
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
            <div class="input-footer">
                <div class="model-badge">
                    <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="" />
                    <span>Gemini 2.0</span>
                </div>
                <button class="settings-btn" id="settings-btn" title="Configuraci√≥n">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </div>
</aside>

<!-- Voice Settings Modal - Premium Design -->
<div class="tts-modal-overlay" id="tts-modal-overlay">
    <div class="tts-modal" id="tts-modal">
        <div class="tts-modal-header">
            <div class="tts-modal-title">
                <i class="fas fa-microphone-alt"></i>
                <span>Configuraci√≥n de Voz</span>
            </div>
            <button class="tts-modal-close" id="tts-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="tts-modal-body">
            <!-- Engine Selector Tabs -->
            <div class="tts-engine-tabs">
                <button class="tts-engine-tab active" data-engine="puter">
                    <i class="fas fa-robot"></i>
                    <span>Voces IA</span>
                    <span class="engine-badge neural">Neural</span>
                </button>
                <button class="tts-engine-tab" data-engine="browser">
                    <i class="fas fa-globe"></i>
                    <span>Navegador</span>
                    <span class="engine-badge local">Local</span>
                </button>
            </div>

            <!-- Puter AI Voices Section -->
            <div class="tts-engine-content active" id="tts-puter-content">
                <div class="tts-engine-info">
                    <div class="engine-logo">
                        <img src="https://puter.com/favicon.ico" alt="Puter" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%238b5cf6%22><path d=%22M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z%22/></svg>'">
                    </div>
                    <div class="engine-description">
                        <h4>Puter.js - Voces Neurales Gratuitas</h4>
                        <p>Voces de alta calidad similares a Amazon Polly. Sin l√≠mites, sin API key.</p>
                    </div>
                </div>

                <div class="tts-voice-group">
                    <label class="tts-label">Motor de S√≠ntesis</label>
                    <div class="tts-puter-engines">
                        <button class="tts-puter-engine active" data-puter-engine="neural">
                            <i class="fas fa-brain"></i>
                            <span>Neural</span>
                            <small>Natural y fluido</small>
                        </button>
                        <button class="tts-puter-engine" data-puter-engine="generative">
                            <i class="fas fa-magic"></i>
                            <span>Generativo</span>
                            <small>M√°s expresivo</small>
                        </button>
                        <button class="tts-puter-engine" data-puter-engine="standard">
                            <i class="fas fa-volume-up"></i>
                            <span>Est√°ndar</span>
                            <small>R√°pido</small>
                        </button>
                    </div>
                </div>

                <div class="tts-voice-group">
                    <label class="tts-label">Idioma</label>
                    <select class="tts-select" id="tts-puter-lang">
                        <optgroup label="üá™üá∏ Espa√±ol">
                            <option value="es-ES">Espa√±a - Luc√≠a, Sergio, Conchita</option>
                            <option value="es-MX" selected>M√©xico - Mia, Andr√©s</option>
                            <option value="es-US">US Spanish - Lupe, Pedro, Pen√©lope</option>
                        </optgroup>
                        <optgroup label="üá®üá≥ ‰∏≠Êñá">
                            <option value="cmn-CN">ÊôÆÈÄöËØù (Mandarin) - Zhiyu</option>
                            <option value="yue-CN">Á≤§ËØ≠ (Cantonese) - Hiujin</option>
                        </optgroup>
                        <optgroup label="üåç Other Languages">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="pt-BR">Portugu√™s (Brasil)</option>
                            <option value="fr-FR">Fran√ßais</option>
                            <option value="de-DE">Deutsch</option>
                            <option value="it-IT">Italiano</option>
                            <option value="ja-JP">Êó•Êú¨Ë™û (Japanese)</option>
                            <option value="ko-KR">ÌïúÍµ≠Ïñ¥ (Korean)</option>
                        </optgroup>
                    </select>
                </div>

                <div class="tts-preview-section">
                    <button class="tts-preview-btn" id="tts-puter-preview">
                        <i class="fas fa-play"></i>
                        <span>Probar voz</span>
                    </button>
                    <span class="tts-preview-text">Hola, soy tu asistente de estudio.</span>
                </div>
            </div>

            <!-- Browser Voices Section -->
            <div class="tts-engine-content" id="tts-browser-content">
                <div class="tts-engine-info browser">
                    <div class="engine-logo">
                        <i class="fas fa-chrome"></i>
                    </div>
                    <div class="engine-description">
                        <h4>Voces del Navegador</h4>
                        <p>Voces integradas en tu sistema. Calidad variable seg√∫n el navegador.</p>
                    </div>
                </div>

                <div class="tts-voice-group">
                    <label class="tts-label">Voces en Espa√±ol</label>
                    <div class="tts-browser-voices" id="tts-browser-voices-es">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <div class="tts-voice-group">
                    <label class="tts-label">Otras Voces</label>
                    <div class="tts-browser-voices collapsed" id="tts-browser-voices-other">
                        <!-- Se llena din√°micamente -->
                    </div>
                    <button class="tts-show-more" id="tts-show-more-voices">
                        <i class="fas fa-chevron-down"></i>
                        <span>Mostrar m√°s voces</span>
                    </button>
                </div>

                <div class="tts-preview-section">
                    <button class="tts-preview-btn" id="tts-browser-preview">
                        <i class="fas fa-play"></i>
                        <span>Probar voz</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="tts-modal-footer">
            <div class="tts-current-engine">
                <span class="tts-current-label">Motor activo:</span>
                <span class="tts-current-value" id="tts-current-engine">Puter Neural</span>
            </div>
            <button class="tts-save-btn" id="tts-save-settings">
                <i class="fas fa-check"></i>
                <span>Guardar</span>
            </button>
        </div>
    </div>
</div>

<style>
    /* ============================================
       AI TUTOR SIDE PANEL - Premium Enterprise Design
       Sophisticated, useful, and elegant
       Responsive sizing with smooth transitions
    ============================================ */

    .ai-tutor-panel {
        position: fixed;
        top: 70px;
        right: 0;
        width: 382px;
        height: calc(100vh - 70px);
        background: linear-gradient(180deg, #050810 0%, #0a0f1a 30%, #111827 70%, #0f172a 100%);
        border-left: 1px solid rgba(139, 92, 246, 0.25);
        display: flex;
        flex-direction: column;
        z-index: 1002;
        transform: translateX(100%);
        visibility: hidden; /* Prevent flash on page load */
        /* Animation: 250ms (faster than 500ms per Material Design 3 guidelines) */
        transition: transform 0.25s cubic-bezier(0.2, 0, 0, 1), visibility 0.25s, width 0.2s ease;
        box-shadow: -12px 0 48px rgba(0, 0, 0, 0.5), -4px 0 16px rgba(139, 92, 246, 0.05);
        font-size: 0.89rem;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .ai-tutor-panel.visible {
        transform: translateX(0);
        visibility: visible;
    }

    /* ============================================
       PREMIUM HEADER - Refined & Sophisticated
    ============================================ */
    .tutor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0.9rem;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(59, 130, 246, 0.05));
        border-bottom: 1px solid rgba(139, 92, 246, 0.15);
        flex-shrink: 0;
    }

    .tutor-branding {
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .tutor-logo {
        position: relative;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .logo-glow {
        position: absolute;
        inset: -4px;
        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
        border-radius: 10px;
        opacity: 0.3;
        filter: blur(8px);
        animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.1); }
    }

    .tutor-logo img {
        position: relative;
        width: 22px;
        height: 22px;
        z-index: 1;
        filter: drop-shadow(0 2px 4px rgba(139, 92, 246, 0.3));
    }

    .tutor-title h3 {
        margin: 0;
        font-size: 0.92rem;
        font-weight: 700;
        font-family: 'Sora', sans-serif;
        color: #f8fafc;
        letter-spacing: -0.025em;
    }

    .tutor-status {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.65rem;
        color: #94a3b8;
    }

    .status-dot {
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: statusPulse 2s infinite;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    @keyframes statusPulse {
        0%, 100% { opacity: 1; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
        50% { opacity: 0.7; box-shadow: 0 0 12px rgba(34, 197, 94, 0.8); }
    }

    /* ============================================
       TTS CONTROLS - Text-to-Speech
       Premium voice reading experience
    ============================================ */
    .tts-controls {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-right: 0.5rem;
        position: relative;
    }

    .tts-speed-btn {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.3rem 0.5rem;
        border-radius: 6px;
        border: 1px solid rgba(139, 92, 246, 0.25);
        background: rgba(139, 92, 246, 0.1);
        color: #c4b5fd;
        cursor: pointer;
        font-size: 0.6rem;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .tts-speed-btn:hover {
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.4);
        color: #e0d4ff;
    }

    .tts-speed-btn i {
        font-size: 0.58rem;
    }

    .tts-speed-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        right: 0;
        background: linear-gradient(135deg, #1e293b, #0f172a);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 8px;
        padding: 0.3rem;
        display: none;
        flex-direction: column;
        gap: 0.2rem;
        z-index: 100;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 4px 12px rgba(139, 92, 246, 0.1);
        min-width: 70px;
    }

    .tts-speed-dropdown.visible {
        display: flex;
    }

    .tts-speed-option {
        padding: 0.35rem 0.5rem;
        border: none;
        border-radius: 5px;
        background: transparent;
        color: #94a3b8;
        font-size: 0.62rem;
        font-family: 'JetBrains Mono', monospace;
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: center;
    }

    .tts-speed-option:hover {
        background: rgba(139, 92, 246, 0.15);
        color: #c4b5fd;
    }

    .tts-speed-option.active {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(6, 182, 212, 0.15));
        color: #e0d4ff;
        font-weight: 600;
    }

    /* Voice selector button */
    .tts-voice-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 1px solid rgba(6, 182, 212, 0.25);
        background: rgba(6, 182, 212, 0.1);
        color: #67e8f9;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.7rem;
    }

    .tts-voice-btn:hover {
        background: rgba(6, 182, 212, 0.2);
        border-color: rgba(6, 182, 212, 0.4);
        color: #a5f3fc;
    }

    .tts-voice-btn.has-voice {
        border-color: rgba(34, 197, 94, 0.4);
        background: rgba(34, 197, 94, 0.12);
        color: #86efac;
    }

    .tts-voice-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        background: linear-gradient(135deg, #1e293b, #0f172a);
        border: 1px solid rgba(6, 182, 212, 0.3);
        border-radius: 10px;
        padding: 0;
        display: none;
        flex-direction: column;
        z-index: 100;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 4px 12px rgba(6, 182, 212, 0.1);
        min-width: 200px;
        max-width: 280px;
        overflow: hidden;
    }

    .tts-voice-dropdown.visible {
        display: flex;
    }

    .tts-voice-header {
        padding: 0.5rem 0.7rem;
        font-size: 0.6rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        background: rgba(15, 23, 42, 0.5);
    }

    .tts-voice-list {
        max-height: 200px;
        overflow-y: auto;
        padding: 0.3rem;
    }

    .tts-voice-list::-webkit-scrollbar {
        width: 4px;
    }

    .tts-voice-list::-webkit-scrollbar-thumb {
        background: rgba(6, 182, 212, 0.3);
        border-radius: 2px;
    }

    .tts-voice-option {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
        padding: 0.45rem 0.6rem;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: #e2e8f0;
        font-size: 0.68rem;
        cursor: pointer;
        transition: all 0.15s ease;
        text-align: left;
        width: 100%;
    }

    .tts-voice-option:hover {
        background: rgba(6, 182, 212, 0.12);
    }

    .tts-voice-option.active {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(139, 92, 246, 0.1));
        border-left: 2px solid #22d3ee;
    }

    .tts-voice-option .voice-name {
        font-weight: 600;
        color: #f1f5f9;
    }

    .tts-voice-option .voice-lang {
        font-size: 0.55rem;
        color: #64748b;
        font-family: 'JetBrains Mono', monospace;
    }

    .tts-voice-option.active .voice-lang {
        color: #67e8f9;
    }

    .tts-stop-btn {
        width: 26px;
        height: 26px;
        border-radius: 6px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.58rem;
        animation: ttsStopPulse 1.5s ease-in-out infinite;
    }

    .tts-stop-btn:hover {
        background: rgba(239, 68, 68, 0.25);
        border-color: rgba(239, 68, 68, 0.5);
        transform: scale(1.05);
    }

    @keyframes ttsStopPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.3); }
        50% { box-shadow: 0 0 8px 2px rgba(239, 68, 68, 0.2); }
    }

    /* TTS Speaker button on messages */
    .tts-speak-btn {
        position: absolute;
        top: 0.4rem;
        right: 0.4rem;
        width: 24px;
        height: 24px;
        border-radius: 5px;
        border: 1px solid rgba(139, 92, 246, 0.2);
        background: rgba(30, 41, 59, 0.6);
        color: #94a3b8;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.58rem;
        opacity: 0;
        z-index: 5;
    }

    .message:hover .tts-speak-btn {
        opacity: 1;
    }

    .tts-speak-btn:hover {
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.4);
        color: #c4b5fd;
        transform: scale(1.1);
    }

    .tts-speak-btn.speaking {
        opacity: 1;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(6, 182, 212, 0.15));
        border-color: rgba(34, 197, 94, 0.4);
        color: #4ade80;
        animation: ttsSpeaking 1s ease-in-out infinite;
    }

    .tts-speak-btn.paused {
        opacity: 1;
        background: rgba(251, 191, 36, 0.15);
        border-color: rgba(251, 191, 36, 0.35);
        color: #fbbf24;
    }

    @keyframes ttsSpeaking {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.08); }
    }

    /* Visual feedback - Message being read */
    .message.tts-reading .message-bubble {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(6, 182, 212, 0.08)) !important;
        border-color: rgba(139, 92, 246, 0.35) !important;
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.15), 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }

    /* Audio visualizer wave effect */
    .tts-wave {
        display: flex;
        align-items: center;
        gap: 2px;
        height: 12px;
        margin-left: 0.3rem;
    }

    .tts-wave span {
        width: 2px;
        height: 100%;
        background: currentColor;
        border-radius: 1px;
        animation: ttsWave 0.8s ease-in-out infinite;
    }

    .tts-wave span:nth-child(1) { animation-delay: 0s; height: 40%; }
    .tts-wave span:nth-child(2) { animation-delay: 0.1s; height: 70%; }
    .tts-wave span:nth-child(3) { animation-delay: 0.2s; height: 100%; }
    .tts-wave span:nth-child(4) { animation-delay: 0.3s; height: 70%; }
    .tts-wave span:nth-child(5) { animation-delay: 0.4s; height: 40%; }

    @keyframes ttsWave {
        0%, 100% { transform: scaleY(0.4); }
        50% { transform: scaleY(1); }
    }

    /* ============================================
       TTS VOICE MODAL - Premium Design
       Sophisticated voice configuration
    ============================================ */
    .tts-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .tts-modal-overlay.visible {
        display: flex;
    }

    .tts-modal {
        background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 16px;
        width: 100%;
        max-width: 420px;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 80px rgba(139, 92, 246, 0.1);
        animation: modalSlideIn 0.25s ease;
    }

    @keyframes modalSlideIn {
        from { opacity: 0; transform: scale(0.95) translateY(-10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .tts-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.2rem;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.08));
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
    }

    .tts-modal-title {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        color: #f8fafc;
        font-size: 1rem;
        font-weight: 700;
        font-family: 'Sora', sans-serif;
    }

    .tts-modal-title i {
        color: #a78bfa;
        font-size: 1.1rem;
    }

    .tts-modal-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(30, 41, 59, 0.5);
        color: #94a3b8;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .tts-modal-close:hover {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.3);
        color: #f87171;
    }

    .tts-modal-body {
        padding: 1rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .tts-engine-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .tts-engine-tab {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.75rem 0.5rem;
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 10px;
        background: rgba(30, 41, 59, 0.3);
        color: #94a3b8;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: 'Inter', sans-serif;
    }

    .tts-engine-tab:hover {
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.3);
    }

    .tts-engine-tab.active {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.1));
        border-color: rgba(139, 92, 246, 0.5);
        color: #e0d4ff;
    }

    .tts-engine-tab i {
        font-size: 1.2rem;
    }

    .tts-engine-tab span:not(.engine-badge) {
        font-size: 0.75rem;
        font-weight: 600;
    }

    .engine-badge {
        font-size: 0.55rem;
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .engine-badge.neural {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
    }

    .engine-badge.local {
        background: rgba(148, 163, 184, 0.2);
        color: #94a3b8;
    }

    .tts-engine-content {
        display: none;
    }

    .tts-engine-content.active {
        display: block;
    }

    .tts-engine-info {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.75rem;
        background: rgba(139, 92, 246, 0.08);
        border-radius: 10px;
        border: 1px solid rgba(139, 92, 246, 0.15);
        margin-bottom: 1rem;
    }

    .tts-engine-info.browser {
        background: rgba(59, 130, 246, 0.08);
        border-color: rgba(59, 130, 246, 0.15);
    }

    .engine-logo {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.1));
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .engine-logo img {
        width: 24px;
        height: 24px;
        border-radius: 4px;
    }

    .engine-logo i {
        font-size: 1.2rem;
        color: #60a5fa;
    }

    .engine-description h4 {
        margin: 0 0 0.2rem 0;
        font-size: 0.8rem;
        color: #e2e8f0;
        font-weight: 600;
    }

    .engine-description p {
        margin: 0;
        font-size: 0.68rem;
        color: #94a3b8;
        line-height: 1.4;
    }

    .tts-voice-group {
        margin-bottom: 0.9rem;
    }

    .tts-label {
        display: block;
        font-size: 0.65rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .tts-puter-engines {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.4rem;
    }

    .tts-puter-engine {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
        padding: 0.6rem 0.4rem;
        border: 1px solid rgba(148, 163, 184, 0.12);
        border-radius: 8px;
        background: rgba(30, 41, 59, 0.3);
        color: #94a3b8;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .tts-puter-engine:hover {
        background: rgba(139, 92, 246, 0.12);
        border-color: rgba(139, 92, 246, 0.3);
    }

    .tts-puter-engine.active {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(6, 182, 212, 0.1));
        border-color: rgba(34, 197, 94, 0.4);
        color: #86efac;
    }

    .tts-puter-engine i {
        font-size: 1rem;
    }

    .tts-puter-engine span {
        font-size: 0.7rem;
        font-weight: 600;
    }

    .tts-puter-engine small {
        font-size: 0.55rem;
        color: #64748b;
    }

    .tts-puter-engine.active small {
        color: #4ade80;
    }

    .tts-select {
        width: 100%;
        padding: 0.55rem 0.75rem;
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 8px;
        background: rgba(30, 41, 59, 0.5);
        color: #e2e8f0;
        font-size: 0.78rem;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .tts-select:hover, .tts-select:focus {
        border-color: rgba(139, 92, 246, 0.4);
        outline: none;
    }

    .tts-browser-voices {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        max-height: 150px;
        overflow-y: auto;
        padding-right: 0.25rem;
    }

    .tts-browser-voices.collapsed {
        max-height: 0;
        overflow: hidden;
    }

    .tts-browser-voice {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.45rem 0.6rem;
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 6px;
        background: rgba(30, 41, 59, 0.3);
        color: #cbd5e1;
        cursor: pointer;
        transition: all 0.15s ease;
        font-size: 0.72rem;
    }

    .tts-browser-voice:hover {
        background: rgba(59, 130, 246, 0.12);
        border-color: rgba(59, 130, 246, 0.3);
    }

    .tts-browser-voice.active {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(6, 182, 212, 0.1));
        border-color: rgba(34, 197, 94, 0.4);
        color: #86efac;
    }

    .tts-browser-voice .voice-quality {
        font-size: 0.5rem;
        color: #fbbf24;
        margin-left: auto;
    }

    .tts-show-more {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        width: 100%;
        padding: 0.45rem;
        margin-top: 0.4rem;
        border: 1px dashed rgba(148, 163, 184, 0.2);
        border-radius: 6px;
        background: transparent;
        color: #64748b;
        font-size: 0.68rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .tts-show-more:hover {
        border-color: rgba(139, 92, 246, 0.3);
        color: #a78bfa;
    }

    .tts-show-more.expanded i {
        transform: rotate(180deg);
    }

    .tts-preview-section {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.65rem;
        background: rgba(30, 41, 59, 0.4);
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.08);
    }

    .tts-preview-btn {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.5rem 0.9rem;
        border: 1px solid rgba(34, 197, 94, 0.35);
        border-radius: 6px;
        background: rgba(34, 197, 94, 0.12);
        color: #4ade80;
        font-size: 0.72rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .tts-preview-btn:hover {
        background: rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.5);
        transform: scale(1.02);
    }

    .tts-preview-btn.playing {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.35);
        color: #f87171;
    }

    .tts-preview-btn.playing i::before {
        content: "\f04d";
    }

    .tts-preview-text {
        font-size: 0.68rem;
        color: #64748b;
        font-style: italic;
    }

    .tts-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1.2rem;
        background: rgba(15, 23, 42, 0.6);
        border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .tts-current-engine {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.7rem;
    }

    .tts-current-label {
        color: #64748b;
    }

    .tts-current-value {
        color: #a78bfa;
        font-weight: 600;
    }

    .tts-save-btn {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.55rem 1rem;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        font-size: 0.78rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .tts-save-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }

    /* Light mode for modal */
    :global([data-theme="light"]) .tts-modal-overlay {
        background: rgba(255, 255, 255, 0.8);
    }

    :global([data-theme="light"]) .tts-modal {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
        border-color: rgba(139, 92, 246, 0.2);
    }

    :global([data-theme="light"]) .tts-modal-header {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(59, 130, 246, 0.04));
    }

    :global([data-theme="light"]) .tts-modal-title {
        color: #1e293b;
    }

    :global([data-theme="light"]) .tts-engine-tab {
        background: rgba(241, 245, 249, 0.8);
        border-color: rgba(148, 163, 184, 0.2);
        color: #64748b;
    }

    :global([data-theme="light"]) .tts-engine-tab.active {
        background: rgba(139, 92, 246, 0.1);
        color: #7c3aed;
    }

    :global([data-theme="light"]) .tts-puter-engine,
    :global([data-theme="light"]) .tts-browser-voice {
        background: rgba(241, 245, 249, 0.8);
        color: #475569;
    }

    :global([data-theme="light"]) .tts-select {
        background: #ffffff;
        color: #334155;
        border-color: rgba(148, 163, 184, 0.3);
    }

    .tutor-close {
        width: 28px;
        height: 28px;
        border-radius: 7px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        background: rgba(30, 41, 59, 0.4);
        color: #94a3b8;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s ease;
        font-size: 0.72rem;
    }

    .tutor-close:hover {
        background: rgba(239, 68, 68, 0.18);
        border-color: rgba(239, 68, 68, 0.35);
        color: #f87171;
        transform: rotate(90deg);
    }

    /* ============================================
       CONTEXT BANNER - Refined & Elegant
    ============================================ */
    .tutor-context {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.55rem 0.9rem;
        background: linear-gradient(90deg, rgba(6, 182, 212, 0.08), transparent);
        border-bottom: 1px solid rgba(6, 182, 212, 0.1);
        flex-shrink: 0;
    }

    .context-badge {
        width: 26px;
        height: 26px;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.05));
        border: 1px solid rgba(6, 182, 212, 0.25);
        border-radius: 7px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #22d3ee;
        font-size: 0.68rem;
    }

    .context-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .context-label {
        font-size: 0.55rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        font-weight: 500;
    }

    .context-subject {
        font-size: 0.78rem;
        font-weight: 600;
        color: #f1f5f9;
        font-family: 'Space Grotesk', sans-serif;
        letter-spacing: -0.015em;
    }

    .context-indicator {
        color: #22c55e;
        font-size: 0.4rem;
        animation: contextPulse 2s infinite;
    }

    @keyframes contextPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    /* ============================================
       BODY / CHAT AREA - Premium
       Includes gradient scrim for scroll indicator
    ============================================ */
    .tutor-body {
        flex: 1;
        overflow-y: auto;
        padding: 0.75rem 0.9rem;
        scrollbar-width: thin;
        scrollbar-color: rgba(139, 92, 246, 0.25) transparent;
        position: relative;
    }

    .tutor-body::-webkit-scrollbar {
        width: 6px;
    }

    .tutor-body::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.2));
        border-radius: 3px;
    }

    /* Gradient scrim at bottom - indicates more content */
    .tutor-body::after {
        content: '';
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        height: 32px;
        background: linear-gradient(to top, rgba(17, 24, 39, 0.95), transparent);
        pointer-events: none;
        z-index: 1;
        display: block;
        margin-top: -32px;
    }

    /* Premium Welcome Message - Refined */
    .tutor-welcome {
        padding: 0.5rem;
    }

    .welcome-hero {
        text-align: center;
        margin-bottom: 1rem;
    }

    .welcome-avatar {
        position: relative;
        width: 50px;
        height: 50px;
        margin: 0 auto 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatar-ring {
        position: absolute;
        inset: -3px;
        border: 2px solid transparent;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6, #3b82f6) border-box;
        -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        animation: ringRotate 4s linear infinite;
    }

    @keyframes ringRotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .welcome-avatar img {
        width: 28px;
        height: 28px;
        filter: drop-shadow(0 2px 10px rgba(139, 92, 246, 0.3));
    }

    .welcome-hero h4 {
        font-family: 'Sora', sans-serif;
        font-size: 0.95rem;
        font-weight: 700;
        color: #f8fafc;
        margin: 0 0 0.2rem 0;
        letter-spacing: -0.025em;
    }

    .welcome-subtitle {
        font-size: 0.68rem;
        color: #a78bfa;
        font-weight: 500;
        margin: 0;
    }

    .welcome-capabilities {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.45rem;
        margin-bottom: 1rem;
    }

    .capability-card {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.5rem 0.6rem;
        background: rgba(30, 41, 59, 0.4);
        border: 1px solid rgba(139, 92, 246, 0.12);
        border-radius: 8px;
        transition: all 0.25s ease;
    }

    .capability-card:hover {
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.12);
    }

    .capability-card i {
        font-size: 0.75rem;
        color: #a78bfa;
    }

    .capability-card span {
        font-size: 0.68rem;
        color: #e2e8f0;
        font-weight: 500;
    }

    .welcome-hint {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        font-size: 0.68rem;
        color: #64748b;
        padding: 0.6rem;
        background: rgba(100, 116, 139, 0.08);
        border-radius: 8px;
        margin: 0;
    }

    .welcome-hint i {
        color: #a78bfa;
        animation: pointBounce 1.5s ease-in-out infinite;
        font-size: 0.72rem;
    }

    @keyframes pointBounce {
        0%, 100% { transform: translateX(0); }
        50% { transform: translateX(4px); }
    }

    /* Chat Messages - Premium */
    .tutor-messages {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
    }

    .message {
        display: flex;
        gap: 0.5rem;
        animation: messageSlide 0.35s ease;
        max-width: 90%;
        position: relative;
    }

    @keyframes messageSlide {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
        flex-direction: row-reverse;
        align-self: flex-end;
        margin-left: auto;
        max-width: 85%;
    }

    .message.assistant {
        align-self: flex-start;
        margin-right: auto;
        max-width: 92%;
    }

    .message-avatar {
        width: 26px;
        height: 26px;
        border-radius: 7px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .message.assistant .message-avatar {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
    }

    .message.assistant .message-avatar img {
        width: 14px;
        height: 14px;
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        box-shadow: 0 2px 6px rgba(6, 182, 212, 0.3);
    }

    .message.user .message-avatar i {
        color: white;
        font-size: 0.62rem;
    }

    .message-bubble {
        max-width: 100%;
        padding: 0.7rem 0.9rem;
        border-radius: 10px;
        font-size: 0.78rem;
        line-height: 1.75;
        font-family: 'Merriweather', 'Georgia', 'Cambria', serif;
        letter-spacing: 0.01em;
        font-weight: 400;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
    }

    .message.assistant .message-bubble {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(30, 41, 59, 0.4));
        border: 1px solid rgba(139, 92, 246, 0.18);
        color: #e2e8f0;
        border-radius: 12px 12px 12px 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }

    /* Prominent greeting state - visible for 8 seconds on first open */
    .message.greeting-prominent {
        animation: greetingPulse 2s ease-in-out infinite;
    }

    .message.greeting-prominent .message-bubble {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(6, 182, 212, 0.15));
        border: 1px solid rgba(139, 92, 246, 0.35);
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.25), 0 0 40px rgba(6, 182, 212, 0.1);
        transform: scale(1.02);
        transition: all 0.5s ease;
    }

    @keyframes greetingPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.92; }
    }

    .message.user .message-bubble {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.22), rgba(6, 182, 212, 0.1));
        border: 1px solid rgba(6, 182, 212, 0.25);
        color: #f1f5f9;
        border-radius: 12px 12px 4px 12px;
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.1);
    }

    /* ============================================
       ENHANCED MARKDOWN RENDERING STYLES
       Premium typography for AI responses
       VSCode-inspired code blocks
       Study-Focused hierarchy
    ============================================ */

    /* =============================================
       CODE BLOCKS - VSCode Dark+ Theme Inspired
       Premium developer experience
    ============================================= */
    .message-bubble .code-block {
        position: relative;
        margin: 0.75rem 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow:
            0 4px 12px rgba(0, 0, 0, 0.25),
            0 2px 4px rgba(0, 0, 0, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }

    /* VSCode-style title bar */
    .message-bubble .code-block .code-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.4rem 0.75rem;
        background: linear-gradient(180deg, #2d2d30 0%, #252526 100%);
        border-bottom: 1px solid #3c3c3c;
    }

    .message-bubble .code-block .code-lang {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.18rem 0.5rem;
        background: rgba(139, 92, 246, 0.15);
        color: #c4b5fd;
        font-size: 0.58rem;
        font-family: 'JetBrains Mono', monospace;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-weight: 600;
        border-radius: 4px;
        border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .message-bubble .code-block .code-lang::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: linear-gradient(135deg, #a78bfa, #8b5cf6);
        box-shadow: 0 0 4px rgba(139, 92, 246, 0.4);
    }

    /* Copy button */
    .message-bubble .code-block .code-copy {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.2rem 0.45rem;
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 4px;
        color: #858585;
        font-size: 0.52rem;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .message-bubble .code-block .code-copy:hover {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.3);
        color: #c4b5fd;
    }

    .message-bubble .code-block .code-copy.copied {
        background: rgba(34, 197, 94, 0.15);
        border-color: rgba(34, 197, 94, 0.3);
        color: #4ade80;
    }

    /* Code content area */
    .message-bubble pre {
        background: linear-gradient(180deg, #1e1e1e 0%, #1a1a1a 100%);
        padding: 0.85rem 1rem;
        margin: 0;
        overflow-x: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(139, 92, 246, 0.3) transparent;
    }

    .message-bubble pre::-webkit-scrollbar {
        height: 6px;
    }

    .message-bubble pre::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.3);
        border-radius: 3px;
    }

    .message-bubble code {
        font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
        font-size: 0.68rem;
        line-height: 1.65;
        color: #d4d4d4;
        font-feature-settings: 'liga' 1, 'calt' 1;
    }

    /* Line numbers effect via gradient */
    .message-bubble pre code {
        display: block;
        padding-left: 0.5rem;
        border-left: 2px solid rgba(139, 92, 246, 0.2);
    }

    /* Inline code - refined */
    .message-bubble .inline-code {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(139, 92, 246, 0.08));
        color: #e0b0ff;
        padding: 0.15rem 0.4rem;
        border-radius: 5px;
        font-size: 0.65rem;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
        border: 1px solid rgba(139, 92, 246, 0.15);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* =============================================
       HEADERS - Study-Focused Typography
       Clear visual hierarchy for learning
    ============================================= */
    .message-bubble .md-h2 {
        color: #f1f5f9;
        margin: 0.9rem 0 0.45rem;
        font-size: 0.92rem;
        font-family: 'Sora', 'Space Grotesk', sans-serif;
        font-weight: 700;
        letter-spacing: -0.025em;
        padding-bottom: 0.35rem;
        border-bottom: 2px solid linear-gradient(90deg, #8b5cf6, #06b6d4);
        background: linear-gradient(135deg, #f8fafc 0%, #c4b5fd 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .message-bubble .md-h3 {
        color: #e0e7ff;
        margin: 0.8rem 0 0.4rem;
        font-size: 0.85rem;
        font-family: 'Sora', 'Space Grotesk', sans-serif;
        font-weight: 700;
        letter-spacing: -0.02em;
        padding-bottom: 0.3rem;
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .message-bubble .md-h3::before {
        content: '';
        width: 4px;
        height: 0.9em;
        background: linear-gradient(180deg, #8b5cf6, #06b6d4);
        border-radius: 2px;
    }

    .message-bubble .md-h4 {
        color: #c4b5fd;
        margin: 0.65rem 0 0.3rem;
        font-size: 0.78rem;
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        letter-spacing: -0.015em;
        padding-left: 0.5rem;
        border-left: 3px solid rgba(139, 92, 246, 0.4);
    }

    .message-bubble .md-h5 {
        color: #94a3b8;
        margin: 0.5rem 0 0.25rem;
        font-size: 0.68rem;
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.15rem 0.4rem;
        background: rgba(148, 163, 184, 0.08);
        border-radius: 3px;
        display: inline-block;
    }

    .message-bubble .md-h6 {
        color: #64748b;
        margin: 0.4rem 0 0.2rem;
        font-size: 0.62rem;
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-style: italic;
    }

    /* =============================================
       LISTS - Enhanced Study-Focused (Compact)
    ============================================= */
    .message-bubble .md-ul {
        margin: 0.35rem 0;
        padding-left: 0;
        list-style: none;
    }

    .message-bubble .md-ul li.bullet {
        position: relative;
        padding: 0.2rem 0.35rem 0.2rem 1.1rem;
        margin-bottom: 0.25rem;
        line-height: 1.5;
        background: rgba(30, 41, 59, 0.2);
        border-radius: 5px;
        transition: background 0.15s ease;
        font-size: 0.7rem;
    }

    .message-bubble .md-ul li.bullet:hover {
        background: rgba(30, 41, 59, 0.35);
    }

    .message-bubble .md-ul li.bullet::before {
        content: '‚Ä∫';
        position: absolute;
        left: 0.4rem;
        color: #22d3ee;
        font-weight: 700;
        font-size: 0.85rem;
    }

    /* Ordered lists with numbered badges (Compact) */
    .message-bubble .md-ol {
        margin: 0.35rem 0;
        padding-left: 0;
        list-style: none;
        counter-reset: item;
    }

    .message-bubble .md-ol li.numbered {
        position: relative;
        padding: 0.22rem 0.35rem 0.22rem 1.6rem;
        margin-bottom: 0.28rem;
        line-height: 1.5;
        background: rgba(30, 41, 59, 0.2);
        border-radius: 5px;
        counter-increment: item;
        transition: background 0.15s ease;
        font-size: 0.7rem;
    }

    .message-bubble .md-ol li.numbered:hover {
        background: rgba(30, 41, 59, 0.35);
    }

    .message-bubble .md-ol li.numbered::before {
        content: counter(item);
        position: absolute;
        left: 0.35rem;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.25), rgba(6, 182, 212, 0.1));
        border: 1px solid rgba(6, 182, 212, 0.3);
        border-radius: 5px;
        color: #22d3ee;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.58rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* =============================================
       BLOCKQUOTES - Premium Callout Style (Compact)
    ============================================= */
    .message-bubble .md-quote {
        margin: 0.4rem 0;
        padding: 0.45rem 0.65rem;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), rgba(6, 182, 212, 0.03));
        border-left: 3px solid #22d3ee;
        border-radius: 0 6px 6px 0;
        color: #94a3b8;
        font-style: italic;
        font-size: 0.7rem;
        line-height: 1.5;
        position: relative;
    }

    .message-bubble .md-quote::before {
        content: '"';
        position: absolute;
        top: -0.2rem;
        left: 0.5rem;
        font-size: 1.5rem;
        color: rgba(34, 211, 238, 0.3);
        font-family: Georgia, serif;
    }

    /* =============================================
       HORIZONTAL RULE
    ============================================= */
    .message-bubble .md-hr {
        margin: 0.75rem 0;
        border: none;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.4), rgba(6, 182, 212, 0.4), transparent);
    }

    /* =============================================
       LINKS - Premium Interactive
    ============================================= */
    .message-bubble .md-link {
        color: #22d3ee;
        text-decoration: none;
        font-weight: 500;
        padding-bottom: 1px;
        border-bottom: 1px dashed rgba(34, 211, 238, 0.4);
        transition: all 0.2s ease;
    }

    .message-bubble .md-link:hover {
        color: #67e8f9;
        border-bottom-style: solid;
        border-bottom-color: rgba(34, 211, 238, 0.8);
    }

    .message-bubble .md-link::after {
        content: ' ‚Üó';
        font-size: 0.6em;
        opacity: 0.6;
    }

    /* =============================================
       TEXT EMPHASIS - Academic Typography
    ============================================= */
    .message-bubble strong {
        color: #f8fafc;
        font-weight: 700;
        font-family: 'Inter', 'Helvetica Neue', sans-serif;
        background: linear-gradient(180deg, transparent 55%, rgba(6, 182, 212, 0.25) 55%);
        padding: 0.05rem 0.2rem;
        border-radius: 2px;
    }

    .message-bubble em {
        color: #d4d0f9;
        font-style: italic;
        font-weight: 500;
        letter-spacing: 0.02em;
    }

    .message-bubble del {
        color: #64748b;
        text-decoration: line-through;
        opacity: 0.7;
    }

    /* Academic highlight style - textbook marker effect */
    .message-bubble mark,
    .message-bubble .highlight {
        background: linear-gradient(180deg, transparent 35%, rgba(250, 204, 21, 0.35) 35%);
        color: inherit;
        padding: 0.08rem 0.25rem;
        border-radius: 2px;
        font-weight: 500;
    }

    /* Academic underline - scholarly emphasis */
    .message-bubble u {
        text-decoration: none;
        border-bottom: 2px solid rgba(139, 92, 246, 0.6);
        padding-bottom: 2px;
        font-weight: 500;
    }

    /* Double underline for important terms */
    .message-bubble u strong {
        border-bottom: 2px double rgba(6, 182, 212, 0.7);
    }

    /* =============================================
       LEGACY STYLES (backwards compatibility - Compact)
    ============================================= */
    .message-bubble h3, .message-bubble h4 {
        color: #c4b5fd;
        margin: 0.45rem 0 0.2rem;
        font-size: 0.75rem;
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        letter-spacing: -0.02em;
        padding-bottom: 0.15rem;
        border-bottom: 1px solid rgba(139, 92, 246, 0.15);
    }

    .message-bubble h5, .message-bubble h6 {
        color: #94a3b8;
        margin: 0.35rem 0 0.15rem;
        font-size: 0.68rem;
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
    }

    .message-bubble ul, .message-bubble ol {
        margin: 0.6rem 0;
        padding-left: 1.2rem;
    }

    .message-bubble ul {
        list-style-type: disc;
    }

    .message-bubble ul ul {
        list-style-type: circle;
        margin: 0.3rem 0;
    }

    .message-bubble ol {
        list-style-type: decimal;
    }

    .message-bubble li {
        margin-bottom: 0.35rem;
        line-height: 1.6;
        font-size: 0.76rem;
        padding-left: 0.3rem;
    }

    .message-bubble li::marker {
        color: #22d3ee;
        font-weight: 600;
    }

    /* =============================================
       SEGMENT SEPARATORS - Visual Hierarchy
       Clear boundaries between content segments
    ============================================= */
    .message-bubble p {
        margin: 0.5rem 0;
        line-height: 1.65;
    }

    /* Major section breaks (h3 after content) */
    .message-bubble p + .md-h3,
    .message-bubble ul + .md-h3,
    .message-bubble ol + .md-h3,
    .message-bubble .md-quote + .md-h3,
    .message-bubble .code-block + .md-h3 {
        margin-top: 0.7rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(139, 92, 246, 0.15);
    }

    /* Sub-section breaks (h4 after content) */
    .message-bubble p + .md-h4,
    .message-bubble ul + .md-h4,
    .message-bubble ol + .md-h4 {
        margin-top: 0.5rem;
        padding-top: 0.35rem;
        border-top: 1px dashed rgba(148, 163, 184, 0.1);
    }

    /* Micro-section breaks (h5 after content) */
    .message-bubble p + .md-h5,
    .message-bubble ul + .md-h5,
    .message-bubble ol + .md-h5 {
        margin-top: 0.4rem;
    }

    /* List after paragraph spacing */
    .message-bubble p + .md-ul,
    .message-bubble p + .md-ol {
        margin-top: 0.25rem;
    }

    /* Code block spacing */
    .message-bubble p + .code-block,
    .message-bubble .md-h3 + .code-block,
    .message-bubble .md-h4 + .code-block {
        margin-top: 0.5rem;
    }

    /* Consecutive paragraphs - generous spacing for readability */
    .message-bubble p + p {
        margin-top: 1rem;
    }

    /* Blockquote after content */
    .message-bubble p + .md-quote,
    .message-bubble ul + .md-quote {
        margin-top: 0.45rem;
    }

    /* =============================================
       TABLES (if generated by AI)
    ============================================= */
    .message-bubble table {
        width: 100%;
        margin: 0.6rem 0;
        border-collapse: collapse;
        font-size: 0.68rem;
        background: rgba(30, 41, 59, 0.3);
        border-radius: 6px;
        overflow: hidden;
    }

    .message-bubble th {
        background: rgba(139, 92, 246, 0.15);
        color: #c4b5fd;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-size: 0.6rem;
        padding: 0.45rem 0.6rem;
        text-align: left;
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
    }

    .message-bubble td {
        padding: 0.4rem 0.6rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.08);
        color: #e2e8f0;
    }

    .message-bubble tr:last-child td {
        border-bottom: none;
    }

    .message-bubble tr:hover td {
        background: rgba(139, 92, 246, 0.05);
    }

    /* Loading */
    .tutor-loading {
        display: flex;
        align-items: center;
        gap: 0.7rem;
        padding: 0.7rem 0.85rem;
        background: rgba(30, 41, 59, 0.4);
        border-radius: 10px;
        border: 1px solid rgba(139, 92, 246, 0.1);
    }

    .loading-dots {
        display: flex;
        gap: 5px;
    }

    .loading-dots span {
        width: 6px;
        height: 6px;
        background: linear-gradient(135deg, #a78bfa, #8b5cf6);
        border-radius: 50%;
        animation: loadingBounce 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes loadingBounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    .loading-text {
        color: #94a3b8;
        font-size: 0.72rem;
        font-weight: 500;
        letter-spacing: -0.01em;
    }

    /* ============================================
       QUICK ACTIONS - Premium
    ============================================ */
    .tutor-quick-actions {
        padding: 0.6rem 0.9rem;
        border-top: 1px solid rgba(148, 163, 184, 0.08);
        flex-shrink: 0;
    }

    .actions-label {
        font-size: 0.55rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        margin-bottom: 0.45rem;
        font-weight: 500;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.4rem;
    }

    .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 0.4rem;
        background: rgba(30, 41, 59, 0.4);
        border: 1px solid rgba(139, 92, 246, 0.12);
        border-radius: 8px;
        color: #c4b5fd;
        cursor: pointer;
        transition: all 0.25s ease;
    }

    .quick-action:hover:not(:disabled) {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
    }

    .quick-action:disabled {
        opacity: 0.35;
        cursor: not-allowed;
    }

    .quick-action i {
        font-size: 0.8rem;
    }

    .quick-action span {
        font-size: 0.58rem;
        font-weight: 600;
    }

    /* ============================================
       INPUT AREA - Compact Premium
    ============================================ */
    .tutor-input-area {
        padding: 0.5rem 0.75rem;
        background: linear-gradient(180deg, rgba(30, 41, 59, 0.25), rgba(30, 41, 59, 0.4));
        border-top: 1px solid rgba(139, 92, 246, 0.1);
        flex-shrink: 0;
    }

    /* API Key Setup - Compact Card */
    .api-key-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .api-key-card {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: rgba(139, 92, 246, 0.06);
        border: 1px solid rgba(139, 92, 246, 0.12);
        border-radius: 7px;
    }

    .api-key-icon {
        width: 28px;
        height: 28px;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.7rem;
        flex-shrink: 0;
    }

    .api-key-content h5 {
        margin: 0 0 0.1rem 0;
        font-size: 0.7rem;
        font-weight: 600;
        color: #f1f5f9;
    }

    .api-key-content p {
        margin: 0;
        font-size: 0.58rem;
        color: #94a3b8;
    }

    .api-key-form {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .input-group {
        display: flex;
        gap: 0.35rem;
    }

    .api-key-input {
        flex: 1;
        padding: 0.45rem 0.6rem;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(139, 92, 246, 0.15);
        border-radius: 6px;
        color: #e2e8f0;
        font-size: 0.65rem;
        font-family: 'JetBrains Mono', monospace;
        transition: all 0.25s ease;
    }

    .api-key-input:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.4);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.08);
    }

    .api-key-save-btn {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        transition: all 0.25s ease;
        font-size: 0.65rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .api-key-save-btn:hover {
        transform: scale(1.03);
        box-shadow: 0 3px 10px rgba(139, 92, 246, 0.35);
    }

    .api-key-link {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.58rem;
        color: #a78bfa;
        text-decoration: none;
        padding: 0.35rem;
        background: rgba(139, 92, 246, 0.04);
        border-radius: 5px;
        transition: all 0.2s ease;
    }

    .api-key-link:hover {
        background: rgba(139, 92, 246, 0.08);
        color: #c4b5fd;
    }

    /* Chat Input - Compact Premium */
    .chat-input-container {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .chat-input-wrapper {
        display: flex;
        gap: 0.35rem;
        align-items: flex-end;
    }

    .chat-input-wrapper textarea {
        flex: 1;
        padding: 0.5rem 0.65rem;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(139, 92, 246, 0.15);
        border-radius: 8px;
        color: #e2e8f0;
        font-size: 0.67rem;
        font-family: 'Inter', system-ui, sans-serif;
        resize: none;
        line-height: 1.45;
        transition: all 0.25s ease;
        min-height: 50px; /* 2 rows of text */
        max-height: 90px;
    }

    .chat-input-wrapper textarea:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.4);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.08);
    }

    .send-btn {
        width: 34px;
        height: 34px;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.25s ease;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
        transform: scale(1.03);
        box-shadow: 0 3px 12px rgba(139, 92, 246, 0.35);
    }

    .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .input-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .model-badge {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.45rem;
        background: rgba(139, 92, 246, 0.08);
        border-radius: 15px;
    }

    .model-badge img {
        width: 10px;
        height: 10px;
    }

    .model-badge span {
        font-size: 0.52rem;
        color: #a78bfa;
        font-weight: 500;
    }

    .settings-btn {
        width: 22px;
        height: 22px;
        border-radius: 5px;
        border: 1px solid rgba(148, 163, 184, 0.12);
        background: transparent;
        color: #64748b;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.58rem;
    }

    .settings-btn:hover {
        background: rgba(148, 163, 184, 0.08);
        color: #94a3b8;
    }

    /* ============================================
       LIGHT MODE
    ============================================ */
    :global([data-theme="light"]) .ai-tutor-panel {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
        border-left-color: rgba(139, 92, 246, 0.15);
        box-shadow: -8px 0 40px rgba(0, 0, 0, 0.08);
    }

    :global([data-theme="light"]) .tutor-header {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.06), rgba(59, 130, 246, 0.03));
    }

    :global([data-theme="light"]) .tutor-title h3 {
        color: #0f172a;
    }

    :global([data-theme="light"]) .tutor-status {
        color: #64748b;
    }

    :global([data-theme="light"]) .tutor-close {
        background: rgba(241, 245, 249, 0.8);
        border-color: rgba(0, 0, 0, 0.08);
        color: #64748b;
    }

    /* Light mode TTS Controls */
    :global([data-theme="light"]) .tts-speed-btn {
        background: rgba(139, 92, 246, 0.08);
        border-color: rgba(139, 92, 246, 0.2);
        color: #7c3aed;
    }

    :global([data-theme="light"]) .tts-speed-btn:hover {
        background: rgba(139, 92, 246, 0.15);
        color: #6d28d9;
    }

    :global([data-theme="light"]) .tts-speed-dropdown {
        background: linear-gradient(135deg, #ffffff, #f8fafc);
        border-color: rgba(139, 92, 246, 0.2);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    :global([data-theme="light"]) .tts-speed-option {
        color: #475569;
    }

    :global([data-theme="light"]) .tts-speed-option:hover {
        background: rgba(139, 92, 246, 0.1);
        color: #7c3aed;
    }

    :global([data-theme="light"]) .tts-speed-option.active {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(6, 182, 212, 0.1));
        color: #7c3aed;
    }

    :global([data-theme="light"]) .tts-voice-btn {
        background: rgba(6, 182, 212, 0.08);
        border-color: rgba(6, 182, 212, 0.2);
        color: #0891b2;
    }

    :global([data-theme="light"]) .tts-voice-btn:hover {
        background: rgba(6, 182, 212, 0.15);
        color: #0e7490;
    }

    :global([data-theme="light"]) .tts-voice-btn.has-voice {
        border-color: rgba(34, 197, 94, 0.3);
        background: rgba(34, 197, 94, 0.1);
        color: #16a34a;
    }

    :global([data-theme="light"]) .tts-voice-dropdown {
        background: linear-gradient(135deg, #ffffff, #f8fafc);
        border-color: rgba(6, 182, 212, 0.2);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    :global([data-theme="light"]) .tts-voice-header {
        color: #475569;
        border-bottom-color: rgba(148, 163, 184, 0.15);
        background: rgba(241, 245, 249, 0.8);
    }

    :global([data-theme="light"]) .tts-voice-option {
        color: #334155;
    }

    :global([data-theme="light"]) .tts-voice-option:hover {
        background: rgba(6, 182, 212, 0.08);
    }

    :global([data-theme="light"]) .tts-voice-option.active {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(139, 92, 246, 0.08));
    }

    :global([data-theme="light"]) .tts-voice-option .voice-name {
        color: #1e293b;
    }

    :global([data-theme="light"]) .tts-voice-option .voice-lang {
        color: #64748b;
    }

    :global([data-theme="light"]) .tts-voice-option.active .voice-lang {
        color: #0891b2;
    }

    :global([data-theme="light"]) .tts-stop-btn {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.25);
        color: #dc2626;
    }

    :global([data-theme="light"]) .tts-speak-btn {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(139, 92, 246, 0.15);
        color: #64748b;
    }

    :global([data-theme="light"]) .tts-speak-btn:hover {
        background: rgba(139, 92, 246, 0.1);
        color: #7c3aed;
    }

    :global([data-theme="light"]) .tts-speak-btn.speaking {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(6, 182, 212, 0.1));
        border-color: rgba(34, 197, 94, 0.3);
        color: #16a34a;
    }

    :global([data-theme="light"]) .tts-speak-btn.paused {
        background: rgba(251, 191, 36, 0.1);
        border-color: rgba(251, 191, 36, 0.25);
        color: #d97706;
    }

    :global([data-theme="light"]) .message.tts-reading .message-bubble {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(6, 182, 212, 0.04)) !important;
        border-color: rgba(139, 92, 246, 0.2) !important;
        box-shadow: 0 0 15px rgba(139, 92, 246, 0.1), 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    :global([data-theme="light"]) .tutor-context {
        background: linear-gradient(90deg, rgba(6, 182, 212, 0.06), transparent);
        border-color: rgba(6, 182, 212, 0.1);
    }

    :global([data-theme="light"]) .context-badge {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(6, 182, 212, 0.05));
        border-color: rgba(6, 182, 212, 0.2);
        color: #0891b2;
    }

    :global([data-theme="light"]) .context-subject {
        color: #0f172a;
    }

    :global([data-theme="light"]) .welcome-hero h4 {
        color: #0f172a;
    }

    :global([data-theme="light"]) .welcome-subtitle {
        color: #7c3aed;
    }

    :global([data-theme="light"]) .capability-card {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(139, 92, 246, 0.1);
    }

    :global([data-theme="light"]) .capability-card i {
        color: #7c3aed;
    }

    :global([data-theme="light"]) .capability-card span {
        color: #334155;
    }

    :global([data-theme="light"]) .welcome-hint {
        background: rgba(0, 0, 0, 0.03);
        color: #475569;
    }

    :global([data-theme="light"]) .message.assistant .message-bubble {
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(139, 92, 246, 0.12);
        color: #1e293b;
    }

    :global([data-theme="light"]) .message.user .message-bubble {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.12), rgba(6, 182, 212, 0.05));
        border-color: rgba(6, 182, 212, 0.15);
        color: #0f172a;
    }

    /* Light mode Markdown styles */
    /* Light mode code blocks - VSCode Light Theme */
    :global([data-theme="light"]) .message-bubble .code-block {
        box-shadow:
            0 2px 8px rgba(0, 0, 0, 0.08),
            0 1px 2px rgba(0, 0, 0, 0.05);
    }

    :global([data-theme="light"]) .message-bubble .code-block .code-header {
        background: linear-gradient(180deg, #f3f3f3 0%, #e8e8e8 100%);
        border-bottom-color: #d4d4d4;
    }

    :global([data-theme="light"]) .message-bubble .code-block .code-lang {
        background: rgba(139, 92, 246, 0.12);
        color: #7c3aed;
        border-color: rgba(139, 92, 246, 0.2);
    }

    :global([data-theme="light"]) .message-bubble .code-block .code-copy {
        color: #6b7280;
        border-color: rgba(107, 114, 128, 0.2);
    }

    :global([data-theme="light"]) .message-bubble .code-block .code-copy:hover {
        background: rgba(139, 92, 246, 0.1);
        color: #7c3aed;
    }

    :global([data-theme="light"]) .message-bubble pre {
        background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
    }

    :global([data-theme="light"]) .message-bubble code {
        color: #1e293b;
    }

    :global([data-theme="light"]) .message-bubble pre code {
        border-left-color: rgba(139, 92, 246, 0.25);
    }

    :global([data-theme="light"]) .message-bubble .inline-code {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(139, 92, 246, 0.04));
        color: #7c3aed;
        border-color: rgba(139, 92, 246, 0.12);
    }

    /* Light mode headers */
    :global([data-theme="light"]) .message-bubble .md-h2 {
        background: linear-gradient(135deg, #1e293b 0%, #6d28d9 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    :global([data-theme="light"]) .message-bubble .md-h3 {
        color: #1e293b;
        border-bottom-color: rgba(139, 92, 246, 0.15);
    }

    :global([data-theme="light"]) .message-bubble .md-h3::before {
        background: linear-gradient(180deg, #7c3aed, #0891b2);
    }

    :global([data-theme="light"]) .message-bubble .md-h4 {
        color: #6d28d9;
    }

    :global([data-theme="light"]) .message-bubble .md-h5 {
        color: #475569;
    }

    /* Light mode lists */
    :global([data-theme="light"]) .message-bubble .md-ul li.bullet {
        background: rgba(248, 250, 252, 0.8);
    }

    :global([data-theme="light"]) .message-bubble .md-ul li.bullet:hover {
        background: rgba(241, 245, 249, 1);
    }

    :global([data-theme="light"]) .message-bubble .md-ul li.bullet::before {
        color: #0891b2;
    }

    :global([data-theme="light"]) .message-bubble .md-ol li.numbered {
        background: rgba(248, 250, 252, 0.8);
    }

    :global([data-theme="light"]) .message-bubble .md-ol li.numbered:hover {
        background: rgba(241, 245, 249, 1);
    }

    :global([data-theme="light"]) .message-bubble .md-ol li.numbered::before {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(6, 182, 212, 0.08));
        border-color: rgba(6, 182, 212, 0.25);
        color: #0891b2;
    }

    /* Light mode blockquotes */
    :global([data-theme="light"]) .message-bubble .md-quote {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.05), rgba(6, 182, 212, 0.02));
        border-left-color: #0891b2;
        color: #475569;
    }

    :global([data-theme="light"]) .message-bubble .md-quote::before {
        color: rgba(8, 145, 178, 0.25);
    }

    :global([data-theme="light"]) .message-bubble .md-hr {
        background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.25), rgba(6, 182, 212, 0.25), transparent);
    }

    /* Light mode links */
    :global([data-theme="light"]) .message-bubble .md-link {
        color: #0891b2;
        border-bottom-color: rgba(8, 145, 178, 0.3);
    }

    :global([data-theme="light"]) .message-bubble .md-link:hover {
        color: #0e7490;
        border-bottom-color: rgba(14, 116, 144, 0.6);
    }

    /* Light mode text emphasis */
    :global([data-theme="light"]) .message-bubble strong {
        color: #0f172a;
        text-shadow: none;
    }

    :global([data-theme="light"]) .message-bubble em {
        color: #6d28d9;
    }

    :global([data-theme="light"]) .message-bubble del {
        color: #94a3b8;
    }

    /* Light mode tables */
    :global([data-theme="light"]) .message-bubble table {
        background: rgba(248, 250, 252, 0.8);
    }

    :global([data-theme="light"]) .message-bubble th {
        background: rgba(139, 92, 246, 0.1);
        color: #6d28d9;
        border-bottom-color: rgba(139, 92, 246, 0.15);
    }

    :global([data-theme="light"]) .message-bubble td {
        color: #334155;
        border-bottom-color: rgba(148, 163, 184, 0.12);
    }

    :global([data-theme="light"]) .message-bubble tr:hover td {
        background: rgba(139, 92, 246, 0.03);
    }

    /* Light mode gradient scrim */
    :global([data-theme="light"]) .tutor-body::after {
        background: linear-gradient(to top, rgba(248, 250, 252, 0.95), transparent);
    }

    :global([data-theme="light"]) .tutor-loading {
        background: rgba(248, 250, 252, 0.9);
        border-color: rgba(139, 92, 246, 0.1);
    }

    :global([data-theme="light"]) .loading-text {
        color: #475569;
    }

    :global([data-theme="light"]) .quick-action {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(139, 92, 246, 0.1);
        color: #6d28d9;
    }

    :global([data-theme="light"]) .tutor-input-area {
        background: linear-gradient(180deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.9));
        border-color: rgba(0, 0, 0, 0.06);
    }

    :global([data-theme="light"]) .api-key-card {
        background: rgba(139, 92, 246, 0.05);
        border-color: rgba(139, 92, 246, 0.12);
    }

    :global([data-theme="light"]) .api-key-content h5 {
        color: #0f172a;
    }

    :global([data-theme="light"]) .api-key-input,
    :global([data-theme="light"]) .chat-input-wrapper textarea {
        background: white;
        border-color: rgba(0, 0, 0, 0.1);
        color: #0f172a;
    }

    :global([data-theme="light"]) .api-key-link {
        background: rgba(139, 92, 246, 0.03);
        color: #7c3aed;
    }

    :global([data-theme="light"]) .model-badge {
        background: rgba(139, 92, 246, 0.08);
    }

    :global([data-theme="light"]) .model-badge span {
        color: #7c3aed;
    }

    /* ============================================
       RESPONSIVE - Coordinated with SubjectDrawer
       Breakpoints: 1400px, 1200px, 900px, 600px
    ============================================ */
    @media (max-width: 1400px) {
        .ai-tutor-panel {
            width: 360px;
        }

        .tutor-header {
            padding: 0.5rem 0.75rem;
        }

        .tutor-body {
            padding: 0.65rem 0.8rem;
        }

        .capability-card {
            padding: 0.45rem 0.55rem;
        }
    }

    @media (max-width: 1200px) {
        .ai-tutor-panel {
            width: 340px;
        }

        .tutor-logo {
            width: 26px;
            height: 26px;
        }

        .tutor-logo img {
            width: 18px;
            height: 18px;
        }

        .tutor-title h3 {
            font-size: 0.82rem;
        }

        .welcome-avatar {
            width: 44px;
            height: 44px;
        }

        .welcome-avatar img {
            width: 24px;
            height: 24px;
        }

        .welcome-hero h4 {
            font-size: 0.88rem;
        }

        .capability-card span {
            font-size: 0.62rem;
        }

        .message-bubble {
            font-size: 0.68rem;
        }
    }

    @media (max-width: 900px) {
        .ai-tutor-panel {
            width: 100%;
            max-width: 380px;
            right: 0 !important;
            border-left: none;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
        }

        .tutor-header {
            padding: 0.55rem 0.85rem;
        }

        .tutor-body {
            padding: 0.7rem 0.85rem;
        }

        .welcome-capabilities {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
        }

        .actions-grid {
            gap: 0.35rem;
        }
    }

    @media (max-width: 600px) {
        .ai-tutor-panel {
            width: 100%;
            max-width: 100%;
            top: 60px; /* Smaller header on mobile */
            height: calc(100vh - 60px);
        }

        .tutor-header {
            padding: 0.5rem 0.75rem;
        }

        .tutor-branding {
            gap: 0.5rem;
        }

        .tutor-logo {
            width: 24px;
            height: 24px;
        }

        .tutor-logo img {
            width: 16px;
            height: 16px;
        }

        .tutor-title h3 {
            font-size: 0.78rem;
        }

        .tutor-status {
            font-size: 0.55rem;
        }

        .tutor-context {
            padding: 0.5rem 0.75rem;
        }

        .context-badge {
            width: 24px;
            height: 24px;
            font-size: 0.62rem;
        }

        .context-subject {
            font-size: 0.7rem;
        }

        .tutor-body {
            padding: 0.6rem 0.75rem;
        }

        .welcome-avatar {
            width: 40px;
            height: 40px;
        }

        .welcome-avatar img {
            width: 22px;
            height: 22px;
        }

        .welcome-hero h4 {
            font-size: 0.85rem;
        }

        .welcome-subtitle {
            font-size: 0.62rem;
        }

        .welcome-capabilities {
            grid-template-columns: 1fr;
            gap: 0.35rem;
        }

        .capability-card {
            padding: 0.4rem 0.5rem;
        }

        .capability-card i {
            font-size: 0.68rem;
        }

        .capability-card span {
            font-size: 0.6rem;
        }

        .welcome-hint {
            font-size: 0.62rem;
            padding: 0.5rem;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
        }

        .message-bubble {
            font-size: 0.65rem;
            padding: 0.45rem 0.6rem;
        }

        .message-bubble code {
            font-size: 0.58rem;
        }

        .tutor-quick-actions {
            padding: 0.5rem 0.75rem;
        }

        .actions-label {
            font-size: 0.5rem;
        }

        .actions-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.3rem;
        }

        .quick-action {
            padding: 0.4rem 0.35rem;
            border-radius: 6px;
        }

        .quick-action i {
            font-size: 0.72rem;
        }

        .quick-action span {
            font-size: 0.52rem;
        }

        .tutor-input-area {
            padding: 0.45rem 0.65rem;
        }

        .api-key-card {
            padding: 0.4rem;
        }

        .api-key-icon {
            width: 26px;
            height: 26px;
            font-size: 0.62rem;
        }

        .api-key-content h5 {
            font-size: 0.65rem;
        }

        .api-key-content p {
            font-size: 0.52rem;
        }

        .api-key-input {
            font-size: 0.6rem;
            padding: 0.4rem 0.5rem;
        }

        .api-key-save-btn {
            width: 28px;
            height: 28px;
            font-size: 0.58rem;
        }

        .api-key-link {
            font-size: 0.52rem;
        }

        .chat-input-wrapper textarea {
            font-size: 0.62rem;
            padding: 0.4rem 0.55rem;
            min-height: 30px;
        }

        .send-btn {
            width: 30px;
            height: 30px;
            font-size: 0.62rem;
        }

        .model-badge {
            padding: 0.2rem 0.35rem;
        }

        .model-badge img {
            width: 8px;
            height: 8px;
        }

        .model-badge span {
            font-size: 0.48rem;
        }

        .settings-btn {
            width: 20px;
            height: 20px;
            font-size: 0.52rem;
        }
    }

    @media (max-width: 400px) {
        .tutor-header {
            padding: 0.45rem 0.6rem;
        }

        .tutor-logo {
            width: 22px;
            height: 22px;
        }

        .tutor-title h3 {
            font-size: 0.72rem;
        }

        .welcome-hero h4 {
            font-size: 0.78rem;
        }

        .capability-card span {
            font-size: 0.55rem;
        }

        .message-bubble {
            font-size: 0.6rem;
        }

        .quick-action span {
            font-size: 0.48rem;
        }
    }
</style>

<script is:inline>
    // ============================================
    // AI TUTOR SIDE PANEL - JAVASCRIPT
    // Premium Enterprise Design
    // ============================================

    let currentSubject = null;
    let chatHistory = [];
    let tutorInitialized = false;
    let isSending = false;

    function initAITutorPanel() {
        if (tutorInitialized) return;
        tutorInitialized = true;

        const panel = document.getElementById('ai-tutor-panel');
        const closeBtn = document.getElementById('tutor-close');
        const saveKeyBtn = document.getElementById('save-api-key-btn');
        const sendBtn = document.getElementById('send-message-btn');
        const chatInput = document.getElementById('tutor-chat-input');
        const settingsBtn = document.getElementById('settings-btn');
        const quickActions = document.querySelectorAll('.quick-action');

        // Check for saved API key
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) {
            showChatInput();
        }

        // Close panel - use hideAITutor to properly clear state
        closeBtn?.addEventListener('click', () => {
            window.hideAITutor();
            updateQuickActionsState(false);
        });

        // Save API key
        saveKeyBtn?.addEventListener('click', saveApiKey);

        // Send message
        sendBtn?.addEventListener('click', sendMessage);

        // Enter to send
        chatInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Settings button - show API key configuration
        settingsBtn?.addEventListener('click', showApiKeySetup);

        // Quick actions - prevent duplicate listeners
        quickActions.forEach(btn => {
            if (btn.hasAttribute('data-qa-listener')) return;
            btn.setAttribute('data-qa-listener', 'true');
            btn.addEventListener('click', () => {
                if (!btn.disabled) {
                    handleQuickAction(btn.dataset.action);
                }
            });
        });

        // Input state - enable/disable send button
        chatInput?.addEventListener('input', () => {
            if (sendBtn) {
                sendBtn.disabled = !chatInput.value.trim();
            }
        });

        // Auto-resize textarea
        chatInput?.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    // Show panel for a subject
    window.showAITutor = function(subjectName, subjectCode) {
        const panel = document.getElementById('ai-tutor-panel');
        const subjectLabel = document.getElementById('tutor-subject-name');
        const welcome = document.getElementById('tutor-welcome');
        const messages = document.getElementById('tutor-messages');

        currentSubject = { name: subjectName, code: subjectCode };
        chatHistory = [];

        // Update subject context
        if (subjectLabel) {
            subjectLabel.textContent = subjectName;
        }

        // Clear messages - DON'T show welcome since we'll add greeting immediately
        if (messages) messages.innerHTML = '';
        if (welcome) welcome.style.display = 'none';

        // Show panel
        panel?.classList.add('visible');
        panel?.classList.remove('minimized');

        // Enable quick actions
        updateQuickActionsState(true);

        // Add initial assistant message with prominent greeting state
        const greetingMsg = `¬°Hola! üëã Tutor de **${subjectName}** a tu servicio. Res√∫menes, c√≥digo, ejercicios, dudas... ¬°pregunta lo que quieras!`;
        addMessage('assistant', greetingMsg);

        // Make the greeting prominent for 8 seconds
        // Use requestAnimationFrame to ensure DOM is updated after addMessage
        requestAnimationFrame(() => {
            const greetingElement = messages?.querySelector('.message.assistant:last-child');
            if (greetingElement) {
                greetingElement.classList.add('greeting-prominent');
                setTimeout(() => {
                    greetingElement.classList.remove('greeting-prominent');
                }, 8000);
            }
        });

        // Save state to sessionStorage for persistence across View Transitions
        // Include timestamp to prevent astro:page-load from re-adding the greeting
        sessionStorage.setItem('aiTutorState', JSON.stringify({
            visible: true,
            subject: currentSubject,
            greeting: greetingMsg,
            timestamp: Date.now()
        }));
    };

    // Hide panel
    window.hideAITutor = function() {
        const panel = document.getElementById('ai-tutor-panel');
        panel?.classList.remove('visible', 'minimized');
        currentSubject = null;
        // Clear persisted state
        sessionStorage.removeItem('aiTutorState');
    };

    function showChatInput() {
        const apiKeyContainer = document.getElementById('api-key-container');
        const chatContainer = document.getElementById('chat-input-container');

        if (apiKeyContainer) apiKeyContainer.style.display = 'none';
        if (chatContainer) chatContainer.style.display = 'flex';
    }

    function showApiKeySetup() {
        const apiKeyContainer = document.getElementById('api-key-container');
        const chatContainer = document.getElementById('chat-input-container');
        const apiKeyInput = document.getElementById('gemini-api-key-input');

        if (chatContainer) chatContainer.style.display = 'none';
        if (apiKeyContainer) apiKeyContainer.style.display = 'flex';

        // Pre-fill with masked current key if exists
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey && apiKeyInput) {
            apiKeyInput.value = '';
            apiKeyInput.placeholder = 'Cambia tu API Key o d√©jalo vac√≠o para mantener la actual...';
        }
    }

    function saveApiKey() {
        const input = document.getElementById('gemini-api-key-input');
        const key = input?.value?.trim();
        const existingKey = localStorage.getItem('gemini_api_key');

        // If no new key but existing key, just go back to chat
        if (!key && existingKey) {
            showChatInput();
            return;
        }

        if (key && key.startsWith('AIza')) {
            localStorage.setItem('gemini_api_key', key);
            showChatInput();
            addMessage('assistant', '¬°API Key guardada correctamente! Ya puedes empezar a preguntarme.');
        } else if (key) {
            addMessage('assistant', 'Por favor, ingresa una API Key v√°lida de Gemini. Debe comenzar con "AIza..."');
        }
    }

    function updateQuickActionsState(enabled) {
        const quickActions = document.querySelectorAll('.quick-action');
        quickActions.forEach(btn => {
            btn.disabled = !enabled;
        });
    }

    function handleQuickAction(action) {
        if (!currentSubject) return;

        const prompts = {
            'resume': `Dame un resumen conciso de los conceptos clave de ${currentSubject.name}. Incluye los puntos m√°s importantes que un estudiante debe dominar.`,
            'examples': `Proporciona ejemplos pr√°cticos de c√≥digo para ${currentSubject.name}. Usa ejemplos del mundo real relevantes para un programador.`,
            'practice': `Genera 3 ejercicios pr√°cticos de ${currentSubject.name} con diferentes niveles de dificultad (b√°sico, intermedio, avanzado). Incluye las respuestas esperadas.`,
            'explain': `Explica de forma simple y clara los fundamentos de ${currentSubject.name}. Usa analog√≠as y ejemplos cotidianos para facilitar la comprensi√≥n.`
        };

        const prompt = prompts[action];
        if (prompt) {
            const chatInput = document.getElementById('tutor-chat-input');
            if (chatInput) {
                chatInput.value = prompt;
                sendMessage();
            }
        }
    }

    async function sendMessage() {
        // Prevent duplicate submissions
        if (isSending) return;

        const input = document.getElementById('tutor-chat-input');
        const message = input?.value?.trim();
        const apiKey = localStorage.getItem('gemini_api_key');

        if (!message) return;
        if (!apiKey) {
            addMessage('assistant', 'Por favor, configura tu API Key de Gemini primero.');
            return;
        }

        // Lock to prevent duplicates
        isSending = true;

        // Add user message
        addMessage('user', message);
        input.value = '';
        document.getElementById('send-message-btn').disabled = true;

        // Show loading
        showLoading(true);

        try {
            const response = await callGeminiAPI(message, apiKey);
            addMessage('assistant', response);
        } catch (error) {
            console.error('Gemini API Error:', error);
            addMessage('assistant', `Error: ${error.message || 'No se pudo conectar con Gemini. Verifica tu API Key.'}`);
        } finally {
            showLoading(false);
            isSending = false;
        }
    }

    async function callGeminiAPI(message, apiKey) {
        const subjectContext = currentSubject
            ? `la asignatura "${currentSubject.name}" (c√≥digo: ${currentSubject.code})`
            : 'programaci√≥n';

        const systemPrompt = `Eres un tutor IA especializado en ${subjectContext} del programa Analista Programador Computacional de DuocUC, Chile.
Tu objetivo es ayudar a estudiantes a comprender conceptos, resolver ejercicios y prepararse para evaluaciones.
Responde en espa√±ol de Chile, de forma clara, profesional y pedag√≥gica.
Usa formato Markdown: headers (##), listas (-), c√≥digo (\`\`\`), negritas (**), etc.
Si el estudiante pregunta algo fuera del tema, gentilmente redirige la conversaci√≥n.
Mant√©n respuestas concisas pero completas.`;

        const payload = {
            contents: [
                {
                    parts: [
                        { text: systemPrompt },
                        ...chatHistory.map(msg => ({ text: `${msg.role === 'user' ? 'Usuario' : 'Tutor'}: ${msg.content}` })),
                        { text: `Usuario: ${message}` }
                    ]
                }
            ],
            generationConfig: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 2048,
            }
        };

        // Try multiple models in order of preference (updated Dec 2025)
        // See: https://ai.google.dev/gemini-api/docs/models
        const models = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-2.0-flash-lite'];
        let response = null;
        let lastError = null;

        for (const model of models) {
            try {
                response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (response.ok) {
                    console.log(`Using Gemini model: ${model}`);
                    break;
                }

                lastError = await response.json();
                console.warn(`Model ${model} failed:`, lastError.error?.message);
            } catch (e) {
                lastError = e;
                console.warn(`Model ${model} error:`, e);
            }
        }

        if (!response || !response.ok) {
            throw new Error(lastError?.error?.message || 'No se pudo conectar con Gemini. Verifica tu API Key.');
        }

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No se recibi√≥ respuesta.';

        // Update history
        chatHistory.push({ role: 'user', content: message });
        chatHistory.push({ role: 'assistant', content: text });

        // Keep last 10 exchanges
        if (chatHistory.length > 20) {
            chatHistory = chatHistory.slice(-20);
        }

        return text;
    }

    function addMessage(role, content) {
        const messagesContainer = document.getElementById('tutor-messages');
        const welcome = document.getElementById('tutor-welcome');

        if (!messagesContainer) return;

        // Hide welcome
        if (welcome) welcome.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        // Enhanced Markdown to HTML conversion
        let formattedContent = content;

        // 1. Code blocks (VSCode-style with header and copy button)
        formattedContent = formattedContent.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
            const langClass = lang ? ` class="language-${lang}"` : '';
            const langDisplay = lang || 'code';
            const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
            return `<div class="code-block">
                <div class="code-header">
                    <span class="code-lang">${langDisplay}</span>
                    <button class="code-copy" data-code-id="${codeId}" title="Copiar c√≥digo">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                </div>
                <pre><code${langClass} id="${codeId}">${escapeHtml(code.trim())}</code></pre>
            </div>`;
        });

        // 2. Inline code (before other formatting)
        formattedContent = formattedContent.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');

        // 3. Headers (must check for # at start of line, process from most to least specific)
        formattedContent = formattedContent.replace(/^###### (.+)$/gm, '<h6 class="md-h6">$1</h6>');
        formattedContent = formattedContent.replace(/^##### (.+)$/gm, '<h6 class="md-h6">$1</h6>');
        formattedContent = formattedContent.replace(/^#### (.+)$/gm, '<h5 class="md-h5">$1</h5>');
        formattedContent = formattedContent.replace(/^### (.+)$/gm, '<h4 class="md-h4">$1</h4>');
        formattedContent = formattedContent.replace(/^## (.+)$/gm, '<h3 class="md-h3">$1</h3>');
        formattedContent = formattedContent.replace(/^# (.+)$/gm, '<h2 class="md-h2">$1</h2>');

        // 4. Bold and italic (order matters)
        formattedContent = formattedContent.replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>');
        formattedContent = formattedContent.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        formattedContent = formattedContent.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        formattedContent = formattedContent.replace(/__([^_]+)__/g, '<strong>$1</strong>');
        formattedContent = formattedContent.replace(/_([^_]+)_/g, '<em>$1</em>');

        // 5. Strikethrough
        formattedContent = formattedContent.replace(/~~([^~]+)~~/g, '<del>$1</del>');

        // 6. Numbered lists (1. 2. 3. etc.)
        formattedContent = formattedContent.replace(/^(\d+)\. (.+)$/gm, '<li class="numbered" data-num="$1">$2</li>');

        // 7. Bullet lists (-, *, +)
        formattedContent = formattedContent.replace(/^[\-\*\+] (.+)$/gm, '<li class="bullet">$1</li>');

        // 8. Wrap consecutive list items
        formattedContent = formattedContent.replace(/(<li class="numbered"[^>]*>.*?<\/li>\n?)+/g, '<ol class="md-ol">$&</ol>');
        formattedContent = formattedContent.replace(/(<li class="bullet">.*?<\/li>\n?)+/g, '<ul class="md-ul">$&</ul>');

        // 9. Blockquotes
        formattedContent = formattedContent.replace(/^> (.+)$/gm, '<blockquote class="md-quote">$1</blockquote>');

        // 10. Horizontal rule
        formattedContent = formattedContent.replace(/^---+$/gm, '<hr class="md-hr">');

        // 11. Links
        formattedContent = formattedContent.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" class="md-link">$1</a>');

        // 12. Line breaks (convert remaining newlines, but not inside pre/code)
        formattedContent = formattedContent.replace(/\n(?![^<]*<\/pre>)/g, '<br>');

        // Clean up extra br tags around block elements
        formattedContent = formattedContent.replace(/<br>\s*(<h[1-6]|<ul|<ol|<blockquote|<div|<hr)/g, '$1');
        formattedContent = formattedContent.replace(/(<\/h[1-6]>|<\/ul>|<\/ol>|<\/blockquote>|<\/div>|<hr[^>]*>)\s*<br>/g, '$1');

        const avatarContent = role === 'assistant'
            ? '<img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" alt="AI" />'
            : '<i class="fas fa-user"></i>';

        // TTS speaker button for assistant messages only
        const ttsButton = role === 'assistant'
            ? `<button class="tts-speak-btn" title="Escuchar mensaje" data-tts-text="${escapeHtmlAttr(content)}">
                <i class="fas fa-volume-up"></i>
               </button>`
            : '';

        messageDiv.innerHTML = `
            <div class="message-avatar">${avatarContent}</div>
            <div class="message-bubble">${formattedContent}</div>
            ${ttsButton}
        `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Attach TTS speak button event listener
        const speakBtn = messageDiv.querySelector('.tts-speak-btn');
        if (speakBtn) {
            speakBtn.addEventListener('click', function() {
                const tts = window.ttsManager;
                if (!tts) return;

                // If this button is speaking, toggle pause/resume
                if (tts.currentSpeakBtn === this && tts.isSpeaking) {
                    tts.toggle();
                    return;
                }

                // Otherwise, start speaking this message
                const text = this.getAttribute('data-tts-text');
                tts.speak(text, messageDiv);
            });
        }

        // Attach copy button event listeners for code blocks
        const copyButtons = messageDiv.querySelectorAll('.code-copy');
        copyButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const codeId = this.getAttribute('data-code-id');
                const codeElement = document.getElementById(codeId);
                if (codeElement) {
                    navigator.clipboard.writeText(codeElement.textContent).then(() => {
                        // Success feedback
                        this.classList.add('copied');
                        this.innerHTML = '<i class="fas fa-check"></i> Copiado';
                        setTimeout(() => {
                            this.classList.remove('copied');
                            this.innerHTML = '<i class="fas fa-copy"></i> Copiar';
                        }, 2000);
                    }).catch(err => {
                        console.error('Error copying:', err);
                    });
                }
            });
        });
    }

    // Helper function to escape HTML in code blocks
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Helper function to escape HTML attributes (for data attributes)
    function escapeHtmlAttr(text) {
        return text
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function showLoading(show) {
        const loading = document.getElementById('tutor-loading');
        if (loading) {
            loading.style.display = show ? 'flex' : 'none';
        }
    }

    function clearChat() {
        const messagesContainer = document.getElementById('tutor-messages');
        const welcome = document.getElementById('tutor-welcome');

        if (messagesContainer) messagesContainer.innerHTML = '';
        if (welcome) welcome.style.display = 'block';

        chatHistory = [];
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initAITutorPanel);
    document.addEventListener('astro:page-load', () => {
        // FIRST: Check for saved state BEFORE reinitializing
        const savedState = sessionStorage.getItem('aiTutorState');

        tutorInitialized = false;
        initAITutorPanel();

        // Restore state from sessionStorage (persists across View Transitions)
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                if (state.visible && state.subject) {
                    // Check if this state was just saved by showAITutor (within 1 second)
                    // If so, skip re-adding the greeting to avoid flash/flicker
                    const isRecentlySaved = state.timestamp && (Date.now() - state.timestamp < 1000);

                    // Use requestAnimationFrame to ensure DOM is ready
                    requestAnimationFrame(() => {
                        currentSubject = state.subject;
                        chatHistory = [];

                        // Restore panel visibility
                        const panel = document.getElementById('ai-tutor-panel');
                        panel?.classList.add('visible');
                        panel?.classList.remove('minimized');

                        // Restore subject label
                        const subjectLabel = document.getElementById('tutor-subject-name');
                        if (subjectLabel) subjectLabel.textContent = state.subject.name;

                        // Hide welcome
                        const welcome = document.getElementById('tutor-welcome');
                        if (welcome) welcome.style.display = 'none';

                        // Always restore greeting if messages container is empty
                        // View Transitions may have cleared the DOM
                        const messagesContainer = document.getElementById('tutor-messages');
                        const hasMessages = messagesContainer && messagesContainer.children.length > 0;

                        if (messagesContainer && state.greeting && !hasMessages) {
                            addMessage('assistant', state.greeting);

                            // Apply greeting-prominent effect for remaining time
                            if (isRecentlySaved) {
                                requestAnimationFrame(() => {
                                    const greetingElement = messagesContainer.querySelector('.message.assistant:last-child');
                                    if (greetingElement) {
                                        greetingElement.classList.add('greeting-prominent');
                                        // Calculate remaining time (8 seconds - elapsed)
                                        const elapsed = Date.now() - state.timestamp;
                                        const remaining = Math.max(0, 8000 - elapsed);
                                        setTimeout(() => {
                                            greetingElement.classList.remove('greeting-prominent');
                                        }, remaining);
                                    }
                                });
                            }
                        }

                        // Enable quick actions
                        updateQuickActionsState(true);
                    });
                }
            } catch (e) {
                console.warn('Error restoring AI Tutor state:', e);
            }
        }
    });

    // ============================================
    // TEXT-TO-SPEECH (TTS) MANAGER
    // Premium voice experience with Puter.js + Web Speech API
    // Puter.js: Free neural voices (no API key)
    // Web Speech API: Browser fallback
    // ============================================

    class TTSManager {
        constructor() {
            // Engine settings
            this.engine = 'puter'; // 'puter' or 'browser'
            this.puterEngine = 'neural'; // 'neural', 'generative', 'standard'
            this.puterLang = 'es-MX';

            // Browser TTS
            this.synth = window.speechSynthesis;
            this.utterance = null;
            this.voices = [];
            this.preferredVoice = null;

            // State
            this.currentMessageElement = null;
            this.currentSpeakBtn = null;
            this.speed = 1;
            this.isPaused = false;
            this.isSpeaking = false;
            this._controlsInitialized = false;
            this.currentAudio = null;

            // Load settings from localStorage
            this.loadSettings();

            // Load Puter.js
            this.loadPuterJS();

            // Load browser voices
            this.loadBrowserVoices();
            if (this.synth?.onvoiceschanged !== undefined) {
                this.synth.onvoiceschanged = () => {
                    this.loadBrowserVoices();
                    this.populateBrowserVoices();
                };
            }

            // Initialize UI
            this.initControls();
            this.updateCurrentEngineDisplay();
        }

        loadSettings() {
            try {
                const saved = localStorage.getItem('tts-settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    this.engine = settings.engine || 'puter';
                    this.puterEngine = settings.puterEngine || 'neural';
                    this.puterLang = settings.puterLang || 'es-MX';
                    this.speed = settings.speed || 1;
                    console.log('TTS: Loaded settings', settings);
                }
            } catch (e) {
                console.warn('TTS: Could not load settings', e);
            }
        }

        saveSettings() {
            try {
                const settings = {
                    engine: this.engine,
                    puterEngine: this.puterEngine,
                    puterLang: this.puterLang,
                    speed: this.speed
                };
                localStorage.setItem('tts-settings', JSON.stringify(settings));
                console.log('TTS: Saved settings', settings);
            } catch (e) {
                console.warn('TTS: Could not save settings', e);
            }
        }

        loadPuterJS() {
            if (window.puter) {
                console.log('TTS: Puter.js already loaded');
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://js.puter.com/v2/';
            script.async = true;
            script.onload = () => {
                console.log('TTS: Puter.js loaded successfully');
            };
            script.onerror = () => {
                console.warn('TTS: Failed to load Puter.js, using browser fallback');
                this.engine = 'browser';
            };
            document.head.appendChild(script);
        }

        loadBrowserVoices() {
            if (!this.synth) return;
            this.voices = this.synth.getVoices();

            // Get Spanish voices for preferred selection
            const spanishVoices = this.voices.filter(v =>
                v.lang.startsWith('es') || v.lang.includes('ES')
            );

            if (spanishVoices.length > 0 && !this.preferredVoice) {
                // Prefer online voices
                const online = spanishVoices.filter(v => !v.localService);
                this.preferredVoice = online[0] || spanishVoices[0];
            }

            this.populateBrowserVoices();
        }

        populateBrowserVoices() {
            const esContainer = document.getElementById('tts-browser-voices-es');
            const otherContainer = document.getElementById('tts-browser-voices-other');
            if (!esContainer || !otherContainer) return;

            const spanishVoices = this.voices.filter(v =>
                v.lang.startsWith('es') || v.lang.includes('ES')
            );
            const otherVoices = this.voices.filter(v =>
                !v.lang.startsWith('es') && !v.lang.includes('ES')
            );

            const getQuality = (v) => {
                const name = v.name.toLowerCase();
                if (name.includes('wavenet') || name.includes('neural')) return '‚òÖ‚òÖ‚òÖ';
                if (!v.localService) return '‚òÖ‚òÖ';
                return '‚òÖ';
            };

            esContainer.innerHTML = spanishVoices.length > 0
                ? spanishVoices.map((v, i) => `
                    <button class="tts-browser-voice ${this.preferredVoice?.name === v.name ? 'active' : ''}"
                            data-voice-index="${this.voices.indexOf(v)}">
                        ${v.name.replace(/Microsoft|Google|Apple/gi, '').trim()}
                        <span class="voice-quality">${getQuality(v)}</span>
                    </button>
                `).join('')
                : '<div style="padding: 0.5rem; color: #64748b; font-size: 0.65rem;">No hay voces en espa√±ol</div>';

            otherContainer.innerHTML = otherVoices.slice(0, 15).map((v, i) => `
                <button class="tts-browser-voice ${this.preferredVoice?.name === v.name ? 'active' : ''}"
                        data-voice-index="${this.voices.indexOf(v)}">
                    ${v.name.replace(/Microsoft|Google|Apple/gi, '').trim()} (${v.lang})
                    <span class="voice-quality">${getQuality(v)}</span>
                </button>
            `).join('');
        }

        initControls() {
            if (this._controlsInitialized) return;
            this._controlsInitialized = true;

            const self = this;

            document.addEventListener('click', function(e) {
                const speedDropdown = document.getElementById('tts-speed-dropdown');
                const modalOverlay = document.getElementById('tts-modal-overlay');

                // Voice button - open modal
                if (e.target.closest('#tts-voice-btn')) {
                    e.stopPropagation();
                    self.openModal();
                    return;
                }

                // Speed button
                if (e.target.closest('#tts-speed-btn')) {
                    e.stopPropagation();
                    speedDropdown?.classList.toggle('visible');
                    return;
                }

                // Speed option
                const speedOption = e.target.closest('.tts-speed-option');
                if (speedOption) {
                    e.stopPropagation();
                    const speed = parseFloat(speedOption.dataset.speed);
                    self.speed = speed;
                    document.querySelectorAll('.tts-speed-option').forEach(o => o.classList.remove('active'));
                    speedOption.classList.add('active');
                    const label = document.getElementById('tts-speed-label');
                    if (label) label.textContent = speed + 'x';
                    speedDropdown?.classList.remove('visible');
                    self.saveSettings();
                    return;
                }

                // Stop button
                if (e.target.closest('#tts-stop-btn')) {
                    self.stop();
                    return;
                }

                // Modal close
                if (e.target.closest('#tts-modal-close') || e.target === modalOverlay) {
                    self.closeModal();
                    return;
                }

                // Engine tabs
                const engineTab = e.target.closest('.tts-engine-tab');
                if (engineTab) {
                    const engine = engineTab.dataset.engine;
                    document.querySelectorAll('.tts-engine-tab').forEach(t => t.classList.remove('active'));
                    engineTab.classList.add('active');
                    document.querySelectorAll('.tts-engine-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tts-${engine}-content`)?.classList.add('active');
                    return;
                }

                // Puter engine selection
                const puterEngine = e.target.closest('.tts-puter-engine');
                if (puterEngine) {
                    document.querySelectorAll('.tts-puter-engine').forEach(p => p.classList.remove('active'));
                    puterEngine.classList.add('active');
                    return;
                }

                // Browser voice selection
                const browserVoice = e.target.closest('.tts-browser-voice');
                if (browserVoice) {
                    const idx = parseInt(browserVoice.dataset.voiceIndex);
                    if (!isNaN(idx) && self.voices[idx]) {
                        self.preferredVoice = self.voices[idx];
                        document.querySelectorAll('.tts-browser-voice').forEach(v => v.classList.remove('active'));
                        browserVoice.classList.add('active');
                    }
                    return;
                }

                // Show more voices
                if (e.target.closest('#tts-show-more-voices')) {
                    const btn = document.getElementById('tts-show-more-voices');
                    const container = document.getElementById('tts-browser-voices-other');
                    btn?.classList.toggle('expanded');
                    container?.classList.toggle('collapsed');
                    const span = btn?.querySelector('span');
                    if (span) span.textContent = btn?.classList.contains('expanded') ? 'Ocultar voces' : 'Mostrar m√°s voces';
                    return;
                }

                // Puter preview
                if (e.target.closest('#tts-puter-preview')) {
                    self.previewPuter();
                    return;
                }

                // Browser preview
                if (e.target.closest('#tts-browser-preview')) {
                    self.previewBrowser();
                    return;
                }

                // Save settings
                if (e.target.closest('#tts-save-settings')) {
                    self.saveModalSettings();
                    return;
                }

                // Close dropdown if clicking outside
                if (!e.target.closest('.tts-speed-dropdown')) {
                    speedDropdown?.classList.remove('visible');
                }
            });
        }

        openModal() {
            const overlay = document.getElementById('tts-modal-overlay');
            overlay?.classList.add('visible');

            // Sync UI with current settings
            const langSelect = document.getElementById('tts-puter-lang');
            if (langSelect) langSelect.value = this.puterLang;

            document.querySelectorAll('.tts-puter-engine').forEach(p => {
                p.classList.toggle('active', p.dataset.puterEngine === this.puterEngine);
            });

            document.querySelectorAll('.tts-engine-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.engine === this.engine);
            });

            document.querySelectorAll('.tts-engine-content').forEach(c => {
                c.classList.toggle('active', c.id === `tts-${this.engine}-content`);
            });
        }

        closeModal() {
            document.getElementById('tts-modal-overlay')?.classList.remove('visible');
        }

        saveModalSettings() {
            // Get selected engine
            const activeTab = document.querySelector('.tts-engine-tab.active');
            this.engine = activeTab?.dataset.engine || 'puter';

            // Get Puter settings
            const activePuterEngine = document.querySelector('.tts-puter-engine.active');
            this.puterEngine = activePuterEngine?.dataset.puterEngine || 'neural';
            const langSelect = document.getElementById('tts-puter-lang');
            this.puterLang = langSelect?.value || 'es-MX';

            this.saveSettings();
            this.updateCurrentEngineDisplay();
            this.closeModal();
        }

        updateCurrentEngineDisplay() {
            const display = document.getElementById('tts-current-engine');
            if (display) {
                if (this.engine === 'puter') {
                    const engineName = this.puterEngine.charAt(0).toUpperCase() + this.puterEngine.slice(1);
                    display.textContent = `Puter ${engineName}`;
                } else {
                    display.textContent = 'Navegador';
                }
            }
        }

        async previewPuter() {
            const btn = document.getElementById('tts-puter-preview');
            if (!window.puter) {
                alert('Puter.js no est√° disponible. Intenta recargar la p√°gina.');
                return;
            }

            const activePuterEngine = document.querySelector('.tts-puter-engine.active');
            const engine = activePuterEngine?.dataset.puterEngine || 'neural';
            const langSelect = document.getElementById('tts-puter-lang');
            const lang = langSelect?.value || 'es-MX';

            // Texto de preview seg√∫n idioma
            const previewTexts = {
                'es-ES': 'Hola, soy tu asistente de estudio personal desde Espa√±a.',
                'es-MX': 'Hola, soy tu asistente de estudio personal desde M√©xico.',
                'es-US': 'Hola, soy tu asistente de estudio personal. ¬°Bienvenido!',
                'cmn-CN': '‰Ω†Â•ΩÔºåÊàëÊòØ‰Ω†ÁöÑÂ≠¶‰π†Âä©Êâã„ÄÇ',
                'yue-CN': '‰Ω†Â•ΩÔºåÊàë‰øÇ‰Ω†ÂòÖÂ≠∏ÁøíÂä©Êâã„ÄÇ',
                'en-US': 'Hello, I am your personal study assistant.',
                'en-GB': 'Hello, I am your personal study assistant.',
                'pt-BR': 'Ol√°, sou seu assistente de estudos pessoal.',
                'fr-FR': 'Bonjour, je suis votre assistant d\'√©tudes personnel.',
                'de-DE': 'Hallo, ich bin Ihr pers√∂nlicher Lernassistent.',
                'it-IT': 'Ciao, sono il tuo assistente di studio personale.',
                'ja-JP': '„Åì„Çì„Å´„Å°„ÅØ„ÄÅÁßÅ„ÅØ„ÅÇ„Å™„Åü„ÅÆÂ≠¶Áøí„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ',
                'ko-KR': 'ÏïàÎÖïÌïòÏÑ∏Ïöî, Ï†ÄÎäî ÎãπÏã†Ïùò ÌïôÏäµ ÎèÑÏö∞ÎØ∏ÏûÖÎãàÎã§.'
            };
            const previewText = previewTexts[lang] || previewTexts['es-MX'];

            btn?.classList.add('playing');
            try {
                const audio = await puter.ai.txt2speech(previewText, {
                    engine: engine,
                    language: lang
                });
                audio.play();
                audio.onended = () => btn?.classList.remove('playing');
            } catch (e) {
                console.error('Puter TTS error:', e);
                btn?.classList.remove('playing');
            }
        }

        previewBrowser() {
            if (!this.synth) return;
            this.synth.cancel();

            const utterance = new SpeechSynthesisUtterance('Hola, soy tu asistente de estudio personal.');
            if (this.preferredVoice) utterance.voice = this.preferredVoice;
            utterance.rate = 1;

            const btn = document.getElementById('tts-browser-preview');
            btn?.classList.add('playing');
            utterance.onend = () => btn?.classList.remove('playing');
            this.synth.speak(utterance);
        }

        cleanTextForSpeech(text) {
            return text
                .replace(/```[\s\S]*?```/g, '')
                .replace(/`[^`]+`/g, '')
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/^#{1,6}\s+/gm, '')
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\*([^*]+)\*/g, '$1')
                .replace(/__([^_]+)__/g, '$1')
                .replace(/_([^_]+)_/g, '$1')
                .replace(/~~([^~]+)~~/g, '$1')
                .replace(/^>\s+/gm, '')
                .replace(/^[\-\*\+]\s+/gm, '')
                .replace(/^\d+\.\s+/gm, '')
                .replace(/^---+$/gm, '')
                .replace(/\n+/g, '. ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        async speak(text, messageElement) {
            this.stop();

            const cleanText = this.cleanTextForSpeech(text);
            if (!cleanText) return;

            this.currentMessageElement = messageElement;
            this.currentSpeakBtn = messageElement?.querySelector('.tts-speak-btn');

            if (this.engine === 'puter' && window.puter) {
                await this.speakWithPuter(cleanText);
            } else {
                this.speakWithBrowser(cleanText);
            }
        }

        async speakWithPuter(text) {
            try {
                this.updateUI('speaking');
                this.isSpeaking = true;

                this.currentAudio = await puter.ai.txt2speech(text, {
                    engine: this.puterEngine,
                    language: this.puterLang
                });

                this.currentAudio.playbackRate = this.speed;
                this.currentAudio.onended = () => {
                    this.isSpeaking = false;
                    this.updateUI('idle');
                };
                this.currentAudio.onerror = () => {
                    this.isSpeaking = false;
                    this.updateUI('idle');
                };
                this.currentAudio.play();
            } catch (e) {
                console.error('Puter TTS error:', e);
                // Fallback to browser
                this.speakWithBrowser(text);
            }
        }

        speakWithBrowser(text) {
            if (!this.synth) return;

            this.utterance = new SpeechSynthesisUtterance(text);
            this.utterance.rate = this.speed;
            if (this.preferredVoice) this.utterance.voice = this.preferredVoice;

            this.utterance.onstart = () => {
                this.isSpeaking = true;
                this.isPaused = false;
                this.updateUI('speaking');
            };
            this.utterance.onend = () => {
                this.isSpeaking = false;
                this.updateUI('idle');
            };
            this.utterance.onerror = () => {
                this.isSpeaking = false;
                this.updateUI('idle');
            };
            this.utterance.onpause = () => {
                this.isPaused = true;
                this.updateUI('paused');
            };
            this.utterance.onresume = () => {
                this.isPaused = false;
                this.updateUI('speaking');
            };

            this.synth.speak(this.utterance);
        }

        pause() {
            if (this.currentAudio && !this.currentAudio.paused) {
                this.currentAudio.pause();
                this.isPaused = true;
                this.updateUI('paused');
            } else if (this.synth && this.isSpeaking && !this.isPaused) {
                this.synth.pause();
            }
        }

        resume() {
            if (this.currentAudio && this.currentAudio.paused) {
                this.currentAudio.play();
                this.isPaused = false;
                this.updateUI('speaking');
            } else if (this.synth && this.isPaused) {
                this.synth.resume();
            }
        }

        toggle() {
            if (this.isPaused) {
                this.resume();
            } else if (this.isSpeaking) {
                this.pause();
            }
        }

        stop() {
            if (this.currentAudio) {
                this.currentAudio.pause();
                this.currentAudio.currentTime = 0;
                this.currentAudio = null;
            }
            if (this.synth) {
                this.synth.cancel();
            }
            this.isSpeaking = false;
            this.isPaused = false;
            this.updateUI('idle');
        }

        updateUI(state) {
            const stopBtn = document.getElementById('tts-stop-btn');
            const allSpeakBtns = document.querySelectorAll('.tts-speak-btn');

            allSpeakBtns.forEach(btn => {
                btn.classList.remove('speaking', 'paused');
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
            });

            document.querySelectorAll('.message.tts-reading').forEach(msg => {
                msg.classList.remove('tts-reading');
            });

            switch (state) {
                case 'speaking':
                    if (stopBtn) stopBtn.style.display = 'flex';
                    if (this.currentSpeakBtn) {
                        this.currentSpeakBtn.classList.add('speaking');
                        this.currentSpeakBtn.innerHTML = `
                            <i class="fas fa-pause"></i>
                            <div class="tts-wave">
                                <span></span><span></span><span></span><span></span><span></span>
                            </div>
                        `;
                    }
                    this.currentMessageElement?.classList.add('tts-reading');
                    break;
                case 'paused':
                    if (stopBtn) stopBtn.style.display = 'flex';
                    if (this.currentSpeakBtn) {
                        this.currentSpeakBtn.classList.add('paused');
                        this.currentSpeakBtn.innerHTML = '<i class="fas fa-play"></i>';
                    }
                    this.currentMessageElement?.classList.add('tts-reading');
                    break;
                case 'idle':
                default:
                    if (stopBtn) stopBtn.style.display = 'none';
                    break;
            }
        }
    }

    // Initialize TTS Manager globally
    window.ttsManager = new TTSManager();

    // Re-initialize after View Transitions
    document.addEventListener('astro:page-load', () => {
        if (window.ttsManager) {
            window.ttsManager.stop();
            window.ttsManager.initControls();
            window.ttsManager.populateBrowserVoices();
        }
    });
</script>

---
const base = import.meta.env.BASE_URL;
const currentPath = Astro.url.pathname;

// Determinar qué enlace está activo basado en la ruta actual
const isHome = currentPath.includes('/inicio');
const isStack = currentPath.includes('/stack');
const isArquitectura = currentPath.includes('/arquitectura');
const isRecursos = currentPath.includes('/recursos');
const isProyectos = currentPath.includes('/proyectos');
---

<header class="header" transition:persist>
    <div class="header-content">
        <a href={`${base}/inicio`} class="logo">
            <div class="logo-icon">
                <i class="fas fa-code"></i>
            </div>
            <div class="logo-text">
                <span class="logo-main">Duoc UC</span>
                <span class="logo-sub">Escuela de Informática</span>
            </div>
        </a>
        <nav class="nav">
            <a href={`${base}/inicio`} class={`nav-link ${isHome ? 'active' : ''}`}>Inicio</a>
            <a href={`${base}/stack`} class={`nav-link ${isStack ? 'active' : ''}`}>Stack</a>
            <a href={`${base}/arquitectura`} class={`nav-link ${isArquitectura ? 'active' : ''}`}>Arquitectura</a>
            <a href={`${base}/recursos`} class={`nav-link ${isRecursos ? 'active' : ''}`}>Recursos</a>
            <a href={`${base}/proyectos`} class={`nav-link ${isProyectos ? 'active' : ''}`}>Proyectos</a>
        </nav>
        <div class="header-actions">
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme" title="Cambiar tema">
                <i class="fas fa-moon" id="theme-icon-dark"></i>
                <i class="fas fa-sun" id="theme-icon-light"></i>
            </button>
            <div class="repo-icons">
                <a href="https://github.com/fos-duoc/Analista-Programador-Computacional-DuocUC" target="_blank" class="repo-icon-btn github" title="GitHub">
                    <i class="fab fa-github"></i>
                </a>
                <a href="https://gitlab.com/" target="_blank" class="repo-icon-btn gitlab" title="GitLab">
                    <i class="fab fa-gitlab"></i>
                </a>
                <a href="https://bitbucket.org/" target="_blank" class="repo-icon-btn bitbucket" title="BitBucket">
                    <i class="fab fa-bitbucket"></i>
                </a>
                <a href="https://dev.azure.com/" target="_blank" class="repo-icon-btn azure" title="Azure DevOps">
                    <i class="fab fa-microsoft"></i>
                </a>
            </div>
        </div>
    </div>
</header>

<script is:inline>
    // Theme toggle function - globally accessible
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        console.log('Theme toggled to:', newTheme);
    }

    // Initialize header functionality
    function initHeader() {
        const header = document.querySelector('.header');
        const themeToggle = document.getElementById('theme-toggle');

        // Header scroll effect
        function handleScroll() {
            if (window.scrollY > 50) {
                header?.classList.add('scrolled');
            } else {
                header?.classList.remove('scrolled');
            }
        }

        // Remove old listener and add new one
        window.removeEventListener('scroll', handleScroll);
        window.addEventListener('scroll', handleScroll);
        handleScroll();

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.onclick = function(e) {
                e.preventDefault();
                const href = this.getAttribute('href');
                if (href && href !== '#') {
                    const target = document.querySelector(href);
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            };
        });

        // Theme Toggle - Use onclick to avoid duplicate listeners
        if (themeToggle) {
            themeToggle.onclick = toggleTheme;
        }

        // Update active nav link
        updateActiveNavLink();
    }

    // Update active navigation link
    function updateActiveNavLink() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
            link.classList.remove('active');
            const href = link.getAttribute('href');
            if (href) {
                if (currentPath.includes('/inicio') && href.includes('/inicio')) {
                    link.classList.add('active');
                } else if (currentPath.includes('/stack') && href.includes('/stack')) {
                    link.classList.add('active');
                } else if (currentPath.includes('/arquitectura') && href.includes('/arquitectura')) {
                    link.classList.add('active');
                } else if (currentPath.includes('/recursos') && href.includes('/recursos')) {
                    link.classList.add('active');
                } else if (currentPath.includes('/proyectos') && href.includes('/proyectos')) {
                    link.classList.add('active');
                }
            }
        });
    }

    // Run on initial page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initHeader);
    } else {
        initHeader();
    }

    // Run after Astro view transitions
    document.addEventListener('astro:page-load', initHeader);

    // Preserve theme during transitions
    document.addEventListener('astro:before-swap', (event) => {
        const theme = localStorage.getItem('theme') || 'dark';
        event.newDocument.documentElement.setAttribute('data-theme', theme);
    });
</script>

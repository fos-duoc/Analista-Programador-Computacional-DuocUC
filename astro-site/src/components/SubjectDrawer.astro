---
/**
 * SubjectDrawer.astro
 * Panel lateral sofisticado para mostrar información detallada de asignaturas
 * Se activa al hacer clic en una asignatura desde la página Malla
 */
import { asignaturas, nombreCortoToId, type Asignatura } from '../data/asignaturas';

const base = import.meta.env.BASE_URL;
---

<!-- Overlay para cerrar el drawer al hacer clic fuera -->
<div id="subject-drawer-overlay" class="drawer-overlay"></div>

<!-- Drawer Panel -->
<aside id="subject-drawer" class="subject-drawer" aria-hidden="true" role="dialog" aria-labelledby="drawer-title">
    <!-- Header del Drawer -->
    <header class="drawer-header">
        <div class="drawer-header-content">
            <span class="drawer-badge" id="drawer-bimestre">B01</span>
            <span class="drawer-code" id="drawer-codigo">PRY1101</span>
        </div>
        <div class="drawer-controls">
            <button class="drawer-width-btn" id="drawer-width-toggle" aria-label="Expandir ancho" title="Expandir/Contraer ancho">
                <i class="fas fa-arrows-alt-h"></i>
            </button>
            <button class="drawer-close" aria-label="Cerrar panel" id="drawer-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </header>

    <!-- Contenido scrolleable -->
    <div class="drawer-body">
        <!-- Título y Créditos -->
        <div class="drawer-title-section">
            <h2 class="drawer-title" id="drawer-title">Nombre de la Asignatura</h2>
            <div class="drawer-credits">
                <span class="credit-item" id="drawer-creditos">
                    <i class="fas fa-graduation-cap"></i> 4 créditos
                </span>
                <span class="credit-item" id="drawer-horas">
                    <i class="fas fa-clock"></i> 6 hrs/sem
                </span>
            </div>
        </div>

        <!-- Descripción y Propósito -->
        <section class="drawer-section">
            <h3 class="section-title">
                <i class="fas fa-info-circle"></i> Descripción
            </h3>
            <p class="section-content" id="drawer-descripcion">
                Descripción de la asignatura...
            </p>
            <div class="proposito-box" id="drawer-proposito-box">
                <strong><i class="fas fa-bullseye"></i> Propósito:</strong>
                <span id="drawer-proposito">Propósito de la asignatura...</span>
            </div>
        </section>

        <!-- Objetivos de Aprendizaje -->
        <section class="drawer-section">
            <h3 class="section-title">
                <i class="fas fa-target"></i> Objetivos de Aprendizaje
            </h3>
            <ul class="objectives-list" id="drawer-objetivos">
                <li>Objetivo 1</li>
                <li>Objetivo 2</li>
            </ul>
        </section>

        <!-- Competencias -->
        <section class="drawer-section">
            <h3 class="section-title">
                <i class="fas fa-award"></i> Competencias
            </h3>
            <div class="competencias-tags" id="drawer-competencias">
                <span class="competencia-tag">Competencia 1</span>
            </div>
        </section>

        <!-- Experiencias de Aprendizaje -->
        <section class="drawer-section experiencias-section">
            <h3 class="section-title">
                <i class="fas fa-route"></i> Experiencias de Aprendizaje
            </h3>
            <div class="experiencias-accordion" id="drawer-experiencias">
                <!-- Se llenan dinámicamente -->
            </div>
        </section>

        <!-- Tecnologías -->
        <section class="drawer-section">
            <h3 class="section-title">
                <i class="fas fa-code"></i> Tecnologías
            </h3>
            <div class="tech-grid" id="drawer-tecnologias">
                <!-- Se llenan dinámicamente -->
            </div>
        </section>

        <!-- Evaluaciones -->
        <section class="drawer-section">
            <h3 class="section-title">
                <i class="fas fa-clipboard-check"></i> Sistema de Evaluación
            </h3>
            <div class="evaluaciones-list" id="drawer-evaluaciones">
                <!-- Se llenan dinámicamente -->
            </div>
        </section>

        <!-- Prerrequisitos y Conexiones -->
        <section class="drawer-section">
            <h3 class="section-title">
                <i class="fas fa-project-diagram"></i> Prerrequisitos y Conexiones
            </h3>
            <div class="connections-grid" id="drawer-conexiones">
                <div class="connection-box prereq-box">
                    <h4><i class="fas fa-arrow-left"></i> Prerrequisitos</h4>
                    <div id="drawer-prerrequisitos" class="connection-items">
                        <span class="no-prereq">Sin prerrequisitos</span>
                    </div>
                </div>
                <div class="connection-box next-box">
                    <h4><i class="fas fa-arrow-right"></i> Habilita para</h4>
                    <div id="drawer-habilita" class="connection-items">
                        <span class="connection-item">POO II</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recursos -->
        <section class="drawer-section">
            <h3 class="section-title">
                <i class="fas fa-book-open"></i> Recursos de Aprendizaje
            </h3>
            <div class="recursos-grid" id="drawer-recursos">
                <!-- Se llenan dinámicamente -->
            </div>
        </section>
    </div>

    <!-- Footer del Drawer -->
    <footer class="drawer-footer">
        <a href="#" class="drawer-cta" id="drawer-github-link" target="_blank">
            <i class="fab fa-github"></i> Ver materiales en GitHub
        </a>
    </footer>
</aside>

<style>
    /* ============================================
       DRAWER OVERLAY
       - Starts below header (70px) to keep navigation visible
       - Enterprise-grade UX pattern
    ============================================ */
    .drawer-overlay {
        position: fixed;
        top: 70px; /* Below header */
        left: 0;
        width: 100%;
        height: calc(100vh - 70px);
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
        z-index: 999; /* Below header (1000) */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .drawer-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* ============================================
       DRAWER PANEL - Compact Premium
       - Slides in from right, below header
       - Header and navigation always accessible
    ============================================ */
    .subject-drawer {
        position: fixed;
        top: 70px; /* Below header */
        right: 320px; /* Position to the left of AI Tutor (320px) */
        width: 440px;
        max-width: 95vw;
        height: calc(100vh - 70px);
        background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        border-left: 1px solid rgba(6, 182, 212, 0.3);
        z-index: 1001;
        transform: translateX(100%);
        visibility: hidden; /* Fallback: ensure drawer is hidden when off-screen */
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.4s ease, width 0.3s ease;
        display: flex;
        flex-direction: column;
        box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
        font-size: 0.78rem;
    }

    .subject-drawer.open {
        transform: translateX(0);
        visibility: visible;
    }

    /* Expanded width mode */
    .subject-drawer.expanded-width {
        width: 580px;
    }

    /* ============================================
       DRAWER HEADER - Compact Premium
    ============================================ */
    .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.85rem;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.12), rgba(139, 92, 246, 0.12));
        border-bottom: 1px solid rgba(6, 182, 212, 0.2);
        flex-shrink: 0;
    }

    .drawer-header-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .drawer-badge {
        background: linear-gradient(135deg, #06b6d4, #8b5cf6);
        color: white;
        padding: 0.25rem 0.55rem;
        border-radius: 15px;
        font-size: 0.62rem;
        font-weight: 700;
        font-family: 'Space Grotesk', monospace;
    }

    .drawer-code {
        color: #94a3b8;
        font-family: 'Space Grotesk', monospace;
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        background: rgba(148, 163, 184, 0.1);
        border-radius: 4px;
    }

    .drawer-controls {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .drawer-width-btn {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 1px solid rgba(6, 182, 212, 0.3);
        background: rgba(6, 182, 212, 0.1);
        color: #22d3ee;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.6rem;
    }

    .drawer-width-btn:hover {
        background: rgba(6, 182, 212, 0.2);
        border-color: rgba(6, 182, 212, 0.5);
    }

    .drawer-width-btn.active {
        background: rgba(6, 182, 212, 0.3);
        border-color: rgba(6, 182, 212, 0.6);
        color: #67e8f9;
    }

    .drawer-close {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        border: 1px solid rgba(239, 68, 68, 0.3);
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.65rem;
    }

    .drawer-close:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: #ef4444;
        transform: rotate(90deg);
    }

    /* ============================================
       DRAWER BODY (Scrollable) - Compact
    ============================================ */
    .drawer-body {
        flex: 1;
        overflow-y: auto;
        padding: 0.85rem;
        scrollbar-width: thin;
        scrollbar-color: rgba(6, 182, 212, 0.3) transparent;
    }

    .drawer-body::-webkit-scrollbar {
        width: 5px;
    }

    .drawer-body::-webkit-scrollbar-track {
        background: transparent;
    }

    .drawer-body::-webkit-scrollbar-thumb {
        background: rgba(6, 182, 212, 0.3);
        border-radius: 3px;
    }

    /* ============================================
       TITLE SECTION - Compact Premium Typography
    ============================================ */
    .drawer-title-section {
        margin-bottom: 1.1rem;
        padding-bottom: 0.85rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }

    .drawer-title {
        font-family: 'Sora', sans-serif;
        font-size: 1.05rem;
        font-weight: 700;
        color: #f8fafc;
        margin: 0 0 0.5rem 0;
        line-height: 1.3;
        letter-spacing: -0.01em;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .drawer-credits {
        display: flex;
        gap: 0.85rem;
    }

    .credit-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        color: #94a3b8;
        font-size: 0.65rem;
        font-weight: 500;
        font-family: 'Space Grotesk', sans-serif;
    }

    .credit-item i {
        color: #06b6d4;
        font-size: 0.65rem;
    }

    /* ============================================
       SECTIONS - Compact Typography
    ============================================ */
    .drawer-section {
        margin-bottom: 1rem;
    }

    .section-title {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 0.7rem;
        font-weight: 600;
        color: #e2e8f0;
        margin: 0 0 0.55rem 0;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        border-bottom: 1px solid rgba(6, 182, 212, 0.12);
        padding-bottom: 0.35rem;
    }

    .section-title i {
        color: #06b6d4;
        font-size: 0.65rem;
    }

    .section-content {
        color: #cbd5e1;
        font-size: 0.72rem;
        line-height: 1.55;
        margin: 0;
        font-family: 'Inter', system-ui, sans-serif;
    }

    /* Propósito Box - Compact Premium */
    .proposito-box {
        margin-top: 0.75rem;
        padding: 0.6rem 0.75rem;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), rgba(139, 92, 246, 0.08));
        border-radius: 8px;
        border-left: 3px solid #06b6d4;
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.08);
    }

    .proposito-box strong {
        color: #22d3ee;
        display: flex;
        align-items: center;
        gap: 0.35rem;
        margin-bottom: 0.3rem;
        font-size: 0.62rem;
        font-family: 'Space Grotesk', sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    .proposito-box span {
        color: #e2e8f0;
        font-size: 0.7rem;
        line-height: 1.5;
        font-family: 'Inter', system-ui, sans-serif;
    }

    /* Objectives List - Compact Premium */
    .objectives-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .objectives-list li {
        position: relative;
        padding: 0.35rem 0.55rem 0.35rem 1.4rem;
        color: #e2e8f0;
        font-size: 0.7rem;
        line-height: 1.45;
        font-family: 'Inter', system-ui, sans-serif;
        background: rgba(30, 41, 59, 0.3);
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .objectives-list li:hover {
        background: rgba(6, 182, 212, 0.08);
    }

    .objectives-list li::before {
        content: '';
        position: absolute;
        left: 0.55rem;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 6px;
        background: linear-gradient(135deg, #06b6d4, #8b5cf6);
        border-radius: 50%;
    }

    /* Competencias Tags - Compact Premium */
    .competencias-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .competencia-tag {
        background: rgba(6, 182, 212, 0.1);
        border: 1px solid rgba(6, 182, 212, 0.3);
        color: #67e8f9;
        padding: 0.3rem 0.55rem;
        border-radius: 12px;
        font-size: 0.62rem;
        font-weight: 500;
        font-family: 'Space Grotesk', sans-serif;
        transition: all 0.2s ease;
    }

    .competencia-tag:hover {
        background: rgba(6, 182, 212, 0.18);
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(6, 182, 212, 0.15);
    }

    /* ============================================
       EXPERIENCIAS ACCORDION - Compact
    ============================================ */
    .experiencias-accordion {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .exp-card {
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .exp-card:hover {
        border-color: rgba(6, 182, 212, 0.25);
    }

    .exp-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.55rem 0.7rem;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .exp-header:hover {
        background: rgba(6, 182, 212, 0.05);
    }

    .exp-header-left {
        display: flex;
        align-items: center;
        gap: 0.45rem;
    }

    .exp-number {
        width: 22px;
        height: 22px;
        background: linear-gradient(135deg, #06b6d4, #8b5cf6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.58rem;
        font-weight: 700;
        color: white;
    }

    .exp-info h4 {
        margin: 0;
        font-size: 0.68rem;
        font-weight: 600;
        color: #f1f5f9;
    }

    .exp-info span {
        font-size: 0.58rem;
        color: #94a3b8;
    }

    .exp-toggle {
        color: #64748b;
        transition: transform 0.3s ease;
        font-size: 0.6rem;
    }

    .exp-card.expanded .exp-toggle {
        transform: rotate(180deg);
        color: #06b6d4;
    }

    .exp-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
    }

    .exp-card.expanded .exp-content {
        max-height: 400px;
    }

    .exp-content-inner {
        padding: 0 0.7rem 0.6rem;
    }

    .exp-description {
        color: #94a3b8;
        font-size: 0.62rem;
        margin-bottom: 0.4rem;
        font-style: italic;
    }

    .exp-subsection {
        margin-bottom: 0.4rem;
    }

    .exp-subsection h5 {
        color: #e2e8f0;
        font-size: 0.58rem;
        margin: 0 0 0.25rem 0;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .exp-subsection h5 i {
        color: #06b6d4;
        font-size: 0.55rem;
    }

    .exp-subsection ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .exp-subsection li {
        position: relative;
        padding-left: 0.75rem;
        font-size: 0.6rem;
        color: #cbd5e1;
        margin-bottom: 0.2rem;
    }

    .exp-subsection li::before {
        content: '›';
        position: absolute;
        left: 0;
        color: #06b6d4;
        font-weight: bold;
    }

    /* ============================================
       TECNOLOGÍAS GRID - Compact
    ============================================ */
    .tech-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
    }

    .tech-chip {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.55rem;
        background: rgba(30, 41, 59, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.12);
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .tech-chip:hover {
        border-color: rgba(6, 182, 212, 0.35);
        background: rgba(6, 182, 212, 0.08);
        transform: translateY(-1px);
    }

    .tech-chip i,
    .tech-chip img {
        font-size: 0.9rem;
        width: 16px;
        height: 16px;
    }

    .tech-chip span {
        color: #e2e8f0;
        font-size: 0.6rem;
        font-weight: 500;
    }

    /* ============================================
       EVALUACIONES - Compact
    ============================================ */
    .evaluaciones-list {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .eval-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.4rem 0.6rem;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 6px;
        border-left: 2px solid var(--eval-color, #06b6d4);
    }

    .eval-item.formativa {
        --eval-color: #22c55e;
    }

    .eval-item.sumativa {
        --eval-color: #f59e0b;
    }

    .eval-item.prueba {
        --eval-color: #ef4444;
    }

    .eval-info h4 {
        margin: 0;
        font-size: 0.62rem;
        color: #f1f5f9;
        font-weight: 600;
    }

    .eval-info span {
        font-size: 0.55rem;
        color: #94a3b8;
    }

    .eval-percent {
        font-family: 'Space Grotesk', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--eval-color, #06b6d4);
    }

    /* ============================================
       CONEXIONES - Compact
    ============================================ */
    .connections-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
    }

    .connection-box {
        padding: 0.6rem;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .connection-box h4 {
        margin: 0 0 0.45rem 0;
        font-size: 0.58rem;
        color: #94a3b8;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .prereq-box h4 i { color: #f59e0b; font-size: 0.55rem; }
    .next-box h4 i { color: #22c55e; font-size: 0.55rem; }

    .connection-items {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .connection-item {
        padding: 0.25rem 0.45rem;
        background: rgba(6, 182, 212, 0.1);
        border-radius: 4px;
        font-size: 0.58rem;
        color: #67e8f9;
    }

    .no-prereq {
        color: #64748b;
        font-size: 0.58rem;
        font-style: italic;
    }

    /* ============================================
       RECURSOS - Compact
    ============================================ */
    .recursos-grid {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .recurso-link {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.4rem 0.6rem;
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.1);
        border-radius: 6px;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .recurso-link:hover {
        border-color: rgba(6, 182, 212, 0.35);
        background: rgba(6, 182, 212, 0.08);
        transform: translateX(3px);
    }

    .recurso-icon {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(139, 92, 246, 0.15));
        border-radius: 6px;
    }

    .recurso-icon i {
        color: #06b6d4;
        font-size: 0.7rem;
    }

    .recurso-info h5 {
        margin: 0;
        font-size: 0.62rem;
        color: #f1f5f9;
    }

    .recurso-info span {
        font-size: 0.55rem;
        color: #64748b;
    }

    /* ============================================
       DRAWER FOOTER - Compact
    ============================================ */
    .drawer-footer {
        padding: 0.5rem 0.85rem;
        border-top: 1px solid rgba(148, 163, 184, 0.1);
        flex-shrink: 0;
    }

    .drawer-cta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        width: 100%;
        padding: 0.55rem;
        background: linear-gradient(135deg, #06b6d4, #8b5cf6);
        border-radius: 8px;
        color: white;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.68rem;
        transition: all 0.3s ease;
    }

    .drawer-cta:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(6, 182, 212, 0.25);
    }

    /* ============================================
       LIGHT MODE
    ============================================ */
    :global([data-theme="light"]) .drawer-overlay {
        background: rgba(0, 0, 0, 0.4);
    }

    :global([data-theme="light"]) .subject-drawer {
        background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
        border-left-color: rgba(6, 182, 212, 0.4);
    }

    :global([data-theme="light"]) .drawer-header {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(139, 92, 246, 0.1));
    }

    :global([data-theme="light"]) .drawer-code {
        color: #475569;
        background: rgba(71, 85, 105, 0.1);
    }

    :global([data-theme="light"]) .drawer-title {
        color: #0f172a;
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    :global([data-theme="light"]) .section-title {
        color: #1e293b;
        border-bottom-color: rgba(6, 182, 212, 0.2);
    }

    :global([data-theme="light"]) .credit-item {
        color: #475569;
    }

    :global([data-theme="light"]) .section-content {
        color: #475569;
    }

    :global([data-theme="light"]) .proposito-box {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), rgba(139, 92, 246, 0.08));
    }

    :global([data-theme="light"]) .proposito-box span {
        color: #334155;
    }

    :global([data-theme="light"]) .objectives-list li {
        color: #475569;
    }

    :global([data-theme="light"]) .competencia-tag {
        background: rgba(6, 182, 212, 0.1);
        color: #0891b2;
    }

    :global([data-theme="light"]) .exp-card {
        background: rgba(241, 245, 249, 0.8);
        border-color: rgba(148, 163, 184, 0.2);
    }

    :global([data-theme="light"]) .exp-info h4 {
        color: #1e293b;
    }

    :global([data-theme="light"]) .exp-description {
        color: #64748b;
    }

    :global([data-theme="light"]) .exp-subsection h5 {
        color: #334155;
    }

    :global([data-theme="light"]) .exp-subsection li {
        color: #475569;
    }

    :global([data-theme="light"]) .tech-chip {
        background: rgba(241, 245, 249, 0.9);
        border-color: rgba(148, 163, 184, 0.2);
    }

    :global([data-theme="light"]) .tech-chip span {
        color: #334155;
    }

    :global([data-theme="light"]) .eval-item {
        background: rgba(241, 245, 249, 0.8);
    }

    :global([data-theme="light"]) .eval-info h4 {
        color: #1e293b;
    }

    :global([data-theme="light"]) .connection-box {
        background: rgba(241, 245, 249, 0.8);
    }

    :global([data-theme="light"]) .connection-item {
        background: rgba(6, 182, 212, 0.1);
        color: #0891b2;
    }

    :global([data-theme="light"]) .recurso-link {
        background: rgba(241, 245, 249, 0.8);
    }

    :global([data-theme="light"]) .recurso-info h5 {
        color: #1e293b;
    }

    :global([data-theme="light"]) .drawer-footer {
        background: #f8fafc;
    }

    /* ============================================
       RESPONSIVE
    ============================================ */
    @media (max-width: 900px) {
        .subject-drawer {
            right: 0 !important;
            width: 100%;
            max-width: 520px;
        }
    }

    @media (max-width: 600px) {
        .subject-drawer {
            width: 100%;
            max-width: 100%;
        }

        .drawer-title {
            font-size: 1.25rem;
        }

        .connections-grid {
            grid-template-columns: 1fr;
        }

        .drawer-credits {
            flex-direction: column;
            gap: 0.4rem;
        }
    }
</style>

<script define:vars={{ asignaturasData: asignaturas, nombreCortoToIdMap: nombreCortoToId }}>
    // Estado global del drawer
    window.subjectDrawerData = {
        asignaturas: asignaturasData,
        nombreCortoToId: nombreCortoToIdMap,
        currentSubject: null
    };

    // Función para abrir el drawer con una asignatura
    window.openSubjectDrawer = function(subjectId) {
        const data = window.subjectDrawerData;
        // asignaturas es un objeto Record, no un array - acceder por clave directamente
        const asignatura = data.asignaturas[subjectId];

        if (!asignatura) {
            console.warn('Asignatura no encontrada:', subjectId, 'Disponibles:', Object.keys(data.asignaturas));
            return;
        }

        data.currentSubject = asignatura;

        // Actualizar contenido del drawer
        updateDrawerContent(asignatura);

        // Abrir el drawer
        const drawer = document.getElementById('subject-drawer');
        const overlay = document.getElementById('subject-drawer-overlay');

        drawer?.classList.add('open');
        drawer?.setAttribute('aria-hidden', 'false');
        overlay?.classList.add('active');

        // Prevenir scroll del body
        document.body.style.overflow = 'hidden';
    };

    // Función para cerrar el drawer
    window.closeSubjectDrawer = function() {
        const drawer = document.getElementById('subject-drawer');
        const overlay = document.getElementById('subject-drawer-overlay');

        drawer?.classList.remove('open');
        drawer?.setAttribute('aria-hidden', 'true');
        overlay?.classList.remove('active');

        // Restaurar scroll del body
        document.body.style.overflow = '';
    };

    // Función para actualizar el contenido del drawer
    function updateDrawerContent(asignatura) {
        // Header
        document.getElementById('drawer-bimestre').textContent = `B${asignatura.bimestre.toString().padStart(2, '0')}`;
        document.getElementById('drawer-codigo').textContent = asignatura.codigo;

        // Título y créditos
        document.getElementById('drawer-title').textContent = asignatura.nombre;
        document.getElementById('drawer-creditos').innerHTML = `<i class="fas fa-graduation-cap"></i> ${asignatura.creditos} créditos`;
        const horasTotales = asignatura.horasTeoricas + asignatura.horasPracticas;
        document.getElementById('drawer-horas').innerHTML = `<i class="fas fa-clock"></i> ${horasTotales} hrs/sem`;

        // Descripción y propósito
        document.getElementById('drawer-descripcion').textContent = asignatura.descripcion;
        document.getElementById('drawer-proposito').textContent = asignatura.proposito;

        // Objetivos
        const objetivosHtml = asignatura.objetivos.map(obj => `<li>${obj}</li>`).join('');
        document.getElementById('drawer-objetivos').innerHTML = objetivosHtml;

        // Competencias
        const competenciasHtml = asignatura.competencias.map(comp =>
            `<span class="competencia-tag">${comp}</span>`
        ).join('');
        document.getElementById('drawer-competencias').innerHTML = competenciasHtml;

        // Experiencias
        const experienciasHtml = asignatura.experiencias.map((exp, index) => `
            <div class="exp-card" data-exp="${index}">
                <div class="exp-header" onclick="toggleExpCard(${index})">
                    <div class="exp-header-left">
                        <span class="exp-number">${exp.numero}</span>
                        <div class="exp-info">
                            <h4>${exp.titulo}</h4>
                            <span>${exp.semanas}</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down exp-toggle"></i>
                </div>
                <div class="exp-content">
                    <div class="exp-content-inner">
                        <p class="exp-description">${exp.descripcion}</p>
                        <div class="exp-subsection">
                            <h5><i class="fas fa-book"></i> Contenidos</h5>
                            <ul>
                                ${exp.contenidos.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="exp-subsection">
                            <h5><i class="fas fa-tasks"></i> Actividades</h5>
                            <ul>
                                ${exp.actividades.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('drawer-experiencias').innerHTML = experienciasHtml;

        // Tecnologías
        const techHtml = asignatura.tecnologias.map(tech => {
            let iconHtml = '';
            if (tech.iconType === 'devicon') {
                iconHtml = `<i class="devicon-${tech.icon}"></i>`;
            } else if (tech.iconType === 'fontawesome') {
                iconHtml = `<i class="${tech.icon}"></i>`;
            } else if (tech.iconType === 'simple') {
                iconHtml = `<img src="https://cdn.simpleicons.org/${tech.icon}" alt="${tech.nombre}">`;
            }
            return `<div class="tech-chip">${iconHtml}<span>${tech.nombre}</span></div>`;
        }).join('');
        document.getElementById('drawer-tecnologias').innerHTML = techHtml;

        // Evaluaciones
        const evalHtml = asignatura.evaluaciones.map(ev => {
            const tipoClass = ev.tipo.toLowerCase().includes('formativa') ? 'formativa' :
                             ev.tipo.toLowerCase().includes('sumativa') ? 'sumativa' : 'prueba';
            return `
                <div class="eval-item ${tipoClass}">
                    <div class="eval-info">
                        <h4>${ev.nombre}</h4>
                        <span>${ev.tipo}</span>
                    </div>
                    <span class="eval-percent">${ev.ponderacion}%</span>
                </div>
            `;
        }).join('');
        document.getElementById('drawer-evaluaciones').innerHTML = evalHtml;

        // Prerrequisitos
        const prereqHtml = asignatura.prerrequisitos.length > 0
            ? asignatura.prerrequisitos.map(p => `<span class="connection-item">${p}</span>`).join('')
            : '<span class="no-prereq">Sin prerrequisitos</span>';
        document.getElementById('drawer-prerrequisitos').innerHTML = prereqHtml;

        // Conexiones (habilita para)
        const conexHtml = asignatura.conexiones.length > 0
            ? asignatura.conexiones.map(c => `<span class="connection-item">${c}</span>`).join('')
            : '<span class="no-prereq">-</span>';
        document.getElementById('drawer-habilita').innerHTML = conexHtml;

        // Recursos
        const recursosHtml = asignatura.recursos.map(rec => {
            const iconClass = rec.tipo === 'GitHub' ? 'fab fa-github' :
                             rec.tipo === 'Documentación' ? 'fas fa-book' :
                             rec.tipo === 'Tutorial' ? 'fas fa-play-circle' : 'fas fa-link';
            return `
                <a href="${rec.url}" target="_blank" rel="noopener" class="recurso-link">
                    <div class="recurso-icon"><i class="${iconClass}"></i></div>
                    <div class="recurso-info">
                        <h5>${rec.nombre}</h5>
                        <span>${rec.tipo}</span>
                    </div>
                </a>
            `;
        }).join('');
        document.getElementById('drawer-recursos').innerHTML = recursosHtml;

        // Link de GitHub en footer
        const bimestreNum = asignatura.bimestre.toString().padStart(2, '0');
        document.getElementById('drawer-github-link').href =
            `https://github.com/fos-duoc/Analista-Programador-Computacional-DuocUC/tree/main/Bimestre-${bimestreNum}%20-%20`;
    }

    // Toggle para las cards de experiencias
    window.toggleExpCard = function(index) {
        const card = document.querySelector(`.exp-card[data-exp="${index}"]`);
        card?.classList.toggle('expanded');
    };

</script>

<!-- Script inline separado para event listeners - se ejecuta en cada View Transition -->
<script is:inline>
    (function initSubjectDrawerEvents() {
        // Flag para evitar múltiples listeners de Escape
        if (window._subjectDrawerEventsInitialized) return;

        function attachDrawerEvents() {
            const closeBtn = document.getElementById('drawer-close-btn');
            const overlay = document.getElementById('subject-drawer-overlay');
            const widthToggleBtn = document.getElementById('drawer-width-toggle');
            const drawer = document.getElementById('subject-drawer');

            // Usar onclick directo para evitar duplicados
            if (closeBtn) {
                closeBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (window.closeSubjectDrawer) {
                        window.closeSubjectDrawer();
                    }
                };
            }

            if (overlay) {
                overlay.onclick = function(e) {
                    e.preventDefault();
                    if (window.closeSubjectDrawer) {
                        window.closeSubjectDrawer();
                    }
                };
            }

            // Width toggle button
            if (widthToggleBtn && drawer) {
                widthToggleBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    drawer.classList.toggle('expanded-width');
                    widthToggleBtn.classList.toggle('active');
                };
            }
        }

        // Escape key - solo una vez
        if (!window._subjectDrawerEventsInitialized) {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && window.closeSubjectDrawer) {
                    window.closeSubjectDrawer();
                }
            });
            window._subjectDrawerEventsInitialized = true;
        }

        // Ejecutar inmediatamente
        attachDrawerEvents();

        // Re-attach después de View Transitions
        document.addEventListener('astro:page-load', attachDrawerEvents);
    })();
</script>

---
/**
 * TicketManager.astro
 * Gestor de Tickets estilo Jira / Azure DevOps
 * Basado en: Atlassian Jira, Azure DevOps Work Items
 */
---

<section id="ticket-manager" class="ticket-manager-section">
  <div class="ticket-header">
    <div class="header-icon">
      <i class="fab fa-jira"></i>
    </div>
    <div class="header-content">
      <h2>Ticket Manager</h2>
      <p>Gestiona issues, bugs y tareas como en Jira o Azure DevOps</p>
    </div>
    <div class="header-badges">
      <span class="badge jira">Jira Style</span>
      <span class="badge azure">Azure DevOps</span>
      <span class="badge github">GitHub Issues</span>
    </div>
  </div>

  <!-- Tipos de Work Items -->
  <div class="workitem-types">
    <div class="type-card" data-type="bug">
      <i class="fas fa-bug"></i>
      <h4>Bug</h4>
      <p>Defecto o error en el sistema</p>
    </div>
    <div class="type-card" data-type="feature">
      <i class="fas fa-star"></i>
      <h4>Feature</h4>
      <p>Nueva funcionalidad</p>
    </div>
    <div class="type-card" data-type="task">
      <i class="fas fa-check-square"></i>
      <h4>Task</h4>
      <p>Tarea t√©cnica o administrativa</p>
    </div>
    <div class="type-card" data-type="improvement">
      <i class="fas fa-arrow-up"></i>
      <h4>Improvement</h4>
      <p>Mejora de funcionalidad existente</p>
    </div>
    <div class="type-card" data-type="epic">
      <i class="fas fa-bolt"></i>
      <h4>Epic</h4>
      <p>Iniciativa grande con m√∫ltiples tickets</p>
    </div>
    <div class="type-card" data-type="spike">
      <i class="fas fa-flask"></i>
      <h4>Spike</h4>
      <p>Investigaci√≥n o prototipo</p>
    </div>
  </div>

  <div class="ticket-builder">
    <!-- Panel de Filtros y B√∫squeda -->
    <div class="filters-panel">
      <h3><i class="fas fa-filter"></i> Filtros</h3>

      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="ticket-search" placeholder="Buscar tickets...">
      </div>

      <div class="filter-group">
        <label>Tipo</label>
        <div class="filter-chips" id="type-filters">
          <button class="filter-chip active" data-filter="all">Todos</button>
          <button class="filter-chip" data-filter="bug"><i class="fas fa-bug"></i> Bug</button>
          <button class="filter-chip" data-filter="feature"><i class="fas fa-star"></i> Feature</button>
          <button class="filter-chip" data-filter="task"><i class="fas fa-check-square"></i> Task</button>
          <button class="filter-chip" data-filter="improvement"><i class="fas fa-arrow-up"></i> Improvement</button>
        </div>
      </div>

      <div class="filter-group">
        <label>Estado</label>
        <div class="filter-chips" id="status-filters">
          <button class="filter-chip active" data-filter="all">Todos</button>
          <button class="filter-chip" data-filter="open">Open</button>
          <button class="filter-chip" data-filter="in-progress">In Progress</button>
          <button class="filter-chip" data-filter="review">In Review</button>
          <button class="filter-chip" data-filter="done">Done</button>
          <button class="filter-chip" data-filter="closed">Closed</button>
        </div>
      </div>

      <div class="filter-group">
        <label>Prioridad</label>
        <div class="filter-chips" id="priority-filters">
          <button class="filter-chip active" data-filter="all">Todas</button>
          <button class="filter-chip" data-filter="critical">üî¥ Critical</button>
          <button class="filter-chip" data-filter="high">üü† High</button>
          <button class="filter-chip" data-filter="medium">üü° Medium</button>
          <button class="filter-chip" data-filter="low">üü¢ Low</button>
        </div>
      </div>

      <div class="filter-group">
        <label>Asignado a</label>
        <select id="assignee-filter">
          <option value="">Todos</option>
          <option value="unassigned">Sin asignar</option>
        </select>
      </div>

      <div class="quick-filters">
        <h4>Filtros R√°pidos</h4>
        <button class="quick-filter-btn" data-quick="my-tickets">
          <i class="fas fa-user"></i> Mis Tickets
        </button>
        <button class="quick-filter-btn" data-quick="recently-updated">
          <i class="fas fa-clock"></i> Actualizados Hoy
        </button>
        <button class="quick-filter-btn" data-quick="overdue">
          <i class="fas fa-exclamation-triangle"></i> Vencidos
        </button>
        <button class="quick-filter-btn" data-quick="no-assignee">
          <i class="fas fa-user-slash"></i> Sin Asignar
        </button>
      </div>
    </div>

    <!-- Panel Principal de Tickets -->
    <div class="tickets-panel">
      <div class="tickets-toolbar">
        <div class="toolbar-left">
          <button id="create-ticket-btn" class="btn-create">
            <i class="fas fa-plus"></i> Crear Ticket
          </button>
          <div class="view-toggle">
            <button class="view-btn active" data-view="list" title="Vista Lista">
              <i class="fas fa-list"></i>
            </button>
            <button class="view-btn" data-view="board" title="Vista Board">
              <i class="fas fa-columns"></i>
            </button>
            <button class="view-btn" data-view="table" title="Vista Tabla">
              <i class="fas fa-table"></i>
            </button>
          </div>
        </div>
        <div class="toolbar-right">
          <span class="ticket-count" id="ticket-count">0 tickets</span>
          <select id="sort-tickets">
            <option value="created-desc">M√°s recientes</option>
            <option value="created-asc">M√°s antiguos</option>
            <option value="priority-desc">Mayor prioridad</option>
            <option value="updated-desc">Actualizados recientemente</option>
          </select>
        </div>
      </div>

      <!-- Vista Lista -->
      <div id="tickets-list-view" class="tickets-view active">
        <div id="tickets-list" class="tickets-list">
          <div class="empty-state">
            <i class="fas fa-ticket-alt"></i>
            <h4>No hay tickets</h4>
            <p>Crea tu primer ticket o carga una plantilla</p>
          </div>
        </div>
      </div>

      <!-- Vista Board (Kanban) -->
      <div id="tickets-board-view" class="tickets-view">
        <div class="kanban-board">
          <div class="kanban-column" data-status="open">
            <div class="column-header">
              <span class="status-indicator open"></span>
              <span>Open</span>
              <span class="column-count" id="open-count">0</span>
            </div>
            <div class="column-content" id="open-column"></div>
          </div>
          <div class="kanban-column" data-status="in-progress">
            <div class="column-header">
              <span class="status-indicator in-progress"></span>
              <span>In Progress</span>
              <span class="column-count" id="in-progress-count">0</span>
            </div>
            <div class="column-content" id="in-progress-column"></div>
          </div>
          <div class="kanban-column" data-status="review">
            <div class="column-header">
              <span class="status-indicator review"></span>
              <span>In Review</span>
              <span class="column-count" id="review-count">0</span>
            </div>
            <div class="column-content" id="review-column"></div>
          </div>
          <div class="kanban-column" data-status="done">
            <div class="column-header">
              <span class="status-indicator done"></span>
              <span>Done</span>
              <span class="column-count" id="done-count">0</span>
            </div>
            <div class="column-content" id="done-column"></div>
          </div>
        </div>
      </div>

      <!-- Vista Tabla -->
      <div id="tickets-table-view" class="tickets-view">
        <div class="tickets-table-container">
          <table class="tickets-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Tipo</th>
                <th>T√≠tulo</th>
                <th>Estado</th>
                <th>Prioridad</th>
                <th>Asignado</th>
                <th>Creado</th>
              </tr>
            </thead>
            <tbody id="tickets-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Panel de Detalle / Formulario -->
    <div class="detail-panel" id="detail-panel">
      <div class="detail-header">
        <h3><i class="fas fa-ticket-alt"></i> <span id="detail-title">Detalle del Ticket</span></h3>
        <button id="close-detail" class="btn-close-detail">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="ticket-form" class="ticket-form">
        <input type="hidden" id="ticket-id">

        <div class="form-row">
          <div class="form-group full">
            <label>T√≠tulo <span class="required">*</span></label>
            <input type="text" id="ticket-title" placeholder="Describe brevemente el ticket">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tipo</label>
            <select id="ticket-type">
              <option value="bug">üêõ Bug</option>
              <option value="feature">‚≠ê Feature</option>
              <option value="task">‚úÖ Task</option>
              <option value="improvement">‚¨ÜÔ∏è Improvement</option>
              <option value="epic">‚ö° Epic</option>
              <option value="spike">üß™ Spike</option>
            </select>
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select id="ticket-status">
              <option value="open">Open</option>
              <option value="in-progress">In Progress</option>
              <option value="review">In Review</option>
              <option value="done">Done</option>
              <option value="closed">Closed</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Prioridad</label>
            <select id="ticket-priority">
              <option value="critical">üî¥ Critical</option>
              <option value="high">üü† High</option>
              <option value="medium" selected>üü° Medium</option>
              <option value="low">üü¢ Low</option>
            </select>
          </div>
          <div class="form-group">
            <label>Asignado a</label>
            <input type="text" id="ticket-assignee" placeholder="Nombre del responsable">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Reportado por</label>
            <input type="text" id="ticket-reporter" placeholder="Nombre del reportador">
          </div>
          <div class="form-group">
            <label>Fecha l√≠mite</label>
            <input type="date" id="ticket-due-date">
          </div>
        </div>

        <div class="form-group full">
          <label>Descripci√≥n</label>
          <textarea id="ticket-description" rows="4" placeholder="Describe el ticket en detalle..."></textarea>
        </div>

        <!-- Campos espec√≠ficos para Bug -->
        <div id="bug-fields" class="conditional-fields hidden">
          <h4><i class="fas fa-bug"></i> Informaci√≥n del Bug</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Pasos para reproducir</label>
              <textarea id="bug-steps" rows="3" placeholder="1. Ir a...&#10;2. Hacer clic en...&#10;3. Observar..."></textarea>
            </div>
            <div class="form-group">
              <label>Resultado esperado</label>
              <textarea id="bug-expected" rows="2" placeholder="¬øQu√© deber√≠a pasar?"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Resultado actual</label>
              <textarea id="bug-actual" rows="2" placeholder="¬øQu√© est√° pasando?"></textarea>
            </div>
            <div class="form-group">
              <label>Entorno</label>
              <input type="text" id="bug-environment" placeholder="Browser, OS, versi√≥n...">
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Labels</label>
            <input type="text" id="ticket-labels" placeholder="frontend, backend, api... (separados por coma)">
          </div>
          <div class="form-group">
            <label>Story Points</label>
            <select id="ticket-points">
              <option value="">-</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="5">5</option>
              <option value="8">8</option>
              <option value="13">13</option>
              <option value="21">21</option>
            </select>
          </div>
        </div>

        <div class="form-group full">
          <label>Epic / Parent</label>
          <select id="ticket-epic">
            <option value="">Sin Epic</option>
          </select>
        </div>

        <!-- Attachments -->
        <div class="form-group full">
          <label>Adjuntos</label>
          <div class="attachments-area" id="attachments-area">
            <i class="fas fa-paperclip"></i>
            <span>Arrastra archivos aqu√≠ o haz clic para seleccionar</span>
          </div>
          <div id="attachments-list" class="attachments-list"></div>
        </div>

        <!-- Comments -->
        <div class="comments-section">
          <h4><i class="fas fa-comments"></i> Comentarios</h4>
          <div id="comments-list" class="comments-list"></div>
          <div class="add-comment">
            <textarea id="new-comment" rows="2" placeholder="Escribe un comentario..."></textarea>
            <button id="add-comment-btn" class="btn-comment">
              <i class="fas fa-paper-plane"></i> Comentar
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button id="cancel-ticket" class="btn-cancel">Cancelar</button>
          <button id="save-ticket" class="btn-save">Guardar Ticket</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Plantillas R√°pidas -->
  <div class="templates-section">
    <h3><i class="fas fa-magic"></i> Plantillas de Proyecto</h3>
    <div class="templates-grid">
      <button class="template-card" data-template="software">
        <div class="template-icon"><i class="fas fa-code"></i></div>
        <h4>Software Development</h4>
        <p>Bugs, features, tasks t√≠picos</p>
      </button>
      <button class="template-card" data-template="support">
        <div class="template-icon"><i class="fas fa-headset"></i></div>
        <h4>Customer Support</h4>
        <p>Tickets de soporte al cliente</p>
      </button>
      <button class="template-card" data-template="marketing">
        <div class="template-icon"><i class="fas fa-bullhorn"></i></div>
        <h4>Marketing Campaign</h4>
        <p>Tareas de campa√±a marketing</p>
      </button>
      <button class="template-card" data-template="devops">
        <div class="template-icon"><i class="fas fa-server"></i></div>
        <h4>DevOps & Infrastructure</h4>
        <p>Tickets de infraestructura</p>
      </button>
    </div>
  </div>

  <!-- Exportar -->
  <div class="export-section">
    <h3><i class="fas fa-file-export"></i> Exportar Tickets</h3>
    <div class="export-buttons">
      <button id="export-jira-csv" class="export-btn">
        <i class="fab fa-jira"></i> Jira CSV
      </button>
      <button id="export-azure-csv" class="export-btn">
        <i class="fab fa-microsoft"></i> Azure DevOps
      </button>
      <button id="export-github-json" class="export-btn">
        <i class="fab fa-github"></i> GitHub Issues
      </button>
      <button id="export-markdown" class="export-btn">
        <i class="fab fa-markdown"></i> Markdown
      </button>
    </div>
  </div>
</section>

<style>
  .ticket-manager-section {
    padding: 2rem;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
    border-radius: 16px;
    border: 1px solid rgba(6, 182, 212, 0.2);
  }

  .ticket-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(6, 182, 212, 0.2);
    flex-wrap: wrap;
  }

  .header-icon {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(6, 182, 212, 0.15);
    border-radius: 12px;
    border: 1px solid rgba(6, 182, 212, 0.3);
  }

  .header-icon i {
    font-size: 1.75rem;
    color: #06b6d4;
  }

  .header-content h2 {
    margin: 0;
    font-size: 1.75rem;
    background: linear-gradient(135deg, #06b6d4, #22d3ee);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header-content p {
    margin: 0.25rem 0 0;
    color: #94a3b8;
    font-size: 0.95rem;
  }

  .header-badges {
    display: flex;
    gap: 0.5rem;
    margin-left: auto;
    flex-wrap: wrap;
  }

  .badge {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge.jira {
    background: rgba(0, 82, 204, 0.2);
    color: #2684FF;
    border: 1px solid rgba(0, 82, 204, 0.4);
  }

  .badge.azure {
    background: rgba(0, 120, 212, 0.2);
    color: #0078d4;
    border: 1px solid rgba(0, 120, 212, 0.4);
  }

  .badge.github {
    background: rgba(100, 100, 100, 0.2);
    color: #f8fafc;
    border: 1px solid rgba(100, 100, 100, 0.4);
  }

  /* Work Item Types */
  .workitem-types {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .type-card {
    background: rgba(30, 41, 59, 0.6);
    padding: 1rem;
    border-radius: 10px;
    border: 1px solid rgba(6, 182, 212, 0.2);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .type-card:hover {
    transform: translateY(-3px);
    border-color: rgba(6, 182, 212, 0.4);
    box-shadow: 0 8px 20px rgba(6, 182, 212, 0.15);
  }

  .type-card i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .type-card[data-type="bug"] i { color: #ef4444; }
  .type-card[data-type="feature"] i { color: #8b5cf6; }
  .type-card[data-type="task"] i { color: #06b6d4; }
  .type-card[data-type="improvement"] i { color: #22c55e; }
  .type-card[data-type="epic"] i { color: #f59e0b; }
  .type-card[data-type="spike"] i { color: #ec4899; }

  .type-card h4 {
    margin: 0 0 0.25rem;
    color: #f8fafc;
    font-size: 0.9rem;
  }

  .type-card p {
    margin: 0;
    color: #64748b;
    font-size: 0.75rem;
  }

  /* Builder Layout */
  .ticket-builder {
    display: grid;
    grid-template-columns: 250px 1fr 350px;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 1200px) {
    .ticket-builder {
      grid-template-columns: 1fr;
    }

    .detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      max-width: 450px;
      height: 100vh;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .detail-panel.open {
      transform: translateX(0);
    }
  }

  /* Filters Panel */
  .filters-panel {
    background: rgba(30, 41, 59, 0.6);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid rgba(6, 182, 212, 0.2);
  }

  .filters-panel h3 {
    margin: 0 0 1rem;
    color: #f8fafc;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filters-panel h3 i {
    color: #06b6d4;
  }

  .search-box {
    position: relative;
    margin-bottom: 1rem;
  }

  .search-box i {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #64748b;
  }

  .search-box input {
    width: 100%;
    padding: 0.6rem 0.75rem 0.6rem 2.25rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 6px;
    color: #f8fafc;
    font-size: 0.85rem;
  }

  .search-box input:focus {
    outline: none;
    border-color: #06b6d4;
  }

  .filter-group {
    margin-bottom: 1rem;
  }

  .filter-group label {
    display: block;
    color: #94a3b8;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .filter-chip {
    padding: 0.35rem 0.6rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 15px;
    color: #94a3b8;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .filter-chip:hover,
  .filter-chip.active {
    background: rgba(6, 182, 212, 0.15);
    border-color: rgba(6, 182, 212, 0.4);
    color: #06b6d4;
  }

  .filter-group select {
    width: 100%;
    padding: 0.5rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 6px;
    color: #f8fafc;
    font-size: 0.85rem;
  }

  .quick-filters {
    border-top: 1px solid rgba(6, 182, 212, 0.2);
    padding-top: 1rem;
    margin-top: 1rem;
  }

  .quick-filters h4 {
    margin: 0 0 0.75rem;
    color: #94a3b8;
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  .quick-filter-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem;
    background: transparent;
    border: 1px solid rgba(6, 182, 212, 0.15);
    border-radius: 6px;
    color: #94a3b8;
    font-size: 0.8rem;
    cursor: pointer;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
  }

  .quick-filter-btn:hover {
    background: rgba(6, 182, 212, 0.1);
    color: #06b6d4;
  }

  /* Tickets Panel */
  .tickets-panel {
    background: rgba(30, 41, 59, 0.6);
    border-radius: 12px;
    border: 1px solid rgba(6, 182, 212, 0.2);
    overflow: hidden;
  }

  .tickets-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(15, 23, 42, 0.6);
    border-bottom: 1px solid rgba(6, 182, 212, 0.2);
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .toolbar-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .btn-create {
    padding: 0.5rem 1rem;
    background: #06b6d4;
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    transition: all 0.2s ease;
  }

  .btn-create:hover {
    background: #0891b2;
    transform: translateY(-1px);
  }

  .view-toggle {
    display: flex;
    background: rgba(15, 23, 42, 0.6);
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid rgba(6, 182, 212, 0.2);
  }

  .view-btn {
    padding: 0.4rem 0.6rem;
    background: transparent;
    border: none;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .view-btn:hover,
  .view-btn.active {
    background: rgba(6, 182, 212, 0.2);
    color: #06b6d4;
  }

  .toolbar-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .ticket-count {
    color: #64748b;
    font-size: 0.85rem;
  }

  #sort-tickets {
    padding: 0.4rem 0.6rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 6px;
    color: #f8fafc;
    font-size: 0.8rem;
  }

  /* Tickets Views */
  .tickets-view {
    display: none;
    min-height: 400px;
  }

  .tickets-view.active {
    display: block;
  }

  .tickets-list {
    padding: 1rem;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: #64748b;
    text-align: center;
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-state h4 {
    margin: 0 0 0.5rem;
    color: #94a3b8;
  }

  /* Ticket Item */
  .ticket-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 0.75rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.15);
    border-radius: 8px;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .ticket-item:hover {
    border-color: rgba(6, 182, 212, 0.4);
    transform: translateX(3px);
  }

  .ticket-type-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 0.9rem;
  }

  .ticket-type-icon.bug { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
  .ticket-type-icon.feature { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
  .ticket-type-icon.task { background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
  .ticket-type-icon.improvement { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
  .ticket-type-icon.epic { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
  .ticket-type-icon.spike { background: rgba(236, 72, 153, 0.2); color: #ec4899; }

  .ticket-content {
    flex: 1;
    min-width: 0;
  }

  .ticket-header-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.35rem;
  }

  .ticket-id {
    font-size: 0.75rem;
    color: #06b6d4;
    font-weight: 600;
  }

  .ticket-title-text {
    font-size: 0.9rem;
    color: #f8fafc;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .ticket-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .status-badge {
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-badge.open { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
  .status-badge.in-progress { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
  .status-badge.review { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
  .status-badge.done { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
  .status-badge.closed { background: rgba(100, 116, 139, 0.3); color: #64748b; }

  .priority-indicator {
    font-size: 0.7rem;
  }

  .ticket-assignee {
    font-size: 0.75rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .ticket-labels {
    display: flex;
    gap: 0.25rem;
  }

  .label-tag {
    padding: 0.1rem 0.4rem;
    background: rgba(6, 182, 212, 0.15);
    border-radius: 4px;
    font-size: 0.65rem;
    color: #06b6d4;
  }

  /* Kanban Board */
  .kanban-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    padding: 1rem;
    overflow-x: auto;
  }

  @media (max-width: 900px) {
    .kanban-board {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .kanban-column {
    background: rgba(15, 23, 42, 0.4);
    border-radius: 8px;
    min-height: 300px;
  }

  .kanban-column .column-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    border-bottom: 1px solid rgba(6, 182, 212, 0.1);
    font-size: 0.85rem;
    color: #f8fafc;
    font-weight: 600;
  }

  .status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .status-indicator.open { background: #64748b; }
  .status-indicator.in-progress { background: #3b82f6; }
  .status-indicator.review { background: #f59e0b; }
  .status-indicator.done { background: #22c55e; }

  .kanban-column .column-count {
    margin-left: auto;
    background: rgba(6, 182, 212, 0.2);
    color: #06b6d4;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
  }

  .kanban-column .column-content {
    padding: 0.5rem;
    min-height: 250px;
  }

  .kanban-card {
    background: rgba(30, 41, 59, 0.8);
    border: 1px solid rgba(6, 182, 212, 0.15);
    border-radius: 6px;
    padding: 0.6rem;
    margin-bottom: 0.5rem;
    cursor: grab;
    transition: all 0.2s ease;
  }

  .kanban-card:hover {
    border-color: rgba(6, 182, 212, 0.4);
  }

  .kanban-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
  }

  .kanban-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.35rem;
  }

  .kanban-card-title {
    font-size: 0.8rem;
    color: #f8fafc;
    margin-bottom: 0.35rem;
  }

  .kanban-card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.7rem;
  }

  /* Table View */
  .tickets-table-container {
    overflow-x: auto;
    padding: 1rem;
  }

  .tickets-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .tickets-table th {
    text-align: left;
    padding: 0.75rem;
    background: rgba(15, 23, 42, 0.6);
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    border-bottom: 1px solid rgba(6, 182, 212, 0.2);
  }

  .tickets-table td {
    padding: 0.75rem;
    border-bottom: 1px solid rgba(6, 182, 212, 0.1);
    color: #f8fafc;
  }

  .tickets-table tr:hover td {
    background: rgba(6, 182, 212, 0.05);
  }

  /* Detail Panel */
  .detail-panel {
    background: rgba(30, 41, 59, 0.95);
    border-radius: 12px;
    border: 1px solid rgba(6, 182, 212, 0.2);
    overflow: hidden;
  }

  .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(15, 23, 42, 0.6);
    border-bottom: 1px solid rgba(6, 182, 212, 0.2);
  }

  .detail-header h3 {
    margin: 0;
    color: #f8fafc;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .detail-header h3 i {
    color: #06b6d4;
  }

  .btn-close-detail {
    padding: 0.35rem 0.5rem;
    background: transparent;
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 4px;
    color: #ef4444;
    cursor: pointer;
  }

  .ticket-form {
    padding: 1rem;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .form-group {
    margin-bottom: 0.75rem;
  }

  .form-group.full {
    grid-column: span 2;
  }

  @media (max-width: 600px) {
    .form-row {
      grid-template-columns: 1fr;
    }
    .form-group.full {
      grid-column: span 1;
    }
  }

  .form-group label {
    display: block;
    color: #94a3b8;
    font-size: 0.75rem;
    margin-bottom: 0.35rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .form-group label .required {
    color: #ef4444;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.5rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 6px;
    color: #f8fafc;
    font-size: 0.85rem;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #06b6d4;
  }

  .conditional-fields {
    margin: 1rem 0;
    padding: 1rem;
    background: rgba(239, 68, 68, 0.05);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 8px;
  }

  .conditional-fields.hidden {
    display: none;
  }

  .conditional-fields h4 {
    margin: 0 0 1rem;
    color: #ef4444;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Attachments */
  .attachments-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    border: 2px dashed rgba(6, 182, 212, 0.3);
    border-radius: 8px;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .attachments-area:hover {
    border-color: #06b6d4;
    background: rgba(6, 182, 212, 0.05);
  }

  .attachments-area i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .attachments-list {
    margin-top: 0.5rem;
  }

  /* Comments */
  .comments-section {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(6, 182, 212, 0.2);
  }

  .comments-section h4 {
    margin: 0 0 1rem;
    color: #f8fafc;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .comments-section h4 i {
    color: #06b6d4;
  }

  .comments-list {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 1rem;
  }

  .comment-item {
    padding: 0.75rem;
    background: rgba(15, 23, 42, 0.4);
    border-radius: 6px;
    margin-bottom: 0.5rem;
  }

  .comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.35rem;
  }

  .comment-author {
    color: #06b6d4;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .comment-date {
    color: #64748b;
    font-size: 0.7rem;
  }

  .comment-text {
    color: #e2e8f0;
    font-size: 0.85rem;
  }

  .add-comment {
    display: flex;
    gap: 0.5rem;
  }

  .add-comment textarea {
    flex: 1;
    padding: 0.5rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 6px;
    color: #f8fafc;
    font-size: 0.85rem;
    resize: none;
  }

  .btn-comment {
    padding: 0.5rem 0.75rem;
    background: #06b6d4;
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  /* Form Actions */
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(6, 182, 212, 0.2);
  }

  .btn-cancel {
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid rgba(100, 116, 139, 0.3);
    border-radius: 6px;
    color: #94a3b8;
    cursor: pointer;
  }

  .btn-save {
    padding: 0.5rem 1rem;
    background: #06b6d4;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
  }

  .btn-save:hover {
    background: #0891b2;
  }

  /* Templates Section */
  .templates-section {
    margin-bottom: 2rem;
  }

  .templates-section h3 {
    margin: 0 0 1rem;
    color: #f8fafc;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .templates-section h3 i {
    color: #fbbf24;
  }

  .templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .template-card {
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .template-card:hover {
    transform: translateY(-3px);
    border-color: rgba(6, 182, 212, 0.5);
    box-shadow: 0 8px 25px rgba(6, 182, 212, 0.15);
  }

  .template-icon {
    width: 50px;
    height: 50px;
    margin: 0 auto 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(6, 182, 212, 0.1);
    border-radius: 12px;
    font-size: 1.5rem;
    color: #06b6d4;
  }

  .template-card h4 {
    margin: 0 0 0.35rem;
    color: #f8fafc;
    font-size: 0.95rem;
  }

  .template-card p {
    margin: 0;
    color: #64748b;
    font-size: 0.8rem;
  }

  /* Export Section */
  .export-section h3 {
    margin: 0 0 1rem;
    color: #f8fafc;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .export-section h3 i {
    color: #06b6d4;
  }

  .export-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .export-btn {
    padding: 0.6rem 1rem;
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 8px;
    color: #94a3b8;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }

  .export-btn:hover {
    background: rgba(6, 182, 212, 0.1);
    border-color: rgba(6, 182, 212, 0.4);
    color: #06b6d4;
  }

  .export-btn i {
    font-size: 1rem;
  }

  /* Light Mode */
  :global(.light-mode) .ticket-manager-section {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.98), rgba(241, 245, 249, 0.98));
    border-color: rgba(6, 182, 212, 0.15);
  }

  :global(.light-mode) .header-content h2 {
    -webkit-text-fill-color: #0891b2;
  }

  :global(.light-mode) .header-content p {
    color: #475569;
  }

  :global(.light-mode) .type-card,
  :global(.light-mode) .filters-panel,
  :global(.light-mode) .tickets-panel,
  :global(.light-mode) .detail-panel,
  :global(.light-mode) .template-card,
  :global(.light-mode) .export-btn {
    background: rgba(255, 255, 255, 0.8);
    border-color: rgba(6, 182, 212, 0.15);
  }

  :global(.light-mode) .type-card h4,
  :global(.light-mode) .filters-panel h3,
  :global(.light-mode) .detail-header h3,
  :global(.light-mode) .templates-section h3,
  :global(.light-mode) .export-section h3,
  :global(.light-mode) .template-card h4 {
    color: #0f172a;
  }

  :global(.light-mode) .search-box input,
  :global(.light-mode) .filter-group select,
  :global(.light-mode) .form-group input,
  :global(.light-mode) .form-group select,
  :global(.light-mode) .form-group textarea,
  :global(.light-mode) #sort-tickets {
    background: rgba(248, 250, 252, 0.9);
    border-color: rgba(6, 182, 212, 0.2);
    color: #0f172a;
  }

  :global(.light-mode) .ticket-item,
  :global(.light-mode) .kanban-card {
    background: rgba(248, 250, 252, 0.9);
  }

  :global(.light-mode) .ticket-title-text,
  :global(.light-mode) .kanban-card-title {
    color: #0f172a;
  }
</style>

<script is:inline>
  document.addEventListener('astro:page-load', () => {
    // Estado
    let tickets = [];
    let ticketCounter = 0;
    let editingTicketId = null;
    let currentView = 'list';
    let filters = { type: 'all', status: 'all', priority: 'all', assignee: '', search: '' };

    // Elements
    const ticketsList = document.getElementById('tickets-list');
    const detailPanel = document.getElementById('detail-panel');
    const ticketForm = document.getElementById('ticket-form');

    // Templates
    const templates = {
      software: [
        { type: 'bug', title: 'Login no funciona en Safari', priority: 'high', status: 'open', labels: ['frontend', 'auth'] },
        { type: 'bug', title: 'Error 500 al guardar formulario', priority: 'critical', status: 'in-progress', labels: ['backend', 'api'] },
        { type: 'feature', title: 'Implementar autenticaci√≥n OAuth2', priority: 'high', status: 'open', labels: ['auth', 'security'] },
        { type: 'feature', title: 'Dashboard de analytics', priority: 'medium', status: 'open', labels: ['frontend', 'analytics'] },
        { type: 'task', title: 'Actualizar dependencias npm', priority: 'low', status: 'open', labels: ['devops'] },
        { type: 'improvement', title: 'Optimizar queries de base de datos', priority: 'medium', status: 'review', labels: ['backend', 'performance'] },
        { type: 'spike', title: 'Investigar migraci√≥n a microservicios', priority: 'medium', status: 'in-progress', labels: ['architecture'] }
      ],
      support: [
        { type: 'bug', title: 'Cliente reporta datos incorrectos en factura', priority: 'high', status: 'open', labels: ['billing', 'urgent'] },
        { type: 'task', title: 'Responder consulta sobre pol√≠tica de devoluci√≥n', priority: 'medium', status: 'open', labels: ['customer-service'] },
        { type: 'feature', title: 'Solicitud: exportar reportes en Excel', priority: 'medium', status: 'open', labels: ['feature-request'] },
        { type: 'bug', title: 'Usuario no puede resetear contrase√±a', priority: 'critical', status: 'in-progress', labels: ['auth', 'urgent'] },
        { type: 'improvement', title: 'Mejorar FAQ con preguntas frecuentes', priority: 'low', status: 'open', labels: ['documentation'] }
      ],
      marketing: [
        { type: 'task', title: 'Crear banners para campa√±a de verano', priority: 'high', status: 'open', labels: ['design', 'campaign'] },
        { type: 'task', title: 'Redactar copy para email marketing', priority: 'medium', status: 'in-progress', labels: ['content', 'email'] },
        { type: 'feature', title: 'Landing page para Black Friday', priority: 'high', status: 'open', labels: ['web', 'campaign'] },
        { type: 'task', title: 'Configurar p√≠xel de Facebook Ads', priority: 'medium', status: 'open', labels: ['analytics', 'ads'] },
        { type: 'improvement', title: 'A/B test en botones de CTA', priority: 'medium', status: 'review', labels: ['ux', 'conversion'] },
        { type: 'task', title: 'An√°lisis de competencia Q4', priority: 'low', status: 'open', labels: ['research'] }
      ],
      devops: [
        { type: 'task', title: 'Configurar pipeline CI/CD en GitLab', priority: 'high', status: 'in-progress', labels: ['ci-cd', 'gitlab'] },
        { type: 'bug', title: 'Deployment falla en producci√≥n', priority: 'critical', status: 'open', labels: ['deployment', 'urgent'] },
        { type: 'feature', title: 'Implementar monitoreo con Prometheus', priority: 'high', status: 'open', labels: ['monitoring', 'observability'] },
        { type: 'task', title: 'Backup autom√°tico de base de datos', priority: 'high', status: 'done', labels: ['database', 'backup'] },
        { type: 'improvement', title: 'Optimizar im√°genes Docker', priority: 'medium', status: 'open', labels: ['docker', 'optimization'] },
        { type: 'spike', title: 'Evaluar Kubernetes vs Docker Swarm', priority: 'medium', status: 'review', labels: ['infrastructure', 'research'] },
        { type: 'task', title: 'Renovar certificados SSL', priority: 'high', status: 'open', labels: ['security', 'ssl'] }
      ]
    };

    // Create Ticket
    function showCreateForm(type = 'task') {
      editingTicketId = null;
      clearForm();
      document.getElementById('ticket-type').value = type;
      document.getElementById('detail-title').textContent = 'Nuevo Ticket';
      toggleBugFields(type === 'bug');
      detailPanel?.classList.add('open');
    }

    function showEditForm(ticketId) {
      const ticket = tickets.find(t => t.id === ticketId);
      if (!ticket) return;

      editingTicketId = ticketId;
      document.getElementById('detail-title').textContent = `Editar ${ticket.id}`;

      document.getElementById('ticket-title').value = ticket.title;
      document.getElementById('ticket-type').value = ticket.type;
      document.getElementById('ticket-status').value = ticket.status;
      document.getElementById('ticket-priority').value = ticket.priority;
      document.getElementById('ticket-assignee').value = ticket.assignee || '';
      document.getElementById('ticket-reporter').value = ticket.reporter || '';
      document.getElementById('ticket-due-date').value = ticket.dueDate || '';
      document.getElementById('ticket-description').value = ticket.description || '';
      document.getElementById('ticket-labels').value = ticket.labels?.join(', ') || '';
      document.getElementById('ticket-points').value = ticket.points || '';

      if (ticket.type === 'bug' && ticket.bugInfo) {
        document.getElementById('bug-steps').value = ticket.bugInfo.steps || '';
        document.getElementById('bug-expected').value = ticket.bugInfo.expected || '';
        document.getElementById('bug-actual').value = ticket.bugInfo.actual || '';
        document.getElementById('bug-environment').value = ticket.bugInfo.environment || '';
      }

      toggleBugFields(ticket.type === 'bug');
      renderComments(ticket.comments || []);
      detailPanel?.classList.add('open');
    }

    function clearForm() {
      document.getElementById('ticket-id').value = '';
      document.getElementById('ticket-title').value = '';
      document.getElementById('ticket-type').value = 'task';
      document.getElementById('ticket-status').value = 'open';
      document.getElementById('ticket-priority').value = 'medium';
      document.getElementById('ticket-assignee').value = '';
      document.getElementById('ticket-reporter').value = '';
      document.getElementById('ticket-due-date').value = '';
      document.getElementById('ticket-description').value = '';
      document.getElementById('ticket-labels').value = '';
      document.getElementById('ticket-points').value = '';
      document.getElementById('bug-steps').value = '';
      document.getElementById('bug-expected').value = '';
      document.getElementById('bug-actual').value = '';
      document.getElementById('bug-environment').value = '';
      document.getElementById('comments-list').innerHTML = '';
    }

    function toggleBugFields(show) {
      const bugFields = document.getElementById('bug-fields');
      if (bugFields) {
        bugFields.classList.toggle('hidden', !show);
      }
    }

    function saveTicket() {
      const title = document.getElementById('ticket-title')?.value.trim();
      if (!title) {
        alert('El t√≠tulo es requerido');
        return;
      }

      const ticketData = {
        title,
        type: document.getElementById('ticket-type')?.value || 'task',
        status: document.getElementById('ticket-status')?.value || 'open',
        priority: document.getElementById('ticket-priority')?.value || 'medium',
        assignee: document.getElementById('ticket-assignee')?.value.trim() || '',
        reporter: document.getElementById('ticket-reporter')?.value.trim() || '',
        dueDate: document.getElementById('ticket-due-date')?.value || '',
        description: document.getElementById('ticket-description')?.value.trim() || '',
        labels: document.getElementById('ticket-labels')?.value.split(',').map(l => l.trim()).filter(l => l) || [],
        points: document.getElementById('ticket-points')?.value || ''
      };

      if (ticketData.type === 'bug') {
        ticketData.bugInfo = {
          steps: document.getElementById('bug-steps')?.value || '',
          expected: document.getElementById('bug-expected')?.value || '',
          actual: document.getElementById('bug-actual')?.value || '',
          environment: document.getElementById('bug-environment')?.value || ''
        };
      }

      if (editingTicketId) {
        const index = tickets.findIndex(t => t.id === editingTicketId);
        if (index !== -1) {
          tickets[index] = { ...tickets[index], ...ticketData, updatedAt: new Date().toISOString() };
        }
      } else {
        ticketCounter++;
        const prefixes = { bug: 'BUG', feature: 'FEAT', task: 'TASK', improvement: 'IMP', epic: 'EPIC', spike: 'SPIKE' };
        const prefix = prefixes[ticketData.type] || 'TICKET';
        tickets.push({
          id: `${prefix}-${String(ticketCounter).padStart(4, '0')}`,
          ...ticketData,
          comments: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
      }

      closeDetailPanel();
      renderTickets();
      updateAssigneeFilter();
    }

    function closeDetailPanel() {
      detailPanel?.classList.remove('open');
      editingTicketId = null;
    }

    function deleteTicket(ticketId) {
      if (confirm('¬øEliminar este ticket?')) {
        tickets = tickets.filter(t => t.id !== ticketId);
        renderTickets();
      }
    }

    // Render Tickets
    function renderTickets() {
      const filteredTickets = getFilteredTickets();
      document.getElementById('ticket-count').textContent = `${filteredTickets.length} tickets`;

      renderListView(filteredTickets);
      renderBoardView(filteredTickets);
      renderTableView(filteredTickets);
    }

    function getFilteredTickets() {
      return tickets.filter(t => {
        if (filters.type !== 'all' && t.type !== filters.type) return false;
        if (filters.status !== 'all' && t.status !== filters.status) return false;
        if (filters.priority !== 'all' && t.priority !== filters.priority) return false;
        if (filters.assignee && filters.assignee !== 'unassigned' && t.assignee !== filters.assignee) return false;
        if (filters.assignee === 'unassigned' && t.assignee) return false;
        if (filters.search && !t.title.toLowerCase().includes(filters.search.toLowerCase())) return false;
        return true;
      });
    }

    function renderListView(filteredTickets) {
      if (!ticketsList) return;

      if (filteredTickets.length === 0) {
        ticketsList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-ticket-alt"></i>
            <h4>No hay tickets</h4>
            <p>Crea tu primer ticket o carga una plantilla</p>
          </div>
        `;
        return;
      }

      ticketsList.innerHTML = filteredTickets.map(ticket => `
        <div class="ticket-item" data-id="${ticket.id}">
          <div class="ticket-type-icon ${ticket.type}">
            <i class="fas fa-${getTypeIcon(ticket.type)}"></i>
          </div>
          <div class="ticket-content">
            <div class="ticket-header-row">
              <span class="ticket-id">${ticket.id}</span>
              <span class="ticket-title-text">${ticket.title}</span>
            </div>
            <div class="ticket-meta">
              <span class="status-badge ${ticket.status}">${formatStatus(ticket.status)}</span>
              <span class="priority-indicator">${getPriorityIcon(ticket.priority)}</span>
              ${ticket.assignee ? `<span class="ticket-assignee"><i class="fas fa-user"></i> ${ticket.assignee}</span>` : ''}
              ${ticket.labels?.length ? `<div class="ticket-labels">${ticket.labels.slice(0, 2).map(l => `<span class="label-tag">${l}</span>`).join('')}</div>` : ''}
            </div>
          </div>
        </div>
      `).join('');

      ticketsList.querySelectorAll('.ticket-item').forEach(item => {
        item.addEventListener('click', () => showEditForm(item.dataset.id));
      });
    }

    function renderBoardView(filteredTickets) {
      const columns = {
        open: document.getElementById('open-column'),
        'in-progress': document.getElementById('in-progress-column'),
        review: document.getElementById('review-column'),
        done: document.getElementById('done-column')
      };

      Object.values(columns).forEach(col => {
        if (col) col.innerHTML = '';
      });

      const counts = { open: 0, 'in-progress': 0, review: 0, done: 0 };

      filteredTickets.forEach(ticket => {
        const column = columns[ticket.status];
        if (column) {
          counts[ticket.status]++;
          const card = document.createElement('div');
          card.className = 'kanban-card';
          card.draggable = true;
          card.dataset.id = ticket.id;
          card.innerHTML = `
            <div class="kanban-card-header">
              <span class="ticket-type-icon ${ticket.type}" style="width:20px;height:20px;font-size:0.7rem;">
                <i class="fas fa-${getTypeIcon(ticket.type)}"></i>
              </span>
              <span class="ticket-id" style="font-size:0.7rem;">${ticket.id}</span>
            </div>
            <div class="kanban-card-title">${ticket.title}</div>
            <div class="kanban-card-meta">
              <span>${getPriorityIcon(ticket.priority)}</span>
              ${ticket.points ? `<span>${ticket.points} pts</span>` : ''}
            </div>
          `;
          column.appendChild(card);

          card.addEventListener('click', () => showEditForm(ticket.id));
          card.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', ticket.id);
            card.classList.add('dragging');
          });
          card.addEventListener('dragend', () => card.classList.remove('dragging'));
        }
      });

      document.getElementById('open-count').textContent = counts.open;
      document.getElementById('in-progress-count').textContent = counts['in-progress'];
      document.getElementById('review-count').textContent = counts.review;
      document.getElementById('done-count').textContent = counts.done;
    }

    function renderTableView(filteredTickets) {
      const tbody = document.getElementById('tickets-table-body');
      if (!tbody) return;

      tbody.innerHTML = filteredTickets.map(ticket => `
        <tr data-id="${ticket.id}" style="cursor:pointer;">
          <td><span class="ticket-id">${ticket.id}</span></td>
          <td><span class="ticket-type-icon ${ticket.type}" style="width:24px;height:24px;font-size:0.75rem;display:inline-flex;"><i class="fas fa-${getTypeIcon(ticket.type)}"></i></span></td>
          <td>${ticket.title}</td>
          <td><span class="status-badge ${ticket.status}">${formatStatus(ticket.status)}</span></td>
          <td>${getPriorityIcon(ticket.priority)} ${ticket.priority}</td>
          <td>${ticket.assignee || '-'}</td>
          <td>${new Date(ticket.createdAt).toLocaleDateString()}</td>
        </tr>
      `).join('');

      tbody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', () => showEditForm(row.dataset.id));
      });
    }

    function renderComments(comments) {
      const list = document.getElementById('comments-list');
      if (!list) return;

      list.innerHTML = comments.map(c => `
        <div class="comment-item">
          <div class="comment-header">
            <span class="comment-author">${c.author}</span>
            <span class="comment-date">${new Date(c.date).toLocaleString()}</span>
          </div>
          <div class="comment-text">${c.text}</div>
        </div>
      `).join('');
    }

    function addComment() {
      const textarea = document.getElementById('new-comment');
      const text = textarea?.value.trim();
      if (!text || !editingTicketId) return;

      const ticket = tickets.find(t => t.id === editingTicketId);
      if (ticket) {
        if (!ticket.comments) ticket.comments = [];
        ticket.comments.push({
          author: 'Usuario',
          text,
          date: new Date().toISOString()
        });
        renderComments(ticket.comments);
        textarea.value = '';
      }
    }

    // Helpers
    function getTypeIcon(type) {
      const icons = { bug: 'bug', feature: 'star', task: 'check-square', improvement: 'arrow-up', epic: 'bolt', spike: 'flask' };
      return icons[type] || 'ticket-alt';
    }

    function getPriorityIcon(priority) {
      const icons = { critical: 'üî¥', high: 'üü†', medium: 'üü°', low: 'üü¢' };
      return icons[priority] || '‚ö™';
    }

    function formatStatus(status) {
      const labels = { open: 'Open', 'in-progress': 'In Progress', review: 'In Review', done: 'Done', closed: 'Closed' };
      return labels[status] || status;
    }

    function updateAssigneeFilter() {
      const select = document.getElementById('assignee-filter');
      if (!select) return;

      const assignees = [...new Set(tickets.map(t => t.assignee).filter(a => a))];
      select.innerHTML = `
        <option value="">Todos</option>
        <option value="unassigned">Sin asignar</option>
        ${assignees.map(a => `<option value="${a}">${a}</option>`).join('')}
      `;
    }

    // Event Listeners
    document.getElementById('create-ticket-btn')?.addEventListener('click', () => showCreateForm());

    document.querySelectorAll('.type-card').forEach(card => {
      card.addEventListener('click', () => showCreateForm(card.dataset.type));
    });

    document.getElementById('close-detail')?.addEventListener('click', closeDetailPanel);
    document.getElementById('cancel-ticket')?.addEventListener('click', closeDetailPanel);
    document.getElementById('save-ticket')?.addEventListener('click', saveTicket);

    document.getElementById('ticket-type')?.addEventListener('change', (e) => {
      toggleBugFields(e.target.value === 'bug');
    });

    document.getElementById('add-comment-btn')?.addEventListener('click', addComment);

    // View toggle
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;

        document.querySelectorAll('.tickets-view').forEach(v => v.classList.remove('active'));
        document.getElementById(`tickets-${currentView}-view`)?.classList.add('active');
      });
    });

    // Filters
    document.querySelectorAll('#type-filters .filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('#type-filters .filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        filters.type = chip.dataset.filter;
        renderTickets();
      });
    });

    document.querySelectorAll('#status-filters .filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('#status-filters .filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        filters.status = chip.dataset.filter;
        renderTickets();
      });
    });

    document.querySelectorAll('#priority-filters .filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('#priority-filters .filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        filters.priority = chip.dataset.filter;
        renderTickets();
      });
    });

    document.getElementById('assignee-filter')?.addEventListener('change', (e) => {
      filters.assignee = e.target.value;
      renderTickets();
    });

    document.getElementById('ticket-search')?.addEventListener('input', (e) => {
      filters.search = e.target.value;
      renderTickets();
    });

    // Kanban drag and drop
    document.querySelectorAll('.kanban-column').forEach(column => {
      column.addEventListener('dragover', (e) => e.preventDefault());
      column.addEventListener('drop', (e) => {
        e.preventDefault();
        const ticketId = e.dataTransfer.getData('text/plain');
        const newStatus = column.dataset.status;
        const ticket = tickets.find(t => t.id === ticketId);
        if (ticket) {
          ticket.status = newStatus;
          ticket.updatedAt = new Date().toISOString();
          renderTickets();
        }
      });
    });

    // Templates
    document.querySelectorAll('.template-card').forEach(card => {
      card.addEventListener('click', () => {
        const templateName = card.dataset.template;
        const template = templates[templateName];
        if (!template) return;

        if (tickets.length > 0 && !confirm('Esto reemplazar√° los tickets actuales. ¬øContinuar?')) {
          return;
        }

        tickets = [];
        ticketCounter = 0;

        template.forEach(item => {
          ticketCounter++;
          const prefixes = { bug: 'BUG', feature: 'FEAT', task: 'TASK', improvement: 'IMP', epic: 'EPIC', spike: 'SPIKE' };
          const prefix = prefixes[item.type] || 'TICKET';
          tickets.push({
            id: `${prefix}-${String(ticketCounter).padStart(4, '0')}`,
            ...item,
            assignee: '',
            reporter: '',
            dueDate: '',
            description: '',
            comments: [],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
        });

        renderTickets();
        updateAssigneeFilter();
      });
    });

    // Export functions
    document.getElementById('export-jira-csv')?.addEventListener('click', () => {
      const headers = ['Issue Type', 'Summary', 'Priority', 'Status', 'Assignee', 'Reporter', 'Labels', 'Description'];
      const rows = tickets.map(t => [
        t.type.charAt(0).toUpperCase() + t.type.slice(1),
        t.title,
        t.priority.charAt(0).toUpperCase() + t.priority.slice(1),
        formatStatus(t.status),
        t.assignee || '',
        t.reporter || '',
        t.labels?.join(';') || '',
        t.description || ''
      ]);
      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      downloadFile(csv, 'jira-tickets.csv', 'text/csv');
    });

    document.getElementById('export-azure-csv')?.addEventListener('click', () => {
      const rows = tickets.map(t => ({
        'Work Item Type': t.type === 'bug' ? 'Bug' : t.type === 'feature' ? 'Feature' : 'Task',
        Title: t.title,
        State: t.status === 'done' ? 'Done' : t.status === 'in-progress' ? 'Active' : 'New',
        Priority: t.priority === 'critical' ? 1 : t.priority === 'high' ? 2 : t.priority === 'medium' ? 3 : 4,
        'Assigned To': t.assignee || '',
        Tags: t.labels?.join(';') || '',
        Description: t.description || ''
      }));
      const headers = Object.keys(rows[0] || {});
      const csv = [headers, ...rows.map(r => headers.map(h => `"${r[h]}"`))].map(row => row.join(',')).join('\n');
      downloadFile(csv, 'azure-devops-tickets.csv', 'text/csv');
    });

    document.getElementById('export-github-json')?.addEventListener('click', () => {
      const issues = tickets.map(t => ({
        title: t.title,
        body: t.description || '',
        labels: [...(t.labels || []), t.type, t.priority],
        assignees: t.assignee ? [t.assignee] : []
      }));
      downloadFile(JSON.stringify(issues, null, 2), 'github-issues.json', 'application/json');
    });

    document.getElementById('export-markdown')?.addEventListener('click', () => {
      let md = `# Tickets\n\n`;
      md += `| ID | Tipo | T√≠tulo | Estado | Prioridad | Asignado |\n`;
      md += `|----|------|--------|--------|-----------|----------|\n`;
      tickets.forEach(t => {
        md += `| ${t.id} | ${t.type} | ${t.title} | ${formatStatus(t.status)} | ${t.priority} | ${t.assignee || '-'} |\n`;
      });
      downloadFile(md, 'tickets.md', 'text/markdown');
    });

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Initialize
    renderTickets();
  });
</script>
